

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>TITLE HERE XXX &#8212; Topics in Quantitative Ecology and Beyond</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/Agricultural Intensity';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="Introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">Topics in Quantitative Ecology and Beyond</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Species%20Distribution%20Modelling%20with%20Python.html">Species Distribution Modelling with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20I%29.html">Ecological Data Science for Sustainable Agriculture (Part I)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20II%29.html">Ecological Data Science for Sustainable Agriculture (Part II)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20III%29.html">Ecological Data Science for Sustainable Agriculture (Part III)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20IV%29.html">Ecological Data Science for Sustainable Agriculture (Part IV)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hybrid%20Learning%20for%20Species%20Classification%20on%20Image%20Datasets.html">Hybrid Learning for Species Classification on Image Datasets</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/twhit1/quant_ecolo" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/docs/Agricultural Intensity.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>TITLE HERE XXX</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-do">To do</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#study-area">Study area</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data">Biodiversity data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#satellite-imagery-and-land-use-data">Satellite imagery and land-use data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-download">Data download</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#full-walkthrough-for-one-location">Full walkthrough for one location</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-masks">Apply masks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#phenology-parameter-calculations">Phenology parameter calculations</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bulk-process-satellite-imagery">Bulk process satellite imagery</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-between-biodiversity-and-aos">Correlation between biodiversity and AOS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="title-here-xxx">
<h1>TITLE HERE XXX<a class="headerlink" href="#title-here-xxx" title="Permalink to this heading">#</a></h1>
<section id="to-do">
<h2>To do<a class="headerlink" href="#to-do" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Clarify terminology on UK vs England</p></li>
<li><p>Terminology: phenology and productivity are not the same - I am using productivity here (but also caluclating phenology parameters)</p></li>
<li><p>On biodiversity metric calculations, think about whether I should include other covariates (e.g. land use at the pan-trap location) am I comparing like for like? I.e. what else might affect insect diversity (other than S2 phenology parameters on nearby spring cereal fields) and how to remove effect of that?</p></li>
<li><p>Present the methodology here after showing something that works as a hypothetical extension</p></li>
<li><p>Add a summary of this notebook to the RS for agriculture part I</p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>The land-sharing vs. land-sparing debate has received a lot of attention in recent years CITE. DEFINE.
<a class="reference external" href="https://www.cam.ac.uk/research/news/relocating-farmland-could-turn-back-clock-twenty-years-on-carbon-emissions">https://www.cam.ac.uk/research/news/relocating-farmland-could-turn-back-clock-twenty-years-on-carbon-emissions</a></p>
<p>Complex tradeoffs exist e.g. between food security, economics for agricultural businesses and communities, agricultural sustainability and nature impacts and dependencies.</p>
<p>Here weigh in on the LS/LS debate: “having volunteered with several agricutlural business focussing on low-input, extensive practices, I’ve seen first-hand the effects of …. ” but management decisions taken at an individual property level may not take account of larger scale patterns (for instance a farm in a prime-production region opting for extensive management, locally benefiting biodiversity but forfeiting productivity, resulting in supply leakage and land-conversion elsewhere which may offset local benefits); a policy that is coherent at a higher spatial-scale is needed to ensure a globally beneficial solution satisfing food production requirements, biodiversity goals and social economic factors.</p>
<p>Data-centric tools can be a key tool to aid in that decision-making processes. In particular, increasing availability of remote sensing data and biodiversity survey data. We can answer questions like where should we maximise food production, where should we prioritise rewilding efforts or soil health restoration - should we implement blanket policies (i.e. every farm should move towards regenerative methods), or opt for hetergenous strategies (fully rewild some areas, farm extensively in others and intensively in the rest). How do these decisions effect conservation and restoration efforts at a national and international scale, what are the social and economic implications for farming communities and society as a whole.</p>
<p>Here I investigate one facet of this complex question, making use of remote sensing, agricultural data and biodiversity surveys on the UK to look at the relationship between agricultural management, biodiversity and land-use patterns.</p>
<p>The UK is one of the most biodiversity depleted countries in the world CITE, with a significant portion of its surface dedicated to agriculture CITE, so this is a pertinent question to investigate. Furthermore there is significant appetite in the UK for changing agricultural practices CITE, and whilst the government has introduced policy in line with that trend CITE, key questions remain around the LS/LS debate.</p>
<p><strong>what does this notebook show - what are the results and conclusions? e.g. I found a correlation between x and y, and identified priority areas for changing ag strategies</strong></p>
<p><strong>Objectives</strong> </br>
a.
Can the approach presented in [1], which links remote sensing parameters with biodiversity survey data, be applied to UK Pollinator Monitoring Scheme (PMS) data? To this end, I replicate the methodolgy in [1] to generate remote sensing crop productivity parameters, compute similar biodiversity metrics on PMS data and test the correlation between the resulting datasets.</p>
<p>b.
Present an example of a large-spatial scale product that may be used to inform ag policy with biodiversity in mind (IYR). Look at IYR values on PMS data localities (potentially for this one look a PMS citizen science data instead of trap data). Identify areas for de-intensification of farming.:</p>
<p>Looking at the distribution of PMS sampling locations with reference to honeybee-specific pesticide input to crop yield ratios (IYR) [2] can any potential priority areas for de-intensification be identified.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vector processing</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">osgb</span>
<span class="kn">import</span> <span class="nn">pyproj</span>

<span class="c1"># Raster processing</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterio.features</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">measure</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rioxarray</span>

<span class="c1"># Visualisation</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">cx</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="o">%</span><span class="k">matplotlib</span> widget
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.formatter.limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">FIGSIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

<span class="c1"># Practical</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">shlex</span> <span class="kn">import</span> <span class="n">quote</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pystac_client</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">PyStackClient</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">DaskClient</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="nb">print</span> <span class="k">as</span> <span class="n">distributed_print</span>

<span class="c1"># Calcs and modelling</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../../git_packages/PhenoloPy/scripts&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">phenolopy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>

<span class="c1"># Settings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

<span class="n">WORKING_CRS</span> <span class="o">=</span> <span class="s1">&#39;EPSG:3035&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this heading">#</a></h2>
<section id="study-area">
<h3>Study area<a class="headerlink" href="#study-area" title="Permalink to this heading">#</a></h3>
<p>I’m carrying out this analysis on the UK. The UK is one of the most nature depleted countries in the world [3], reflected in very low values of measures of ecosystem intactness compared with other countries.</p>
<p>For instance, the UK’s mean Biodiversity Intactness Index (BII) [5] ranks amongst the lowest six countries globally for the period 1970 - 2014, corresponding to the lowest 3% of countries for which the index is computed. The BII was developed by the Natural History Museum, London (NHM), and estimates the percentage of original ecological communities remaining in a given area in light of human disturbance, by combining two models: one representing the influence of human activity on species abundance, and a second measuring compositional similarity (i.e. between an ecosystem at a given location and an undisturbed equivalent).</p>
<p>A more recently presented measure, the Ecosystem Integrity Index, developed by UNEP-WCMC [4] measures departure from natural ecosystem baselines as the minimum value of three components (ecosystem structure, composition and function). The maps presented in that preprint clearly show very low EII values for the UK and particularly for England.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in BII</span>
<span class="n">bii</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../../../data/NHM_BII/resource.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;area_code&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>
<span class="n">bii</span> <span class="o">=</span> <span class="n">bii</span><span class="p">[(</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bii&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;historical&#39;</span><span class="p">)]</span>

<span class="c1"># Area code map</span>
<span class="n">code_map_bii</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../../../data/NHM_BII/code_maps.json&#39;</span><span class="p">)[[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">]]</span>
<span class="n">code_map_bii</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_map_bii</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">area_codes_bii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code_map_bii</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">area_codes_bii</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">))</span>
<span class="n">bii</span> <span class="o">=</span> <span class="n">bii</span><span class="p">[</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;[A-Za-z]&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span> <span class="c1"># countries only</span>

<span class="c1"># Rank</span>
<span class="n">bii</span><span class="p">[</span><span class="s1">&#39;year_rank_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">bii</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">])[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="s1">&#39;dense&#39;</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">bii</span><span class="p">[</span><span class="s1">&#39;year_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bii</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">])[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="s1">&#39;dense&#39;</span><span class="p">)</span>

<span class="c1"># Result</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum BII ranking of the UK compared with other countries across period 1970 - 2014 (absolute rank and as rank percentile of all country measurements per year):&#39;</span><span class="p">)</span>
<span class="n">bii</span><span class="p">[</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;001-150-154-GBR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">)[[</span><span class="s1">&#39;year_rank&#39;</span><span class="p">,</span> <span class="s1">&#39;year_rank_pct&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Maximum BII ranking of the UK compared with other countries across period 1970 - 2014 (absolute rank and as rank percentile of all country measurements per year):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year_rank</th>
      <th>year_rank_pct</th>
    </tr>
    <tr>
      <th>area</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>United Kingdom of Great Britain and Northern Ireland</th>
      <td>6.0</td>
      <td>3.174603</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Land use in England is dominated by agriculture. According to the 2023 data from the “Structure of the agricultural industry in England and the UK at June” report compiled by DEFRA [6], 68% of England’s land is dedicated to agriculture (down from 74% in 1983), of which 39% is used to grow cereal crops (excluding maize) and 16% is temporary or permanent grassland.</p>
<p>At the same time, land use intensity has increased significantly since the 1960s with productivity gains driven by mechanisation and widespread availability of chemical inputs. For instance global inorganic nitrogen use in the agricultural industry have increased by an order of magnitude in the 60 years since FAO records began in 1961.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fert_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/Global_fertiliser_input/FAOSTAT_data_en_2-20-2024.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span>
<span class="n">fert_series</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)[[</span><span class="s1">&#39;Value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Global Nitrogen Input (Tonnes)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "679238db0f3845678effc8e79c1d7fc9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Nitrogen input level is considered a key indicator of land-use intensity [7], which in turn is a central driver of global biodiversity decline [1, 7 - 11] READ THESE AND CHECK RELEVANCE.</p>
<p>The ability to assess land-use intensity at scale, and implications for biodiversity, is therefore relevant to the decision-makers attempting to reconcile biodiversity strategies with social and economic constraints associated with the agricultural industry.</p>
</section>
<section id="biodiversity-data">
<h3>Biodiversity data<a class="headerlink" href="#biodiversity-data" title="Permalink to this heading">#</a></h3>
<p>Here I’m using data from the UK Pollinator Monitoring Scheme (PoMS) [12], which provides pan-trap records relating to systematic 1 km square surveys at 95 locations across the UK. The squares are visited four times per year for data collection. The UK PoMS is the only scheme in the world to conduct systematic pollinator survey data on pollinator species abundance at a national scale [13].</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../../../data/Agric_data/Pollinator/data/ukpoms_1kmpantrapdata_2017-2020_samples.csv&quot;</span><span class="p">)</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../../../data/Agric_data/Pollinator/data/ukpoms_1kmpantrapdata_2017-2020_insects.csv&quot;</span><span class="p">)</span>

<span class="c1"># X1km_square is the SW corner of the 1KM grid cell - so add 500m to centre the reference</span>
<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span>

<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">gridder</span><span class="o">.</span><span class="n">parse_grid</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">grid_to_ll</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">)</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">gridder</span><span class="o">.</span><span class="n">parse_grid</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">grid_to_ll</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">)</span>

<span class="c1"># Convert to datetime</span>
<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>


<span class="c1"># Count records</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">insect_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year
2017    2103
2018    3255
2019    4326
2020    1538
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>I select one year to proceed with to simplify the analysis - 2019 has the most records so we’ll go with that.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">insect_data</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2019&#39;</span><span class="p">)]</span>
<span class="n">sample_data</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2019&#39;</span><span class="p">)]</span>


<span class="c1"># Convert to an equal-area projection with units metres - so all the study areas have the same area</span>
<span class="n">insect_data</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sample_data</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Calulcate biodiversity metrics for each location, pooling over sampling rounds [1]:</p>
<ul class="simple">
<li><p>Species richness: the number of unique species observed  (note there may be different sampling rates at different locations, check this)</p></li>
<li><p>Species diversity (Shannon index): the number of unique species and their relative proportions</p></li>
<li><p>Total abundance: sum of all individuals from all species</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Insect tount cols</span>
<span class="n">count_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wasps_solitary&#39;</span><span class="p">,</span>
              <span class="s1">&#39;wasps_social&#39;</span><span class="p">,</span>
              <span class="s1">&#39;wasps_parasitic&#39;</span><span class="p">,</span>
              <span class="s1">&#39;sawflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;flies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;moths&#39;</span><span class="p">,</span>
              <span class="s1">&#39;butterflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;beetles_pollen&#39;</span><span class="p">,</span>
              <span class="s1">&#39;beetles_other&#39;</span><span class="p">,</span>
              <span class="s1">&#39;insects_small&#39;</span><span class="p">,</span>
              <span class="s1">&#39;insects_other&#39;</span><span class="p">,</span>
              <span class="s1">&#39;spiders&#39;</span><span class="p">,</span>
              <span class="s1">&#39;all_invertebrates_excluding_bees_hoverflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;bees&#39;</span><span class="p">,</span>
              <span class="s1">&#39;hoverflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;all_invertebrates_including_bees_hoverflies&#39;</span><span class="p">]</span>

<span class="c1"># Convert types</span>
<span class="n">sample_data</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;temperature_start&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;temperature_end&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;location_code&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span> <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">count_cols</span><span class="p">}})</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;location_code&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># There&#39;s probably a peak, but just take the mean of temp as a representative temperature</span>
<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;temperature_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;temperature_start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;temperature_end&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>

<span class="n">sample_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location_code&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">land_cover</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;land_cover&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">),</span>
                                                   <span class="n">temperature_mean</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;temperature_mean&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">),</span>
                                                   <span class="o">**</span><span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">count_cols</span><span class="p">}</span>
                                                   <span class="p">)</span>


<span class="c1"># Calculate total abundance using sample data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>land_cover</th>
      <th>temperature_mean</th>
      <th>wasps_solitary</th>
      <th>wasps_social</th>
      <th>wasps_parasitic</th>
      <th>sawflies</th>
      <th>flies</th>
      <th>moths</th>
      <th>butterflies</th>
      <th>beetles_pollen</th>
      <th>beetles_other</th>
      <th>insects_small</th>
      <th>insects_other</th>
      <th>spiders</th>
      <th>all_invertebrates_excluding_bees_hoverflies</th>
      <th>bees</th>
      <th>hoverflies</th>
      <th>all_invertebrates_including_bees_hoverflies</th>
    </tr>
    <tr>
      <th>location_code</th>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">1</th>
      <th>2019-05-14</th>
      <td>agricultural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>3</td>
      <td>168</td>
      <td>0</td>
      <td>0</td>
      <td>11</td>
      <td>6</td>
      <td>20</td>
      <td>0</td>
      <td>0</td>
      <td>217</td>
      <td>46</td>
      <td>0</td>
      <td>263</td>
    </tr>
    <tr>
      <th>2019-06-20</th>
      <td>agricultural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>1</td>
      <td>133</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>41</td>
      <td>0</td>
      <td>0</td>
      <td>188</td>
      <td>34</td>
      <td>6</td>
      <td>228</td>
    </tr>
    <tr>
      <th>2019-07-29</th>
      <td>agricultural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>22</td>
      <td>2</td>
      <td>2619</td>
      <td>2</td>
      <td>18</td>
      <td>0</td>
      <td>7</td>
      <td>73</td>
      <td>7</td>
      <td>0</td>
      <td>2750</td>
      <td>15</td>
      <td>33</td>
      <td>2798</td>
    </tr>
    <tr>
      <th>2019-08-24</th>
      <td>agricultural</td>
      <td>21.5</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>588</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>31</td>
      <td>5</td>
      <td>2</td>
      <td>636</td>
      <td>7</td>
      <td>18</td>
      <td>661</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2</th>
      <th>2019-05-17</th>
      <td>agricultural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>100</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>21</td>
      <td>1</td>
      <td>1</td>
      <td>133</td>
      <td>7</td>
      <td>0</td>
      <td>140</td>
    </tr>
    <tr>
      <th>2019-06-23</th>
      <td>agricultural</td>
      <td>16.7</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>0</td>
      <td>115</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>21</td>
      <td>0</td>
      <td>5</td>
      <td>150</td>
      <td>2</td>
      <td>0</td>
      <td>152</td>
    </tr>
    <tr>
      <th>2019-07-14</th>
      <td>agricultural</td>
      <td>17.4</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>275</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>290</td>
      <td>0</td>
      <td>4</td>
      <td>294</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">4</th>
      <th>2019-05-18</th>
      <td>agricultural</td>
      <td>15.0</td>
      <td>1</td>
      <td>0</td>
      <td>32</td>
      <td>1</td>
      <td>272</td>
      <td>0</td>
      <td>0</td>
      <td>43</td>
      <td>12</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>367</td>
      <td>33</td>
      <td>1</td>
      <td>401</td>
    </tr>
    <tr>
      <th>2019-06-23</th>
      <td>agricultural</td>
      <td>19.6</td>
      <td>2</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>298</td>
      <td>0</td>
      <td>0</td>
      <td>223</td>
      <td>15</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>562</td>
      <td>21</td>
      <td>5</td>
      <td>588</td>
    </tr>
    <tr>
      <th>2019-07-28</th>
      <td>agricultural</td>
      <td>17.8</td>
      <td>1</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>590</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>621</td>
      <td>33</td>
      <td>12</td>
      <td>666</td>
    </tr>
    <tr>
      <th>2019-08-26</th>
      <td>agricultural</td>
      <td>25.6</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>181</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>189</td>
      <td>6</td>
      <td>1</td>
      <td>196</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">5</th>
      <th>2019-05-15</th>
      <td>agricultural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>48</td>
      <td>0</td>
      <td>0</td>
      <td>49</td>
      <td>5</td>
      <td>18</td>
      <td>1</td>
      <td>0</td>
      <td>125</td>
      <td>3</td>
      <td>0</td>
      <td>128</td>
    </tr>
    <tr>
      <th>2019-06-29</th>
      <td>agricultural</td>
      <td>22.8</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>260</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>5</td>
      <td>28</td>
      <td>5</td>
      <td>0</td>
      <td>305</td>
      <td>5</td>
      <td>1</td>
      <td>311</td>
    </tr>
    <tr>
      <th>2019-07-31</th>
      <td>agricultural</td>
      <td>18.7</td>
      <td>9</td>
      <td>0</td>
      <td>22</td>
      <td>2</td>
      <td>861</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>5</td>
      <td>41</td>
      <td>4</td>
      <td>0</td>
      <td>946</td>
      <td>10</td>
      <td>4</td>
      <td>960</td>
    </tr>
    <tr>
      <th>2019-09-01</th>
      <td>agricultural</td>
      <td>14.2</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>265</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>270</td>
      <td>28</td>
      <td>16</td>
      <td>314</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">6</th>
      <th>2019-05-02</th>
      <td>agricultural</td>
      <td>14.2</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>208</td>
      <td>0</td>
      <td>0</td>
      <td>42</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>257</td>
      <td>54</td>
      <td>1</td>
      <td>312</td>
    </tr>
    <tr>
      <th>2019-06-14</th>
      <td>agricultural</td>
      <td>17.0</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>0</td>
      <td>198</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>17</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>231</td>
      <td>14</td>
      <td>2</td>
      <td>247</td>
    </tr>
    <tr>
      <th>2019-07-02</th>
      <td>agricultural</td>
      <td>19.3</td>
      <td>6</td>
      <td>0</td>
      <td>10</td>
      <td>2</td>
      <td>75</td>
      <td>0</td>
      <td>0</td>
      <td>39</td>
      <td>22</td>
      <td>21</td>
      <td>1</td>
      <td>0</td>
      <td>176</td>
      <td>53</td>
      <td>3</td>
      <td>232</td>
    </tr>
    <tr>
      <th>2019-08-22</th>
      <td>agricultural</td>
      <td>20.3</td>
      <td>8</td>
      <td>0</td>
      <td>14</td>
      <td>0</td>
      <td>187</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>3</td>
      <td>1</td>
      <td>222</td>
      <td>13</td>
      <td>10</td>
      <td>245</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">7</th>
      <th>2019-05-12</th>
      <td>agricultural</td>
      <td>14.1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>38</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>53</td>
      <td>5</td>
      <td>0</td>
      <td>58</td>
    </tr>
    <tr>
      <th>2019-06-02</th>
      <td>agricultural</td>
      <td>16.5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>47</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>55</td>
      <td>0</td>
      <td>0</td>
      <td>55</td>
    </tr>
    <tr>
      <th>2019-07-06</th>
      <td>agricultural</td>
      <td>17.5</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>9</td>
      <td>1</td>
      <td>0</td>
      <td>21</td>
      <td>0</td>
      <td>0</td>
      <td>21</td>
    </tr>
    <tr>
      <th>2019-08-31</th>
      <td>agricultural</td>
      <td>17.5</td>
      <td>3</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
      <td>629</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>3</td>
      <td>36</td>
      <td>1</td>
      <td>683</td>
      <td>12</td>
      <td>5</td>
      <td>700</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">10</th>
      <th>2019-05-30</th>
      <td>agricultural</td>
      <td>15.9</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>551</td>
      <td>3</td>
      <td>0</td>
      <td>3</td>
      <td>63</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>623</td>
      <td>18</td>
      <td>1</td>
      <td>642</td>
    </tr>
    <tr>
      <th>2019-07-03</th>
      <td>agricultural</td>
      <td>20.0</td>
      <td>2</td>
      <td>0</td>
      <td>12</td>
      <td>1</td>
      <td>312</td>
      <td>0</td>
      <td>0</td>
      <td>54</td>
      <td>10</td>
      <td>22</td>
      <td>4</td>
      <td>0</td>
      <td>417</td>
      <td>5</td>
      <td>2</td>
      <td>424</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">13</th>
      <th>2019-05-19</th>
      <td>agricultural</td>
      <td>18.2</td>
      <td>3</td>
      <td>0</td>
      <td>4</td>
      <td>4</td>
      <td>197</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>20</td>
      <td>32</td>
      <td>3</td>
      <td>0</td>
      <td>264</td>
      <td>26</td>
      <td>0</td>
      <td>290</td>
    </tr>
    <tr>
      <th>2019-06-30</th>
      <td>agricultural</td>
      <td>18.2</td>
      <td>2</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>163</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>12</td>
      <td>9</td>
      <td>0</td>
      <td>0</td>
      <td>198</td>
      <td>18</td>
      <td>1</td>
      <td>217</td>
    </tr>
    <tr>
      <th>2019-08-24</th>
      <td>agricultural</td>
      <td>21.4</td>
      <td>7</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>134</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
      <td>0</td>
      <td>151</td>
      <td>4</td>
      <td>3</td>
      <td>158</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">19</th>
      <th>2019-06-26</th>
      <td>agricultural</td>
      <td>18.8</td>
      <td>2</td>
      <td>0</td>
      <td>11</td>
      <td>0</td>
      <td>237</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>16</td>
      <td>20</td>
      <td>3</td>
      <td>0</td>
      <td>289</td>
      <td>10</td>
      <td>14</td>
      <td>313</td>
    </tr>
    <tr>
      <th>2019-08-08</th>
      <td>agricultural</td>
      <td>19.8</td>
      <td>1</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>325</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>83</td>
      <td>2</td>
      <td>0</td>
      <td>421</td>
      <td>11</td>
      <td>2</td>
      <td>434</td>
    </tr>
    <tr>
      <th>2019-08-28</th>
      <td>agricultural</td>
      <td>17.7</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>21</td>
      <td>0</td>
      <td>0</td>
      <td>21</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">22</th>
      <th>2019-05-20</th>
      <td>agricultural</td>
      <td>15.6</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>690</td>
      <td>1</td>
      <td>0</td>
      <td>12</td>
      <td>6</td>
      <td>36</td>
      <td>2</td>
      <td>0</td>
      <td>752</td>
      <td>4</td>
      <td>0</td>
      <td>756</td>
    </tr>
    <tr>
      <th>2019-06-21</th>
      <td>agricultural</td>
      <td>16.8</td>
      <td>0</td>
      <td>0</td>
      <td>14</td>
      <td>3</td>
      <td>356</td>
      <td>0</td>
      <td>2</td>
      <td>422</td>
      <td>19</td>
      <td>35</td>
      <td>1</td>
      <td>0</td>
      <td>852</td>
      <td>26</td>
      <td>3</td>
      <td>881</td>
    </tr>
    <tr>
      <th>2019-07-22</th>
      <td>agricultural</td>
      <td>24.5</td>
      <td>0</td>
      <td>0</td>
      <td>50</td>
      <td>0</td>
      <td>1000</td>
      <td>0</td>
      <td>3</td>
      <td>166</td>
      <td>21</td>
      <td>85</td>
      <td>7</td>
      <td>0</td>
      <td>1332</td>
      <td>20</td>
      <td>36</td>
      <td>1388</td>
    </tr>
    <tr>
      <th>2019-08-21</th>
      <td>agricultural</td>
      <td>19.5</td>
      <td>1</td>
      <td>0</td>
      <td>23</td>
      <td>1</td>
      <td>599</td>
      <td>0</td>
      <td>0</td>
      <td>22</td>
      <td>5</td>
      <td>1</td>
      <td>7</td>
      <td>0</td>
      <td>659</td>
      <td>27</td>
      <td>14</td>
      <td>700</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">25</th>
      <th>2019-05-13</th>
      <td>agricultural</td>
      <td>12.7</td>
      <td>0</td>
      <td>0</td>
      <td>15</td>
      <td>22</td>
      <td>572</td>
      <td>0</td>
      <td>0</td>
      <td>82</td>
      <td>9</td>
      <td>9</td>
      <td>2</td>
      <td>0</td>
      <td>711</td>
      <td>14</td>
      <td>0</td>
      <td>725</td>
    </tr>
    <tr>
      <th>2019-06-14</th>
      <td>agricultural</td>
      <td>14.5</td>
      <td>1</td>
      <td>0</td>
      <td>69</td>
      <td>1</td>
      <td>745</td>
      <td>0</td>
      <td>0</td>
      <td>13</td>
      <td>32</td>
      <td>7</td>
      <td>1</td>
      <td>0</td>
      <td>869</td>
      <td>33</td>
      <td>26</td>
      <td>928</td>
    </tr>
    <tr>
      <th>2019-07-16</th>
      <td>agricultural</td>
      <td>20.8</td>
      <td>3</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>508</td>
      <td>0</td>
      <td>1</td>
      <td>44</td>
      <td>45</td>
      <td>32</td>
      <td>5</td>
      <td>1</td>
      <td>647</td>
      <td>12</td>
      <td>6</td>
      <td>665</td>
    </tr>
    <tr>
      <th>2019-08-12</th>
      <td>agricultural</td>
      <td>19.2</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>409</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>2</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>426</td>
      <td>7</td>
      <td>10</td>
      <td>443</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">27</th>
      <th>2019-05-24</th>
      <td>agricultural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>225</td>
      <td>1</td>
      <td>0</td>
      <td>10</td>
      <td>2</td>
      <td>13</td>
      <td>0</td>
      <td>0</td>
      <td>254</td>
      <td>3</td>
      <td>0</td>
      <td>257</td>
    </tr>
    <tr>
      <th>2019-06-28</th>
      <td>agricultural</td>
      <td>19.5</td>
      <td>2</td>
      <td>0</td>
      <td>13</td>
      <td>1</td>
      <td>202</td>
      <td>0</td>
      <td>1</td>
      <td>280</td>
      <td>29</td>
      <td>14</td>
      <td>2</td>
      <td>1</td>
      <td>545</td>
      <td>19</td>
      <td>8</td>
      <td>572</td>
    </tr>
    <tr>
      <th>2019-07-17</th>
      <td>agricultural</td>
      <td>23.0</td>
      <td>1</td>
      <td>1</td>
      <td>7</td>
      <td>0</td>
      <td>467</td>
      <td>0</td>
      <td>1</td>
      <td>67</td>
      <td>16</td>
      <td>6</td>
      <td>8</td>
      <td>1</td>
      <td>575</td>
      <td>9</td>
      <td>8</td>
      <td>592</td>
    </tr>
    <tr>
      <th>2019-08-23</th>
      <td>agricultural</td>
      <td>21.0</td>
      <td>5</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>577</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>6</td>
      <td>2</td>
      <td>5</td>
      <td>0</td>
      <td>606</td>
      <td>7</td>
      <td>7</td>
      <td>620</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">28</th>
      <th>2019-05-16</th>
      <td>agricultural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>41</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>44</td>
      <td>5</td>
      <td>0</td>
      <td>49</td>
    </tr>
    <tr>
      <th>2019-07-16</th>
      <td>agricultural</td>
      <td>19.5</td>
      <td>1</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>167</td>
      <td>0</td>
      <td>11</td>
      <td>12</td>
      <td>25</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>226</td>
      <td>18</td>
      <td>1</td>
      <td>245</td>
    </tr>
    <tr>
      <th>2019-08-29</th>
      <td>agricultural</td>
      <td>17.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>208</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>213</td>
      <td>8</td>
      <td>15</td>
      <td>236</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">31</th>
      <th>2019-05-27</th>
      <td>semi-natural</td>
      <td>19.2</td>
      <td>0</td>
      <td>0</td>
      <td>15</td>
      <td>4</td>
      <td>251</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>7</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>284</td>
      <td>8</td>
      <td>0</td>
      <td>292</td>
    </tr>
    <tr>
      <th>2019-07-01</th>
      <td>semi-natural</td>
      <td>15.5</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>84</td>
      <td>0</td>
      <td>2</td>
      <td>20</td>
      <td>5</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>119</td>
      <td>1</td>
      <td>40</td>
      <td>160</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>semi-natural</td>
      <td>23.0</td>
      <td>3</td>
      <td>0</td>
      <td>7</td>
      <td>0</td>
      <td>158</td>
      <td>0</td>
      <td>6</td>
      <td>10</td>
      <td>10</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>197</td>
      <td>12</td>
      <td>23</td>
      <td>232</td>
    </tr>
    <tr>
      <th>2019-09-03</th>
      <td>semi-natural</td>
      <td>16.0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>123</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>127</td>
      <td>1</td>
      <td>21</td>
      <td>149</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">32</th>
      <th>2019-06-27</th>
      <td>semi-natural</td>
      <td>21.3</td>
      <td>0</td>
      <td>0</td>
      <td>33</td>
      <td>0</td>
      <td>1573</td>
      <td>1</td>
      <td>0</td>
      <td>18</td>
      <td>15</td>
      <td>5</td>
      <td>0</td>
      <td>1</td>
      <td>1646</td>
      <td>6</td>
      <td>2</td>
      <td>1654</td>
    </tr>
    <tr>
      <th>2019-07-29</th>
      <td>semi-natural</td>
      <td>19.7</td>
      <td>0</td>
      <td>0</td>
      <td>21</td>
      <td>1</td>
      <td>730</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>755</td>
      <td>4</td>
      <td>24</td>
      <td>783</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">34</th>
      <th>2019-05-15</th>
      <td>semi-natural</td>
      <td>20.9</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>1</td>
      <td>105</td>
      <td>0</td>
      <td>0</td>
      <td>12</td>
      <td>7</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>136</td>
      <td>7</td>
      <td>1</td>
      <td>144</td>
    </tr>
    <tr>
      <th>2019-06-18</th>
      <td>semi-natural</td>
      <td>17.7</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>224</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>234</td>
      <td>31</td>
      <td>3</td>
      <td>268</td>
    </tr>
    <tr>
      <th>2019-07-08</th>
      <td>semi-natural</td>
      <td>19.1</td>
      <td>1</td>
      <td>0</td>
      <td>15</td>
      <td>0</td>
      <td>199</td>
      <td>13</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>232</td>
      <td>6</td>
      <td>2</td>
      <td>240</td>
    </tr>
    <tr>
      <th>2019-09-07</th>
      <td>semi-natural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>17</td>
      <td>0</td>
      <td>183</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>203</td>
      <td>14</td>
      <td>29</td>
      <td>246</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">36</th>
      <th>2019-05-28</th>
      <td>agricultural</td>
      <td>14.1</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>243</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>11</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>262</td>
      <td>15</td>
      <td>9</td>
      <td>286</td>
    </tr>
    <tr>
      <th>2019-06-19</th>
      <td>agricultural</td>
      <td>18.0</td>
      <td>0</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>139</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>52</td>
      <td>0</td>
      <td>0</td>
      <td>215</td>
      <td>18</td>
      <td>6</td>
      <td>239</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>agricultural</td>
      <td>24.8</td>
      <td>0</td>
      <td>0</td>
      <td>23</td>
      <td>1</td>
      <td>242</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>44</td>
      <td>8</td>
      <td>0</td>
      <td>320</td>
      <td>4</td>
      <td>5</td>
      <td>329</td>
    </tr>
    <tr>
      <th>2019-08-28</th>
      <td>agricultural</td>
      <td>18.3</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>109</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>114</td>
      <td>6</td>
      <td>32</td>
      <td>152</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">39</th>
      <th>2019-06-18</th>
      <td>agricultural</td>
      <td>14.1</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>2</td>
      <td>86</td>
      <td>2</td>
      <td>0</td>
      <td>131</td>
      <td>4</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>235</td>
      <td>10</td>
      <td>12</td>
      <td>257</td>
    </tr>
    <tr>
      <th>2019-07-25</th>
      <td>agricultural</td>
      <td>22.3</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>92</td>
      <td>0</td>
      <td>0</td>
      <td>139</td>
      <td>6</td>
      <td>3</td>
      <td>9</td>
      <td>1</td>
      <td>254</td>
      <td>1</td>
      <td>1</td>
      <td>256</td>
    </tr>
    <tr>
      <th>2019-08-17</th>
      <td>agricultural</td>
      <td>17.3</td>
      <td>0</td>
      <td>1</td>
      <td>7</td>
      <td>0</td>
      <td>355</td>
      <td>2</td>
      <td>2</td>
      <td>58</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>431</td>
      <td>21</td>
      <td>110</td>
      <td>562</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">42</th>
      <th>2019-06-27</th>
      <td>semi-natural</td>
      <td>21.0</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>65</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>4</td>
      <td>3</td>
      <td>0</td>
      <td>81</td>
      <td>2</td>
      <td>0</td>
      <td>83</td>
    </tr>
    <tr>
      <th>2019-06-28</th>
      <td>semi-natural</td>
      <td>21.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>16</td>
      <td>0</td>
      <td>0</td>
      <td>16</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>semi-natural</td>
      <td>22.5</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>1</td>
      <td>589</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>598</td>
      <td>1</td>
      <td>0</td>
      <td>599</td>
    </tr>
    <tr>
      <th>2019-08-25</th>
      <td>semi-natural</td>
      <td>23.0</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>361</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>369</td>
      <td>2</td>
      <td>0</td>
      <td>371</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">44</th>
      <th>2019-06-29</th>
      <td>semi-natural</td>
      <td>18.0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>192</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>198</td>
      <td>0</td>
      <td>7</td>
      <td>205</td>
    </tr>
    <tr>
      <th>2019-07-20</th>
      <td>semi-natural</td>
      <td>15.8</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>2</td>
      <td>199</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>213</td>
      <td>1</td>
      <td>3</td>
      <td>217</td>
    </tr>
    <tr>
      <th>2019-09-08</th>
      <td>semi-natural</td>
      <td>13.5</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>221</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>225</td>
      <td>0</td>
      <td>13</td>
      <td>238</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">47</th>
      <th>2019-05-19</th>
      <td>semi-natural</td>
      <td>12.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>49</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>57</td>
      <td>0</td>
      <td>3</td>
      <td>60</td>
    </tr>
    <tr>
      <th>2019-07-06</th>
      <td>semi-natural</td>
      <td>11.5</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>122</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>137</td>
      <td>0</td>
      <td>3</td>
      <td>140</td>
    </tr>
    <tr>
      <th>2019-07-28</th>
      <td>semi-natural</td>
      <td>21.8</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>64</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>5</td>
      <td>5</td>
      <td>82</td>
      <td>0</td>
      <td>1</td>
      <td>83</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">51</th>
      <th>2019-06-22</th>
      <td>semi-natural</td>
      <td>15.3</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>173</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>179</td>
      <td>2</td>
      <td>20</td>
      <td>201</td>
    </tr>
    <tr>
      <th>2019-07-26</th>
      <td>semi-natural</td>
      <td>22.5</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>265</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>276</td>
      <td>1</td>
      <td>1</td>
      <td>278</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">54</th>
      <th>2019-06-10</th>
      <td>semi-natural</td>
      <td>13.7</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>217</td>
      <td>0</td>
      <td>1</td>
      <td>25</td>
      <td>5</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>254</td>
      <td>6</td>
      <td>15</td>
      <td>275</td>
    </tr>
    <tr>
      <th>2019-07-06</th>
      <td>semi-natural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>217</td>
      <td>0</td>
      <td>0</td>
      <td>14</td>
      <td>2</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>239</td>
      <td>2</td>
      <td>4</td>
      <td>245</td>
    </tr>
    <tr>
      <th>2019-08-31</th>
      <td>semi-natural</td>
      <td>14.8</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>233</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>233</td>
      <td>8</td>
      <td>14</td>
      <td>255</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">59</th>
      <th>2019-05-23</th>
      <td>agricultural</td>
      <td>15.1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>99</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>7</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>110</td>
      <td>21</td>
      <td>0</td>
      <td>131</td>
    </tr>
    <tr>
      <th>2019-06-15</th>
      <td>agricultural</td>
      <td>15.0</td>
      <td>1</td>
      <td>0</td>
      <td>9</td>
      <td>2</td>
      <td>238</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>257</td>
      <td>14</td>
      <td>0</td>
      <td>271</td>
    </tr>
    <tr>
      <th>2019-07-03</th>
      <td>agricultural</td>
      <td>17.3</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>143</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>152</td>
      <td>2</td>
      <td>1</td>
      <td>155</td>
    </tr>
    <tr>
      <th>2019-08-04</th>
      <td>agricultural</td>
      <td>20.0</td>
      <td>0</td>
      <td>0</td>
      <td>17</td>
      <td>1</td>
      <td>327</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>0</td>
      <td>358</td>
      <td>3</td>
      <td>12</td>
      <td>373</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">63</th>
      <th>2019-05-22</th>
      <td>agricultural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>49</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>50</td>
      <td>2</td>
      <td>1</td>
      <td>53</td>
    </tr>
    <tr>
      <th>2019-06-26</th>
      <td>agricultural</td>
      <td>20.0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>49</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>56</td>
      <td>1</td>
      <td>0</td>
      <td>57</td>
    </tr>
    <tr>
      <th>2019-08-01</th>
      <td>agricultural</td>
      <td>18.3</td>
      <td>1</td>
      <td>0</td>
      <td>7</td>
      <td>0</td>
      <td>367</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>380</td>
      <td>6</td>
      <td>1</td>
      <td>387</td>
    </tr>
    <tr>
      <th>2019-09-05</th>
      <td>agricultural</td>
      <td>15.0</td>
      <td>1</td>
      <td>0</td>
      <td>34</td>
      <td>0</td>
      <td>721</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>10</td>
      <td>2</td>
      <td>0</td>
      <td>769</td>
      <td>13</td>
      <td>43</td>
      <td>825</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">64</th>
      <th>2019-05-28</th>
      <td>agricultural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>86</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>9</td>
      <td>9</td>
      <td>2</td>
      <td>0</td>
      <td>111</td>
      <td>26</td>
      <td>0</td>
      <td>137</td>
    </tr>
    <tr>
      <th>2019-06-26</th>
      <td>agricultural</td>
      <td>15.5</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>2</td>
      <td>246</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>260</td>
      <td>2</td>
      <td>9</td>
      <td>271</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>agricultural</td>
      <td>24.9</td>
      <td>3</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>539</td>
      <td>0</td>
      <td>7</td>
      <td>1</td>
      <td>1</td>
      <td>7</td>
      <td>2</td>
      <td>0</td>
      <td>564</td>
      <td>7</td>
      <td>13</td>
      <td>584</td>
    </tr>
    <tr>
      <th>2019-09-02</th>
      <td>agricultural</td>
      <td>15.4</td>
      <td>4</td>
      <td>0</td>
      <td>6</td>
      <td>2</td>
      <td>442</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>462</td>
      <td>15</td>
      <td>49</td>
      <td>526</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">65</th>
      <th>2019-05-24</th>
      <td>agricultural</td>
      <td>22.3</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
      <td>71</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>93</td>
      <td>3</td>
      <td>0</td>
      <td>96</td>
    </tr>
    <tr>
      <th>2019-06-26</th>
      <td>agricultural</td>
      <td>17.5</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>204</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>12</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>231</td>
      <td>6</td>
      <td>5</td>
      <td>242</td>
    </tr>
    <tr>
      <th>2019-07-29</th>
      <td>agricultural</td>
      <td>23.1</td>
      <td>1</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>321</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>4</td>
      <td>66</td>
      <td>2</td>
      <td>0</td>
      <td>401</td>
      <td>4</td>
      <td>1</td>
      <td>406</td>
    </tr>
    <tr>
      <th>2019-09-14</th>
      <td>agricultural</td>
      <td>17.8</td>
      <td>1</td>
      <td>1</td>
      <td>13</td>
      <td>1</td>
      <td>492</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>517</td>
      <td>11</td>
      <td>117</td>
      <td>645</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">66</th>
      <th>2019-05-24</th>
      <td>agricultural</td>
      <td>14.6</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>116</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>126</td>
      <td>1</td>
      <td>0</td>
      <td>127</td>
    </tr>
    <tr>
      <th>2019-06-16</th>
      <td>agricultural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>314</td>
      <td>1</td>
      <td>0</td>
      <td>5</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>327</td>
      <td>9</td>
      <td>2</td>
      <td>338</td>
    </tr>
    <tr>
      <th>2019-07-05</th>
      <td>agricultural</td>
      <td>18.2</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>0</td>
      <td>348</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>2</td>
      <td>0</td>
      <td>368</td>
      <td>9</td>
      <td>2</td>
      <td>379</td>
    </tr>
    <tr>
      <th>2019-08-05</th>
      <td>agricultural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>741</td>
      <td>1</td>
      <td>6</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>757</td>
      <td>20</td>
      <td>38</td>
      <td>815</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">67</th>
      <th>2019-05-25</th>
      <td>agricultural</td>
      <td>18.9</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>42</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>50</td>
      <td>1</td>
      <td>0</td>
      <td>51</td>
    </tr>
    <tr>
      <th>2019-06-20</th>
      <td>agricultural</td>
      <td>17.8</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>236</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>256</td>
      <td>10</td>
      <td>0</td>
      <td>266</td>
    </tr>
    <tr>
      <th>2019-08-01</th>
      <td>agricultural</td>
      <td>20.8</td>
      <td>0</td>
      <td>1</td>
      <td>17</td>
      <td>1</td>
      <td>1428</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>1454</td>
      <td>8</td>
      <td>33</td>
      <td>1495</td>
    </tr>
    <tr>
      <th>2019-09-10</th>
      <td>agricultural</td>
      <td>17.9</td>
      <td>0</td>
      <td>0</td>
      <td>11</td>
      <td>0</td>
      <td>531</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>548</td>
      <td>5</td>
      <td>38</td>
      <td>591</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">71</th>
      <th>2019-05-22</th>
      <td>semi-natural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>15</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>19</td>
      <td>6</td>
      <td>0</td>
      <td>25</td>
    </tr>
    <tr>
      <th>2019-06-20</th>
      <td>semi-natural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>100</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>114</td>
      <td>13</td>
      <td>0</td>
      <td>127</td>
    </tr>
    <tr>
      <th>2019-07-28</th>
      <td>semi-natural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>130</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>133</td>
      <td>1</td>
      <td>3</td>
      <td>137</td>
    </tr>
    <tr>
      <th>2019-09-08</th>
      <td>semi-natural</td>
      <td>13.9</td>
      <td>4</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>368</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>391</td>
      <td>27</td>
      <td>27</td>
      <td>445</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">73</th>
      <th>2019-05-23</th>
      <td>semi-natural</td>
      <td>16.5</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>38</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>51</td>
      <td>0</td>
      <td>0</td>
      <td>51</td>
    </tr>
    <tr>
      <th>2019-06-27</th>
      <td>semi-natural</td>
      <td>20.0</td>
      <td>0</td>
      <td>0</td>
      <td>30</td>
      <td>2</td>
      <td>71</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>0</td>
      <td>112</td>
      <td>6</td>
      <td>3</td>
      <td>121</td>
    </tr>
    <tr>
      <th>2019-08-02</th>
      <td>semi-natural</td>
      <td>20.5</td>
      <td>0</td>
      <td>0</td>
      <td>36</td>
      <td>0</td>
      <td>435</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>13</td>
      <td>2</td>
      <td>0</td>
      <td>486</td>
      <td>6</td>
      <td>3</td>
      <td>495</td>
    </tr>
    <tr>
      <th>2019-09-14</th>
      <td>semi-natural</td>
      <td>14.6</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>70</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>73</td>
      <td>1</td>
      <td>5</td>
      <td>79</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">74</th>
      <th>2019-06-05</th>
      <td>semi-natural</td>
      <td>11.1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>32</td>
      <td>10</td>
      <td>1</td>
      <td>43</td>
    </tr>
    <tr>
      <th>2019-06-27</th>
      <td>semi-natural</td>
      <td>18.9</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>123</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>2</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>136</td>
      <td>32</td>
      <td>69</td>
      <td>237</td>
    </tr>
    <tr>
      <th>2019-07-24</th>
      <td>semi-natural</td>
      <td>19.9</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>632</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>645</td>
      <td>2</td>
      <td>43</td>
      <td>690</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">75</th>
      <th>2019-06-03</th>
      <td>semi-natural</td>
      <td>16.9</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>98</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>18</td>
      <td>3</td>
      <td>1</td>
      <td>2</td>
      <td>127</td>
      <td>8</td>
      <td>0</td>
      <td>135</td>
    </tr>
    <tr>
      <th>2019-06-28</th>
      <td>semi-natural</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>354</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>10</td>
      <td>3</td>
      <td>0</td>
      <td>389</td>
      <td>0</td>
      <td>0</td>
      <td>389</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>semi-natural</td>
      <td>26.6</td>
      <td>0</td>
      <td>0</td>
      <td>12</td>
      <td>0</td>
      <td>129</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
      <td>0</td>
      <td>152</td>
      <td>0</td>
      <td>0</td>
      <td>152</td>
    </tr>
    <tr>
      <th>2019-09-13</th>
      <td>semi-natural</td>
      <td>18.8</td>
      <td>1</td>
      <td>0</td>
      <td>19</td>
      <td>3</td>
      <td>579</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>1</td>
      <td>612</td>
      <td>12</td>
      <td>6</td>
      <td>630</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">76</th>
      <th>2019-06-11</th>
      <td>agricultural</td>
      <td>15.1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>176</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>9</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>201</td>
      <td>15</td>
      <td>0</td>
      <td>216</td>
    </tr>
    <tr>
      <th>2019-07-04</th>
      <td>agricultural</td>
      <td>20.3</td>
      <td>3</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>264</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>12</td>
      <td>12</td>
      <td>2</td>
      <td>1</td>
      <td>304</td>
      <td>17</td>
      <td>0</td>
      <td>321</td>
    </tr>
    <tr>
      <th>2019-08-20</th>
      <td>agricultural</td>
      <td>18.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>144</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>151</td>
      <td>5</td>
      <td>1</td>
      <td>157</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">79</th>
      <th>2019-06-18</th>
      <td>agricultural</td>
      <td>20.5</td>
      <td>1</td>
      <td>0</td>
      <td>14</td>
      <td>1</td>
      <td>342</td>
      <td>1</td>
      <td>0</td>
      <td>34</td>
      <td>22</td>
      <td>33</td>
      <td>5</td>
      <td>0</td>
      <td>453</td>
      <td>1</td>
      <td>1</td>
      <td>455</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>agricultural</td>
      <td>27.2</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>411</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>7</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>435</td>
      <td>2</td>
      <td>1</td>
      <td>438</td>
    </tr>
    <tr>
      <th>2019-09-03</th>
      <td>agricultural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>1</td>
      <td>505</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>520</td>
      <td>0</td>
      <td>16</td>
      <td>536</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">86</th>
      <th>2019-06-10</th>
      <td>semi-natural</td>
      <td>12.5</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>89</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>99</td>
      <td>6</td>
      <td>2</td>
      <td>107</td>
    </tr>
    <tr>
      <th>2019-07-15</th>
      <td>semi-natural</td>
      <td>16.7</td>
      <td>3</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
      <td>167</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>188</td>
      <td>2</td>
      <td>4</td>
      <td>194</td>
    </tr>
    <tr>
      <th>2019-08-21</th>
      <td>semi-natural</td>
      <td>13.7</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>1</td>
      <td>128</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>137</td>
      <td>2</td>
      <td>5</td>
      <td>144</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">87</th>
      <th>2019-05-20</th>
      <td>agricultural</td>
      <td>15.5</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>5</td>
      <td>259</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>7</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>289</td>
      <td>12</td>
      <td>4</td>
      <td>305</td>
    </tr>
    <tr>
      <th>2019-06-21</th>
      <td>agricultural</td>
      <td>16.5</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>69</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>75</td>
      <td>16</td>
      <td>0</td>
      <td>91</td>
    </tr>
    <tr>
      <th>2019-07-26</th>
      <td>agricultural</td>
      <td>20.5</td>
      <td>1</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>665</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>6</td>
      <td>1</td>
      <td>684</td>
      <td>5</td>
      <td>3</td>
      <td>692</td>
    </tr>
    <tr>
      <th>2019-08-23</th>
      <td>agricultural</td>
      <td>18.0</td>
      <td>2</td>
      <td>0</td>
      <td>18</td>
      <td>2</td>
      <td>2184</td>
      <td>1</td>
      <td>10</td>
      <td>3</td>
      <td>4</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>2226</td>
      <td>19</td>
      <td>36</td>
      <td>2281</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">89</th>
      <th>2019-06-21</th>
      <td>semi-natural</td>
      <td>19.3</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>68</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>76</td>
      <td>11</td>
      <td>0</td>
      <td>87</td>
    </tr>
    <tr>
      <th>2019-07-12</th>
      <td>semi-natural</td>
      <td>19.4</td>
      <td>0</td>
      <td>1</td>
      <td>17</td>
      <td>0</td>
      <td>608</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>628</td>
      <td>3</td>
      <td>4</td>
      <td>635</td>
    </tr>
    <tr>
      <th>2019-09-11</th>
      <td>semi-natural</td>
      <td>17.7</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>329</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>335</td>
      <td>2</td>
      <td>18</td>
      <td>355</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">91</th>
      <th>2019-05-14</th>
      <td>agricultural</td>
      <td>18.6</td>
      <td>0</td>
      <td>0</td>
      <td>14</td>
      <td>3</td>
      <td>538</td>
      <td>0</td>
      <td>1</td>
      <td>32</td>
      <td>18</td>
      <td>11</td>
      <td>0</td>
      <td>1</td>
      <td>618</td>
      <td>8</td>
      <td>0</td>
      <td>626</td>
    </tr>
    <tr>
      <th>2019-06-22</th>
      <td>agricultural</td>
      <td>19.5</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>377</td>
      <td>0</td>
      <td>0</td>
      <td>71</td>
      <td>51</td>
      <td>30</td>
      <td>0</td>
      <td>2</td>
      <td>533</td>
      <td>14</td>
      <td>1</td>
      <td>548</td>
    </tr>
    <tr>
      <th>2019-07-29</th>
      <td>agricultural</td>
      <td>22.0</td>
      <td>4</td>
      <td>0</td>
      <td>11</td>
      <td>4</td>
      <td>1304</td>
      <td>0</td>
      <td>6</td>
      <td>66</td>
      <td>3</td>
      <td>4</td>
      <td>8</td>
      <td>0</td>
      <td>1410</td>
      <td>19</td>
      <td>149</td>
      <td>1578</td>
    </tr>
    <tr>
      <th>2019-08-20</th>
      <td>agricultural</td>
      <td>23.8</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>167</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>182</td>
      <td>0</td>
      <td>3</td>
      <td>185</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">94</th>
      <th>2019-05-16</th>
      <td>agricultural</td>
      <td>18.2</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>118</td>
      <td>0</td>
      <td>1</td>
      <td>7</td>
      <td>1</td>
      <td>0</td>
      <td>12</td>
      <td>6</td>
      <td>150</td>
      <td>5</td>
      <td>0</td>
      <td>155</td>
    </tr>
    <tr>
      <th>2019-07-04</th>
      <td>agricultural</td>
      <td>23.2</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>417</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>426</td>
      <td>6</td>
      <td>1</td>
      <td>433</td>
    </tr>
    <tr>
      <th>2019-08-08</th>
      <td>agricultural</td>
      <td>21.7</td>
      <td>2</td>
      <td>0</td>
      <td>51</td>
      <td>2</td>
      <td>729</td>
      <td>0</td>
      <td>3</td>
      <td>4</td>
      <td>1</td>
      <td>16</td>
      <td>0</td>
      <td>1</td>
      <td>809</td>
      <td>4</td>
      <td>2</td>
      <td>815</td>
    </tr>
    <tr>
      <th>2019-09-14</th>
      <td>agricultural</td>
      <td>17.7</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>141</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>144</td>
      <td>6</td>
      <td>20</td>
      <td>170</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">96</th>
      <th>2019-05-31</th>
      <td>agricultural</td>
      <td>16.4</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>64</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>11</td>
      <td>0</td>
      <td>1</td>
      <td>83</td>
      <td>6</td>
      <td>0</td>
      <td>89</td>
    </tr>
    <tr>
      <th>2019-06-29</th>
      <td>agricultural</td>
      <td>25.5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>317</td>
      <td>1</td>
      <td>0</td>
      <td>1325</td>
      <td>13</td>
      <td>10</td>
      <td>3</td>
      <td>0</td>
      <td>1671</td>
      <td>5</td>
      <td>0</td>
      <td>1676</td>
    </tr>
    <tr>
      <th>2019-07-27</th>
      <td>agricultural</td>
      <td>18.4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>404</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>412</td>
      <td>17</td>
      <td>1</td>
      <td>430</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">100</th>
      <th>2019-07-01</th>
      <td>agricultural</td>
      <td>18.1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>118</td>
      <td>0</td>
      <td>0</td>
      <td>31</td>
      <td>7</td>
      <td>12</td>
      <td>1</td>
      <td>0</td>
      <td>171</td>
      <td>13</td>
      <td>3</td>
      <td>187</td>
    </tr>
    <tr>
      <th>2019-07-31</th>
      <td>agricultural</td>
      <td>18.5</td>
      <td>1</td>
      <td>0</td>
      <td>10</td>
      <td>1</td>
      <td>617</td>
      <td>0</td>
      <td>1</td>
      <td>29</td>
      <td>0</td>
      <td>2</td>
      <td>3</td>
      <td>0</td>
      <td>664</td>
      <td>53</td>
      <td>0</td>
      <td>717</td>
    </tr>
    <tr>
      <th>2019-08-23</th>
      <td>agricultural</td>
      <td>20.0</td>
      <td>10</td>
      <td>0</td>
      <td>8</td>
      <td>1</td>
      <td>628</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>657</td>
      <td>31</td>
      <td>9</td>
      <td>697</td>
    </tr>
    <tr>
      <th>106</th>
      <th>2019-07-05</th>
      <td>semi-natural</td>
      <td>17.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>322</td>
      <td>0</td>
      <td>0</td>
      <td>29</td>
      <td>0</td>
      <td>5</td>
      <td>2</td>
      <td>1</td>
      <td>360</td>
      <td>4</td>
      <td>3</td>
      <td>367</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">108</th>
      <th>2019-05-23</th>
      <td>semi-natural</td>
      <td>16.7</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>33</td>
      <td>0</td>
      <td>0</td>
      <td>78</td>
      <td>51</td>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>171</td>
      <td>17</td>
      <td>1</td>
      <td>189</td>
    </tr>
    <tr>
      <th>2019-06-27</th>
      <td>semi-natural</td>
      <td>19.5</td>
      <td>1</td>
      <td>0</td>
      <td>7</td>
      <td>1</td>
      <td>34</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>8</td>
      <td>8</td>
      <td>0</td>
      <td>0</td>
      <td>68</td>
      <td>2</td>
      <td>15</td>
      <td>85</td>
    </tr>
    <tr>
      <th>2019-07-22</th>
      <td>semi-natural</td>
      <td>23.0</td>
      <td>21</td>
      <td>2</td>
      <td>6</td>
      <td>0</td>
      <td>76</td>
      <td>0</td>
      <td>7</td>
      <td>8</td>
      <td>8</td>
      <td>10</td>
      <td>2</td>
      <td>0</td>
      <td>140</td>
      <td>21</td>
      <td>26</td>
      <td>187</td>
    </tr>
    <tr>
      <th>2019-08-13</th>
      <td>semi-natural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>79</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>96</td>
      <td>11</td>
      <td>18</td>
      <td>125</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">110</th>
      <th>2019-05-26</th>
      <td>semi-natural</td>
      <td>13.0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>39</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>46</td>
      <td>0</td>
      <td>0</td>
      <td>46</td>
    </tr>
    <tr>
      <th>2019-07-06</th>
      <td>semi-natural</td>
      <td>20.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>57</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>70</td>
      <td>1</td>
      <td>2</td>
      <td>73</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">111</th>
      <th>2019-06-25</th>
      <td>agricultural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>276</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>279</td>
      <td>3</td>
      <td>1</td>
      <td>283</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>agricultural</td>
      <td>22.5</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>8</td>
      <td>190</td>
      <td>0</td>
      <td>0</td>
      <td>17</td>
      <td>1</td>
      <td>15</td>
      <td>4</td>
      <td>0</td>
      <td>240</td>
      <td>2</td>
      <td>8</td>
      <td>250</td>
    </tr>
    <tr>
      <th>2019-09-14</th>
      <td>agricultural</td>
      <td>14.1</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>62</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>73</td>
      <td>0</td>
      <td>19</td>
      <td>92</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">112</th>
      <th>2019-06-19</th>
      <td>agricultural</td>
      <td>16.2</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>144</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>151</td>
      <td>1</td>
      <td>7</td>
      <td>159</td>
    </tr>
    <tr>
      <th>2019-07-29</th>
      <td>agricultural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>740</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>744</td>
      <td>3</td>
      <td>15</td>
      <td>762</td>
    </tr>
    <tr>
      <th>2019-08-24</th>
      <td>agricultural</td>
      <td>21.1</td>
      <td>0</td>
      <td>0</td>
      <td>15</td>
      <td>1</td>
      <td>162</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>180</td>
      <td>3</td>
      <td>29</td>
      <td>212</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">118</th>
      <th>2019-06-10</th>
      <td>agricultural</td>
      <td>14.8</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>350</td>
      <td>0</td>
      <td>0</td>
      <td>42</td>
      <td>42</td>
      <td>17</td>
      <td>1</td>
      <td>2</td>
      <td>459</td>
      <td>8</td>
      <td>1</td>
      <td>468</td>
    </tr>
    <tr>
      <th>2019-06-28</th>
      <td>agricultural</td>
      <td>19.5</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>443</td>
      <td>1</td>
      <td>0</td>
      <td>12</td>
      <td>8</td>
      <td>95</td>
      <td>3</td>
      <td>0</td>
      <td>566</td>
      <td>2</td>
      <td>0</td>
      <td>568</td>
    </tr>
    <tr>
      <th>2019-07-30</th>
      <td>agricultural</td>
      <td>15.9</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>593</td>
      <td>0</td>
      <td>0</td>
      <td>224</td>
      <td>3</td>
      <td>101</td>
      <td>0</td>
      <td>0</td>
      <td>926</td>
      <td>7</td>
      <td>6</td>
      <td>939</td>
    </tr>
    <tr>
      <th>2019-08-25</th>
      <td>agricultural</td>
      <td>22.2</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>3</td>
      <td>365</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>1</td>
      <td>43</td>
      <td>0</td>
      <td>1</td>
      <td>428</td>
      <td>6</td>
      <td>1</td>
      <td>435</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">121</th>
      <th>2019-06-07</th>
      <td>semi-natural</td>
      <td>15.4</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>317</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>21</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>346</td>
      <td>10</td>
      <td>4</td>
      <td>360</td>
    </tr>
    <tr>
      <th>2019-07-13</th>
      <td>semi-natural</td>
      <td>18.8</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>2</td>
      <td>336</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>346</td>
      <td>2</td>
      <td>0</td>
      <td>348</td>
    </tr>
    <tr>
      <th>2019-08-26</th>
      <td>semi-natural</td>
      <td>17.9</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>109</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>115</td>
      <td>4</td>
      <td>2</td>
      <td>121</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">122</th>
      <th>2019-06-30</th>
      <td>semi-natural</td>
      <td>15.8</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>142</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>143</td>
      <td>0</td>
      <td>8</td>
      <td>151</td>
    </tr>
    <tr>
      <th>2019-07-27</th>
      <td>semi-natural</td>
      <td>17.3</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>36</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>39</td>
      <td>0</td>
      <td>0</td>
      <td>39</td>
    </tr>
    <tr>
      <th>2019-08-27</th>
      <td>semi-natural</td>
      <td>16.4</td>
      <td>0</td>
      <td>0</td>
      <td>12</td>
      <td>0</td>
      <td>348</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>1</td>
      <td>367</td>
      <td>1</td>
      <td>0</td>
      <td>368</td>
    </tr>
    <tr>
      <th>125</th>
      <th>2019-07-07</th>
      <td>semi-natural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>54</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>54</td>
      <td>0</td>
      <td>0</td>
      <td>54</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">128</th>
      <th>2019-07-03</th>
      <td>semi-natural</td>
      <td>13.5</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>204</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>211</td>
      <td>0</td>
      <td>16</td>
      <td>227</td>
    </tr>
    <tr>
      <th>2019-07-19</th>
      <td>semi-natural</td>
      <td>16.5</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>2</td>
      <td>445</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>460</td>
      <td>0</td>
      <td>38</td>
      <td>498</td>
    </tr>
    <tr>
      <th>2019-08-15</th>
      <td>semi-natural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>199</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>205</td>
      <td>1</td>
      <td>18</td>
      <td>224</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">131</th>
      <th>2019-05-21</th>
      <td>agricultural</td>
      <td>15.5</td>
      <td>3</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>129</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>6</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>151</td>
      <td>24</td>
      <td>1</td>
      <td>176</td>
    </tr>
    <tr>
      <th>2019-06-14</th>
      <td>agricultural</td>
      <td>14.7</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>5</td>
      <td>463</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>483</td>
      <td>6</td>
      <td>5</td>
      <td>494</td>
    </tr>
    <tr>
      <th>2019-07-04</th>
      <td>agricultural</td>
      <td>19.8</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>548</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>5</td>
      <td>3</td>
      <td>0</td>
      <td>563</td>
      <td>11</td>
      <td>2</td>
      <td>576</td>
    </tr>
    <tr>
      <th>2019-08-03</th>
      <td>agricultural</td>
      <td>21.7</td>
      <td>1</td>
      <td>1</td>
      <td>5</td>
      <td>0</td>
      <td>375</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>3</td>
      <td>36</td>
      <td>3</td>
      <td>0</td>
      <td>429</td>
      <td>24</td>
      <td>33</td>
      <td>486</td>
    </tr>
    <tr>
      <th>138</th>
      <th>2019-05-23</th>
      <td>agricultural</td>
      <td>17.1</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>95</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>17</td>
      <td>40</td>
      <td>5</td>
      <td>28</td>
      <td>193</td>
      <td>3</td>
      <td>1</td>
      <td>197</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">145</th>
      <th>2019-06-06</th>
      <td>semi-natural</td>
      <td>15.7</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>477</td>
      <td>1</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>491</td>
      <td>35</td>
      <td>15</td>
      <td>541</td>
    </tr>
    <tr>
      <th>2019-06-29</th>
      <td>semi-natural</td>
      <td>20.8</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>204</td>
      <td>0</td>
      <td>0</td>
      <td>49</td>
      <td>1</td>
      <td>188</td>
      <td>2</td>
      <td>0</td>
      <td>447</td>
      <td>5</td>
      <td>6</td>
      <td>458</td>
    </tr>
    <tr>
      <th>2019-07-27</th>
      <td>semi-natural</td>
      <td>18.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>254</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>42</td>
      <td>1</td>
      <td>0</td>
      <td>301</td>
      <td>0</td>
      <td>5</td>
      <td>306</td>
    </tr>
    <tr>
      <th>2019-08-26</th>
      <td>semi-natural</td>
      <td>24.4</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>623</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>631</td>
      <td>13</td>
      <td>16</td>
      <td>660</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">146</th>
      <th>2019-05-18</th>
      <td>semi-natural</td>
      <td>13.4</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>52</td>
      <td>0</td>
      <td>0</td>
      <td>13</td>
      <td>0</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>74</td>
      <td>4</td>
      <td>4</td>
      <td>82</td>
    </tr>
    <tr>
      <th>2019-06-19</th>
      <td>semi-natural</td>
      <td>18.5</td>
      <td>1</td>
      <td>0</td>
      <td>6</td>
      <td>1</td>
      <td>305</td>
      <td>0</td>
      <td>0</td>
      <td>12</td>
      <td>5</td>
      <td>12</td>
      <td>2</td>
      <td>0</td>
      <td>344</td>
      <td>37</td>
      <td>13</td>
      <td>394</td>
    </tr>
    <tr>
      <th>2019-07-21</th>
      <td>semi-natural</td>
      <td>18.0</td>
      <td>3</td>
      <td>0</td>
      <td>17</td>
      <td>0</td>
      <td>890</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>7</td>
      <td>212</td>
      <td>8</td>
      <td>0</td>
      <td>1138</td>
      <td>27</td>
      <td>22</td>
      <td>1187</td>
    </tr>
    <tr>
      <th>2019-08-30</th>
      <td>semi-natural</td>
      <td>18.4</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>377</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>383</td>
      <td>16</td>
      <td>16</td>
      <td>415</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">149</th>
      <th>2019-05-24</th>
      <td>semi-natural</td>
      <td>16.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>64</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>68</td>
      <td>3</td>
      <td>2</td>
      <td>73</td>
    </tr>
    <tr>
      <th>2019-05-25</th>
      <td>semi-natural</td>
      <td>16.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>11</td>
      <td>1</td>
      <td>0</td>
      <td>12</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>semi-natural</td>
      <td>22.0</td>
      <td>0</td>
      <td>0</td>
      <td>54</td>
      <td>1</td>
      <td>1115</td>
      <td>1</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>8</td>
      <td>3</td>
      <td>3</td>
      <td>1192</td>
      <td>3</td>
      <td>14</td>
      <td>1209</td>
    </tr>
    <tr>
      <th>2019-08-15</th>
      <td>semi-natural</td>
      <td>17.5</td>
      <td>0</td>
      <td>0</td>
      <td>25</td>
      <td>1</td>
      <td>726</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>757</td>
      <td>6</td>
      <td>6</td>
      <td>769</td>
    </tr>
    <tr>
      <th>2019-09-01</th>
      <td>semi-natural</td>
      <td>16.0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>255</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>260</td>
      <td>5</td>
      <td>12</td>
      <td>277</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">157</th>
      <th>2019-06-12</th>
      <td>semi-natural</td>
      <td>11.1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>25</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>25</td>
      <td>0</td>
      <td>0</td>
      <td>25</td>
    </tr>
    <tr>
      <th>2019-08-02</th>
      <td>semi-natural</td>
      <td>19.5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2630</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2630</td>
      <td>1</td>
      <td>10</td>
      <td>2641</td>
    </tr>
    <tr>
      <th>2019-08-27</th>
      <td>semi-natural</td>
      <td>15.0</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>137</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>145</td>
      <td>0</td>
      <td>2</td>
      <td>147</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">160</th>
      <th>2019-05-19</th>
      <td>semi-natural</td>
      <td>14.0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>78</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>84</td>
      <td>0</td>
      <td>0</td>
      <td>84</td>
    </tr>
    <tr>
      <th>2019-07-06</th>
      <td>semi-natural</td>
      <td>11.5</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>437</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
      <td>447</td>
      <td>0</td>
      <td>0</td>
      <td>447</td>
    </tr>
    <tr>
      <th>2019-07-28</th>
      <td>semi-natural</td>
      <td>22.8</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>366</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>375</td>
      <td>0</td>
      <td>5</td>
      <td>380</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">161</th>
      <th>2019-06-27</th>
      <td>semi-natural</td>
      <td>15.5</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>80</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>14</td>
      <td>0</td>
      <td>0</td>
      <td>97</td>
      <td>3</td>
      <td>0</td>
      <td>100</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>semi-natural</td>
      <td>23.5</td>
      <td>0</td>
      <td>0</td>
      <td>11</td>
      <td>0</td>
      <td>437</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>14</td>
      <td>9</td>
      <td>1</td>
      <td>473</td>
      <td>0</td>
      <td>0</td>
      <td>473</td>
    </tr>
    <tr>
      <th>2019-08-24</th>
      <td>semi-natural</td>
      <td>18.0</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>60</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>12</td>
      <td>0</td>
      <td>78</td>
      <td>1</td>
      <td>1</td>
      <td>80</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">162</th>
      <th>2019-07-14</th>
      <td>semi-natural</td>
      <td>17.3</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>65</td>
      <td>0</td>
      <td>2</td>
      <td>9</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>88</td>
      <td>2</td>
      <td>2</td>
      <td>92</td>
    </tr>
    <tr>
      <th>2019-08-13</th>
      <td>semi-natural</td>
      <td>15.5</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>132</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>2</td>
      <td>142</td>
      <td>7</td>
      <td>5</td>
      <td>154</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">163</th>
      <th>2019-06-15</th>
      <td>semi-natural</td>
      <td>12.7</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>162</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>177</td>
      <td>3</td>
      <td>2</td>
      <td>182</td>
    </tr>
    <tr>
      <th>2019-07-23</th>
      <td>semi-natural</td>
      <td>19.5</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>3</td>
      <td>184</td>
      <td>0</td>
      <td>0</td>
      <td>28</td>
      <td>2</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>230</td>
      <td>2</td>
      <td>9</td>
      <td>241</td>
    </tr>
    <tr>
      <th>2019-08-20</th>
      <td>semi-natural</td>
      <td>13.9</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>727</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>737</td>
      <td>8</td>
      <td>9</td>
      <td>754</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">166</th>
      <th>2019-06-11</th>
      <td>semi-natural</td>
      <td>13.9</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>69</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>73</td>
      <td>0</td>
      <td>0</td>
      <td>73</td>
    </tr>
    <tr>
      <th>2019-07-29</th>
      <td>semi-natural</td>
      <td>17.1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1542</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1543</td>
      <td>0</td>
      <td>0</td>
      <td>1543</td>
    </tr>
    <tr>
      <th>2019-08-26</th>
      <td>semi-natural</td>
      <td>18.5</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>190</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>194</td>
      <td>1</td>
      <td>4</td>
      <td>199</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">172</th>
      <th>2019-05-17</th>
      <td>agricultural</td>
      <td>12.5</td>
      <td>0</td>
      <td>0</td>
      <td>45</td>
      <td>0</td>
      <td>29</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>79</td>
      <td>3</td>
      <td>0</td>
      <td>82</td>
    </tr>
    <tr>
      <th>2019-06-21</th>
      <td>agricultural</td>
      <td>17.7</td>
      <td>0</td>
      <td>0</td>
      <td>24</td>
      <td>1</td>
      <td>117</td>
      <td>0</td>
      <td>0</td>
      <td>5310</td>
      <td>15</td>
      <td>7</td>
      <td>0</td>
      <td>0</td>
      <td>5474</td>
      <td>28</td>
      <td>2</td>
      <td>5504</td>
    </tr>
    <tr>
      <th>2019-07-26</th>
      <td>agricultural</td>
      <td>24.5</td>
      <td>0</td>
      <td>0</td>
      <td>24</td>
      <td>1</td>
      <td>712</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>4</td>
      <td>43</td>
      <td>2</td>
      <td>1</td>
      <td>797</td>
      <td>27</td>
      <td>8</td>
      <td>832</td>
    </tr>
    <tr>
      <th>2019-08-30</th>
      <td>agricultural</td>
      <td>19.4</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>6</td>
      <td>391</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>403</td>
      <td>23</td>
      <td>8</td>
      <td>434</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">173</th>
      <th>2019-07-24</th>
      <td>agricultural</td>
      <td>17.8</td>
      <td>4</td>
      <td>0</td>
      <td>42</td>
      <td>3</td>
      <td>157</td>
      <td>0</td>
      <td>2</td>
      <td>13</td>
      <td>16</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>240</td>
      <td>7</td>
      <td>16</td>
      <td>263</td>
    </tr>
    <tr>
      <th>2019-08-27</th>
      <td>agricultural</td>
      <td>20.0</td>
      <td>2</td>
      <td>0</td>
      <td>13</td>
      <td>1</td>
      <td>73</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>97</td>
      <td>0</td>
      <td>8</td>
      <td>105</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">174</th>
      <th>2019-06-25</th>
      <td>agricultural</td>
      <td>18.0</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>46</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>67</td>
      <td>2</td>
      <td>0</td>
      <td>69</td>
    </tr>
    <tr>
      <th>2019-08-07</th>
      <td>agricultural</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>320</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>328</td>
      <td>5</td>
      <td>2</td>
      <td>335</td>
    </tr>
    <tr>
      <th>2019-08-29</th>
      <td>agricultural</td>
      <td>18.5</td>
      <td>0</td>
      <td>0</td>
      <td>22</td>
      <td>0</td>
      <td>622</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>1</td>
      <td>650</td>
      <td>12</td>
      <td>13</td>
      <td>675</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">176</th>
      <th>2019-05-22</th>
      <td>agricultural</td>
      <td>17.5</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>17</td>
      <td>329</td>
      <td>3</td>
      <td>0</td>
      <td>45</td>
      <td>6</td>
      <td>51</td>
      <td>0</td>
      <td>0</td>
      <td>460</td>
      <td>5</td>
      <td>0</td>
      <td>465</td>
    </tr>
    <tr>
      <th>2019-06-28</th>
      <td>agricultural</td>
      <td>25.6</td>
      <td>0</td>
      <td>0</td>
      <td>64</td>
      <td>0</td>
      <td>309</td>
      <td>0</td>
      <td>7</td>
      <td>14</td>
      <td>48</td>
      <td>36</td>
      <td>1</td>
      <td>0</td>
      <td>479</td>
      <td>13</td>
      <td>5</td>
      <td>497</td>
    </tr>
    <tr>
      <th>2019-07-29</th>
      <td>agricultural</td>
      <td>24.5</td>
      <td>2</td>
      <td>0</td>
      <td>55</td>
      <td>1</td>
      <td>413</td>
      <td>1</td>
      <td>27</td>
      <td>478</td>
      <td>10</td>
      <td>9</td>
      <td>0</td>
      <td>1</td>
      <td>997</td>
      <td>30</td>
      <td>2</td>
      <td>1029</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">177</th>
      <th>2019-05-27</th>
      <td>agricultural</td>
      <td>18.6</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>466</td>
      <td>2</td>
      <td>0</td>
      <td>30</td>
      <td>0</td>
      <td>16</td>
      <td>0</td>
      <td>0</td>
      <td>519</td>
      <td>7</td>
      <td>0</td>
      <td>526</td>
    </tr>
    <tr>
      <th>2019-06-20</th>
      <td>agricultural</td>
      <td>21.6</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>557</td>
      <td>0</td>
      <td>0</td>
      <td>100</td>
      <td>49</td>
      <td>2</td>
      <td>10</td>
      <td>2</td>
      <td>728</td>
      <td>6</td>
      <td>15</td>
      <td>749</td>
    </tr>
    <tr>
      <th>2019-07-11</th>
      <td>agricultural</td>
      <td>24.8</td>
      <td>1</td>
      <td>0</td>
      <td>7</td>
      <td>0</td>
      <td>216</td>
      <td>1</td>
      <td>0</td>
      <td>31</td>
      <td>455</td>
      <td>87</td>
      <td>8</td>
      <td>3</td>
      <td>809</td>
      <td>2</td>
      <td>1</td>
      <td>812</td>
    </tr>
    <tr>
      <th>2019-08-19</th>
      <td>agricultural</td>
      <td>21.6</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>15</td>
      <td>481</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>502</td>
      <td>11</td>
      <td>1</td>
      <td>514</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">180</th>
      <th>2019-04-30</th>
      <td>agricultural</td>
      <td>13.8</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>0</td>
      <td>484</td>
      <td>0</td>
      <td>1</td>
      <td>38</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>567</td>
      <td>21</td>
      <td>0</td>
      <td>588</td>
    </tr>
    <tr>
      <th>2019-07-07</th>
      <td>agricultural</td>
      <td>22.8</td>
      <td>0</td>
      <td>0</td>
      <td>25</td>
      <td>0</td>
      <td>196</td>
      <td>0</td>
      <td>10</td>
      <td>999</td>
      <td>6</td>
      <td>15</td>
      <td>2</td>
      <td>0</td>
      <td>1253</td>
      <td>15</td>
      <td>6</td>
      <td>1274</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">182</th>
      <th>2019-06-21</th>
      <td>agricultural</td>
      <td>17.5</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>3</td>
      <td>396</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>58</td>
      <td>10</td>
      <td>3</td>
      <td>0</td>
      <td>485</td>
      <td>11</td>
      <td>0</td>
      <td>496</td>
    </tr>
    <tr>
      <th>2019-07-15</th>
      <td>agricultural</td>
      <td>18.0</td>
      <td>1</td>
      <td>0</td>
      <td>16</td>
      <td>1</td>
      <td>290</td>
      <td>1</td>
      <td>5</td>
      <td>0</td>
      <td>21</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>337</td>
      <td>34</td>
      <td>5</td>
      <td>376</td>
    </tr>
    <tr>
      <th>2019-08-13</th>
      <td>agricultural</td>
      <td>17.5</td>
      <td>5</td>
      <td>0</td>
      <td>17</td>
      <td>4</td>
      <td>977</td>
      <td>1</td>
      <td>3</td>
      <td>4</td>
      <td>11</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1025</td>
      <td>44</td>
      <td>8</td>
      <td>1077</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">183</th>
      <th>2019-05-13</th>
      <td>agricultural</td>
      <td>14.6</td>
      <td>0</td>
      <td>0</td>
      <td>11</td>
      <td>9</td>
      <td>227</td>
      <td>0</td>
      <td>2</td>
      <td>122</td>
      <td>12</td>
      <td>39</td>
      <td>1</td>
      <td>0</td>
      <td>423</td>
      <td>22</td>
      <td>0</td>
      <td>445</td>
    </tr>
    <tr>
      <th>2019-06-27</th>
      <td>agricultural</td>
      <td>18.6</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
      <td>3</td>
      <td>659</td>
      <td>0</td>
      <td>0</td>
      <td>29</td>
      <td>16</td>
      <td>27</td>
      <td>0</td>
      <td>1</td>
      <td>742</td>
      <td>13</td>
      <td>2</td>
      <td>757</td>
    </tr>
    <tr>
      <th>2019-07-11</th>
      <td>agricultural</td>
      <td>18.1</td>
      <td>1</td>
      <td>2</td>
      <td>4</td>
      <td>0</td>
      <td>852</td>
      <td>1</td>
      <td>2</td>
      <td>30</td>
      <td>3</td>
      <td>8</td>
      <td>0</td>
      <td>0</td>
      <td>903</td>
      <td>14</td>
      <td>8</td>
      <td>925</td>
    </tr>
    <tr>
      <th>2019-08-23</th>
      <td>agricultural</td>
      <td>19.1</td>
      <td>14</td>
      <td>1</td>
      <td>4</td>
      <td>4</td>
      <td>2704</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>6</td>
      <td>0</td>
      <td>11</td>
      <td>3</td>
      <td>2753</td>
      <td>16</td>
      <td>9</td>
      <td>2778</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">shannon</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
    <span class="n">shannon</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">shannon</span>


<span class="c1"># Calculate hoverfly and bee abundance using occurrence data, as well as other biodiversity indices</span>
<span class="k">def</span> <span class="nf">bee_hoverfly_metrics</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
    <span class="n">abundance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="n">species_richness</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;taxon_aggregated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="c1"># Note the PoMS suggests use of taxon_aggregated for analysis, see documentation for explanation</span>
    <span class="n">species_diversity</span> <span class="o">=</span> <span class="n">shannon</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;taxon_aggregated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># Shannon</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;abundance&#39;</span><span class="p">:</span> <span class="n">abundance</span><span class="p">,</span> <span class="s1">&#39;species_richness&#39;</span><span class="p">:</span> <span class="n">species_richness</span><span class="p">,</span> <span class="s1">&#39;species_diversity&#39;</span><span class="p">:</span> <span class="n">species_diversity</span><span class="p">})</span>


<span class="n">bee_hoverfly_biodiversity</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location_code&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">bee_hoverfly_metrics</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For the purposes of estimating agricultural intensity in the vicinity of each sampling location, I consider a circle of radius 5 km centred on the sampling location.</p>
<p>This represents a divergence from the methodology described in [1], where only the fields surveyed were selected for imagery analysis. As the S2 method is described for spring-sown cereals and there can be significant differences in vegetation indexes for different species CITE, and furthermore there is no guarantee that the PoMS survey locations are on spring-sown cereal fields, it is not possible to exactly replicate the methodology here.</p>
<p>Instead I look at the S2 imagery on grassland and cropland (specifically spring-sown cereals) in the vicinitiy of the PoMS sampling location to estimate the local land-use intensity proxy. To this end, I define a circle of radius two kilometres around the PoMS sampling location and calculation S2 indices on these areas.</p>
<p>Note that honey bees regularly travel this distance to forage, and have been witnessed more than 10 km from the hive [14], so defining a study zone around each sampling location in this way is not only practical within the constraints of the methodology here but also likely largely overlaps with areas frequented by the insects observed in the pan-traps.</p>
</section>
<section id="satellite-imagery-and-land-use-data">
<h3>Satellite imagery and land-use data<a class="headerlink" href="#satellite-imagery-and-land-use-data" title="Permalink to this heading">#</a></h3>
<section id="data-download">
<h4>Data download<a class="headerlink" href="#data-download" title="Permalink to this heading">#</a></h4>
<p>Starting by identifying each PoMS location and define a corresponding bounding box to send with requests for data. Also define a lookup dictionary that holds information about each study area’s geometry referenced by the PoMS location code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">2e3</span><span class="p">)</span>
<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">location_geom_lookup</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="c1"># point at centre of study zone</span>
                                                                                                     <span class="s1">&#39;study_zone&#39;</span><span class="p">,</span> <span class="c1"># circular zone around that point to be used for computation</span>
                                                                                                     <span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">,</span> <span class="c1"># bbox around that circular zone to be used for data download</span>
                                                                                                    <span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now define a few helper functions to create download directories and handle requests to online data stores. Note that CROME data doesn’t have an easy-access API yet so the download parameters are send to a bash script that sends a request to <a class="reference external" href="https://environment.data.gov.uk/explore/b498a2be-f3de-49fb-91a4-3381bb3868c2">https://environment.data.gov.uk/explore/b498a2be-f3de-49fb-91a4-3381bb3868c2</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_zone_dir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Builds local directory structure to download data into.&#39;&#39;&#39;</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="s1">&#39;../../../data/Agric_data/Locations/&#39;</span>
    <span class="n">to_make</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">to_make</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">to_make</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">to_make</span><span class="p">)</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="s1">&#39;Created data dir at &#39;</span> <span class="o">+</span> <span class="n">to_make</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_make</span>

<span class="k">def</span> <span class="nf">read_S3</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Actually downloads the data and metadata corresponding to an S2 acquisition, based on a reference and spatial filter.&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">href</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Note that src crs may be different from the working crs in this notebook or lat/lon so transform to it!</span>
        <span class="n">transform_geodetic_to_s2</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">src_bbox</span> <span class="o">=</span> <span class="n">transform_geodetic_to_s2</span><span class="p">(</span><span class="o">*</span><span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">src_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                              <span class="nb">min</span><span class="p">(</span><span class="n">src_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                                              <span class="nb">max</span><span class="p">(</span><span class="n">src_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                                              <span class="nb">max</span><span class="p">(</span><span class="n">src_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                              <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span><span class="o">.</span><span class="n">round_lengths</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> 
        <span class="n">src_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
        
        <span class="n">src_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                            <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src_profile</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">pass_clouds</span><span class="p">(</span><span class="n">thematic_data</span><span class="p">,</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Filters acquisitions based on the area proportion of the image which is cloudy (according to the S2 cloud detection algorithm).&#39;&#39;&#39;</span>
    <span class="n">medium_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thematic_data</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">high_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thematic_data</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">medium_cloud_prob</span> <span class="o">+</span> <span class="n">high_cloud_prob</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">thematic_data</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">max_cloud_perc</span>

<span class="k">def</span> <span class="nf">clean_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Clears up directories if download is re-run.&#39;&#39;&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Cleaning (removing) </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Create a client and AWS session to download data, and for each location in the PoMS data, download all 2019 S2 imagery and CROME land-use data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate a stac client to download the images</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">PyStackClient</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;https://earth-search.aws.element84.com/v1&quot;</span><span class="p">)</span>

<span class="c1"># Instantiate an AWS session to download S2 imagery</span>
<span class="n">aws_session</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">AWSSession</span><span class="p">(</span><span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(),</span>
                                         <span class="n">requester_pays</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create a transformer to map projected coords back to geodetic coords</span>
<span class="n">transform_working_to_geodetic</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">),</span> 
                                                            <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">),</span> 
                                                            <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>

<span class="c1"># Choose which bands to download</span>
<span class="n">band_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">]</span>

<span class="c1"># Define mapping for crop designation</span>
<span class="n">crome_lucode_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/CROME_LUCODE_LOOKUP.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; </span><span class="se">\\\\</span><span class="s1">t &#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">,</span> <span class="s1">&#39;cover&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">MAX_ITEMS</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">def</span> <span class="nf">handle_download_errors</span><span class="p">(</span><span class="n">_download_items</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">log_and_skip_errors</span><span class="p">(</span><span class="n">_location_code</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_download_items</span><span class="p">(</span><span class="n">_location_code</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">_location_code</span><span class="si">}</span><span class="s1"> :: ERROR (skipping) &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">log_and_skip_errors</span>
    
<span class="nd">@handle_download_errors</span>
<span class="k">def</span> <span class="nf">download_items</span><span class="p">(</span><span class="n">location_code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads all S2 and CROME data for a given PoMS location.&#39;&#39;&#39;</span>
    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Starting location processing&#39;</span><span class="p">)</span>
    <span class="n">dir_name</span> <span class="o">=</span> <span class="s1">&#39;location_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">location_code</span> <span class="p">)</span>

    <span class="n">data_path</span> <span class="o">=</span> <span class="n">create_zone_dir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>

    <span class="c1"># Skip this location if it was already processed</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)):</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Already processed, skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">aoi_bbox</span> <span class="o">=</span> <span class="n">location_geom_lookup</span><span class="p">[</span><span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="c1"># in projected coords</span>
    <span class="n">aoi_bbox_geodetic</span> <span class="o">=</span> <span class="n">transform_working_to_geodetic</span><span class="p">(</span><span class="o">*</span><span class="n">aoi_bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
    <span class="n">aoi_geodetic_shapely</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># For this AOI looks the crop map (CROME) data and identify relevant masks</span>
    <span class="n">crome_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;CROME&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Already got CROME data, skipping download&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/get_crome.sh &#39;</span> <span class="o">+</span> \
                       <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">crome_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> &#39;</span> <span class="o">+</span> \
                       <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">&quot;coordinates&quot;: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">),</span><span class="w"> </span><span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">separator</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">suppress_small</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s1">,&quot;type&quot;:&quot;Polygon&quot;</span><span class="se">}}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
           <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Search catalogue</span>
    
    <span class="n">search</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">max_items</span><span class="o">=</span><span class="n">MAX_ITEMS</span><span class="p">,</span> <span class="c1"># can retrieve multiple tiles and processing levels so need more than yearly revisit count</span>
                            <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sentinel-2-l2a&#39;</span><span class="p">],</span>
                           <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;s2:processing_baseline&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;neq&quot;</span><span class="p">:</span> <span class="s2">&quot;05.00&quot;</span><span class="p">}},</span> <span class="c1"># Sentinel 2 reprocessing has not completed for 2019</span>
                            <span class="c1"># query=[&#39;eo:cloud_cover&lt;50&#39;],</span>
                            <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="nb">min</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                                  <span class="nb">max</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                                  <span class="nb">max</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                            <span class="n">datetime</span><span class="o">=</span><span class="s1">&#39;2019&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">search</span><span class="o">.</span><span class="n">matched</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">MAX_ITEMS</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Need to request more items&#39;</span>

    <span class="c1"># Now iterate through dates with S2 acquisitions and download if they&#39;re good enough (intersect PoMS location fully and not too many clouds)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Store date reference</span>
        <span class="n">date_ref</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Starting acquisition processing&#39;</span><span class="p">)</span> 
        
        <span class="n">base_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">date_ref</span><span class="p">)</span>
        <span class="c1"># If there is already a folder here and it contains the right number of files, consider this date to be processed and skip</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Already have correct number of files, skipping&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># First check this S2 capture fully covers the AOI</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">aoi_geodetic_shapely</span><span class="p">):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: S2 acquisition did not fully cover AOI, skipping&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Next a cloud check</span>
        <span class="n">s2_thematic</span> <span class="o">=</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="n">max_cloud_perc</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_clouds</span><span class="p">(</span><span class="n">s2_thematic</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="n">max_cloud_perc</span><span class="p">):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Too cloudy, skipping (more than </span><span class="si">{</span><span class="n">max_cloud_perc</span><span class="si">}</span><span class="s1">% of image medium or high cloud probability)&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Create write directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clean_dir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
            
        <span class="c1"># Read data from S3 - already calculated scl so just add that to the dictionary instead of redownloading</span>
        <span class="n">band_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">band_name</span><span class="p">:</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="n">band_name</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span> <span class="k">for</span> <span class="n">band_name</span> <span class="ow">in</span> <span class="n">band_names</span><span class="p">}</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2_thematic</span>
        
        <span class="c1"># Calculate evi2</span>
        <span class="n">evi2</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.4</span><span class="o">*</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">evi2_profile</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">}}</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;evi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">evi2</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">evi2_profile</span><span class="p">}</span>
        

        <span class="c1"># Write results, reprojecting everything into WORKING_CRS</span>
        <span class="k">for</span> <span class="n">band_name</span><span class="p">,</span> <span class="n">data_profile</span> <span class="ow">in</span> <span class="n">band_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">,</span> <span class="n">band_name</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>

            <span class="c1">### REPROJECT: ###</span>
            <span class="c1"># Source bounds:</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">AffineTransformer</span><span class="p">(</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">])</span> 
            <span class="n">left</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
            <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
            
            <span class="c1"># Get default transform</span>
            <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">calculate_default_transform</span><span class="p">(</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span> 
                                                                    <span class="n">WORKING_CRS</span><span class="p">,</span> 
                                                                    <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> 
                                                                    <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> 
                                                                    <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span>
                                                                    <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span>
                                                                    <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
                                                                    <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">)</span>
            <span class="n">_profile</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span>
                            <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">})</span>
            
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Writing to </span><span class="si">{</span><span class="n">full_write_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">full_write_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_profile</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                            <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                            <span class="n">src_transform</span><span class="o">=</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                            <span class="n">src_crs</span><span class="o">=</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span>
                                            <span class="n">dst_transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
                                            <span class="n">dst_crs</span><span class="o">=</span><span class="n">WORKING_CRS</span><span class="p">,</span>
                                            <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>
    
    <span class="c1"># Now create a file to hold any metadata we may want to add and also signals completion of this location&#39;s download            </span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;touch&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)])</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">aws_session</span><span class="p">):</span>
    <span class="n">location_codes</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">dask_client</span> <span class="o">=</span> <span class="n">DaskClient</span><span class="p">(</span><span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">location_code</span> <span class="ow">in</span> <span class="n">location_codes</span><span class="p">:</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">dask_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">download_items</span><span class="p">,</span> <span class="n">location_code</span><span class="p">)</span>
        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
    
    <span class="n">dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
        

<span class="c1"># https://www.matecdev.com/posts/landsat-sentinel-aws-s3-python.html</span>
<span class="c1"># https://pystac-client.readthedocs.io/en/stable/api.html#pystac_client.Client.search</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Location: 34 :: Starting location processing
Location: 34 :: Already processed, skipping
Location: 25 :: Starting location processing
Location: 25 :: Already processed, skipping
Location: 91 :: Starting location processing
Location: 91 :: Already processed, skipping
Location: 28 :: Starting location processing
Location: 28 :: Already processed, skipping
Location: 94 :: Starting location processing
Location: 94 :: Already processed, skipping
Location: 2 :: Starting location processing
Location: 2 :: Already processed, skipping
Location: 87 :: Starting location processing
Location: 87 :: Already processed, skipping
Location: 138 :: Starting location processing
Location: 138 :: Already processed, skipping
Location: 149 :: Starting location processing
Location: 149 :: Already processed, skipping
Location: 65 :: Starting location processing
Location: 110 :: Starting location processing
Location: 110 :: Already processed, skipping
Location: 65 :: Already processed, skipping
Location: 27 :: Starting location processing
Location: 27 :: Already processed, skipping
Location: 108 :: Starting location processing
Location: 108 :: Already processed, skipping
Location: 177 :: Starting location processing
Location: 177 :: Already processed, skipping
Location: 36 :: Starting location processing
Location: 67 :: Starting location processing
Location: 67 :: Already processed, skipping
Location: 36 :: Already processed, skipping
Location: 75 :: Starting location processing
Location: 73 :: Starting location processing
Location: 75 :: Already processed, skipping
Location: 73 :: Already processed, skipping
Location: 176 :: Starting location processing
Location: 176 :: Already processed, skipping
Location: 22 :: Starting location processing
Location: 22 :: Already processed, skipping
Location: 76 :: Starting location processing
Location: 76 :: Already processed, skipping
Location: 1 :: Starting location processing
Location: 163 :: Starting location processing
Location: 163 :: Already processed, skipping
Location: 1 :: Already processed, skipping
Location: 10 :: Starting location processing
Location: 10 :: Already processed, skipping
Location: 86 :: Starting location processing
Location: 86 :: Already processed, skipping
Location: 157 :: Starting location processing
Location: 157 :: Already processed, skipping
Location: 44 :: Starting location processing
Location: 44 :: Already processed, skipping
Location: 63 :: Starting location processing
Location: 63 :: Already processed, skipping
Location: 112 :: Starting location processing
Location: 112 :: Already processed, skipping
Location: 145 :: Starting location processing
Location: 145 :: Already processed, skipping
Location: 89 :: Starting location processing
Location: 89 :: Already processed, skipping
Location: 166 :: Starting location processing
Location: 160 :: Starting location processing
Location: 160 :: Already processed, skipping
Location: 166 :: Already processed, skipping
Location: 47 :: Starting location processing
Location: 47 :: Already processed, skipping
Location: 146 :: Starting location processing
Location: 146 :: Already processed, skipping
Location: 131 :: Starting location processing
Location: 131 :: Already processed, skipping
Location: 161 :: Starting location processing
Location: 161 :: Already processed, skipping
Location: 51 :: Starting location processing
Location: 51 :: Already processed, skipping
Location: 42 :: Starting location processing
Location: 42 :: Already processed, skipping
Location: 125 :: Starting location processing
Location: 125 :: Already processed, skipping
Location: 71 :: Starting location processing
Location: 71 :: Already processed, skipping
Location: 59 :: Starting location processing
Location: 59 :: Already processed, skipping
Location: 66 :: Starting location processing
Location: 66 :: Already processed, skipping
Location: 182 :: Starting location processing
Location: 182 :: Already processed, skipping
Location: 74 :: Starting location processing
Location: 74 :: Already processed, skipping
Location: 39 :: Starting location processing
Location: 39 :: Already processed, skipping
Location: 64 :: Starting location processing
Location: 64 :: Already processed, skipping
Location: 32 :: Starting location processing
Location: 32 :: Already processed, skipping
Location: 5 :: Starting location processing
Location: 128 :: Starting location processing
Location: 128 :: Already processed, skipping
Location: 5 :: Already processed, skipping
Location: 172 :: Starting location processing
Location: 162 :: Starting location processing
Location: 172 :: Already processed, skipping
Location: 162 :: Already processed, skipping
Location: 106 :: Starting location processing
Location: 106 :: Already processed, skipping
Location: 122 :: Starting location processing
Location: 122 :: Already processed, skipping
Location: 54 :: Starting location processing
Location: 54 :: Already processed, skipping
Location: 121 :: Starting location processing
Location: 121 :: Already processed, skipping
Location: 173 :: Starting location processing
Location: 173 :: Already processed, skipping
Location: 7 :: Starting location processing
Location: 7 :: Already processed, skipping
Location: 100 :: Starting location processing
Location: 100 :: Already processed, skipping
Location: 6 :: Starting location processing
Location: 6 :: Already processed, skipping
Location: 79 :: Starting location processing
Location: 79 :: Already processed, skipping
Location: 174 :: Starting location processing
Location: 174 :: Already processed, skipping
Location: 19 :: Starting location processing
Location: 19 :: Already processed, skipping
Location: 4 :: Starting location processing
Location: 4 :: Already processed, skipping
Location: 111 :: Starting location processing
Location: 118 :: Starting location processing
Location: 118 :: Already processed, skipping
Location: 111 :: Already processed, skipping
Location: 96 :: Starting location processing
Location: 96 :: Already processed, skipping
Location: 13 :: Starting location processing
Location: 13 :: Already processed, skipping
Location: 180 :: Starting location processing
Location: 180 :: Already processed, skipping
Location: 183 :: Starting location processing
Location: 183 :: Already processed, skipping
Location: 31 :: Starting location processing
Location: 31 :: Already processed, skipping
</pre></div>
</div>
</div>
</div>
</section>
<section id="full-walkthrough-for-one-location">
<h4>Full walkthrough for one location<a class="headerlink" href="#full-walkthrough-for-one-location" title="Permalink to this heading">#</a></h4>
<p>Take a look at one location’s output on a single date:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">location_code</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;2019_03_25&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Color mapping for the scene classification</span>
<span class="c1"># Color map as described at https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/scene-classification/</span>

<span class="n">classification_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Dark features/Shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Vegetation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Not-vegetated&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Water (dark and bright)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Unclassified&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud medium probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud high probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Thin cirrus&#39;</span><span class="p">]</span>
<span class="n">classification_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">90</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">]]]</span>

<span class="n">scl_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;SCL map&#39;</span><span class="p">,</span> <span class="n">classification_colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">))</span>
<span class="n">scl_thematic_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">,</span> <span class="n">classification_names</span><span class="p">)]</span>
<span class="n">scl_norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">([</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">)],</span> <span class="n">scl_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">views</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2&#39;</span><span class="p">,</span> <span class="s1">&#39;scl&#39;</span><span class="p">]</span>
<span class="n">norms</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">PowerNorm</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scl_norm</span><span class="p">]</span>
<span class="n">cmaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scl_cmap</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">views</span><span class="p">):</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">view</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">view</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">data_profile</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">}</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">view</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">]:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10000</span> <span class="c1"># Quantification value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
                   <span class="n">norm</span><span class="o">=</span><span class="n">norms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                   <span class="c1"># extent = [ref_bounds.left, ref_bounds.right, ref_bounds.bottom, ref_bounds.top],</span>
                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
                  <span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="c1"># ax.text(0.5, -0.05, f&#39;({band_name})&#39;, horizontalalignment=&#39;center&#39;, transform=ax.transAxes)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">band_name</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;scl&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scl_thematic_map</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location code </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> on date </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="c1"># fig.tight_layout()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "13736bebd1cb4ff88932e4e57549d87d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Now use the S2 scene classification to mask out any “bad” pixels. Note that the SCL is lower resolution than the red and NIR bands so needs to be resampled for use with evi2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resample_scl</span><span class="p">(</span><span class="n">scl_path</span><span class="p">,</span> <span class="n">ref_raster_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scl_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">reference</span><span class="p">:</span>
            <span class="c1"># resample data to target shape</span>
            <span class="n">scl_raw</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">height</span><span class="p">),</span>
                                             <span class="nb">int</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">width</span><span class="p">)),</span>
                                  <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scl_raw</span>
    

<span class="k">def</span> <span class="nf">get_scl_good_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out &quot;bad&quot; pixels according to the S2 scene classification.&#39;&#39;&#39;</span>
    <span class="n">scl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">)</span>
    
    <span class="n">scl_raw</span> <span class="o">=</span> <span class="n">resample_scl</span><span class="p">(</span><span class="n">scl_path</span><span class="p">,</span> <span class="n">evi2_path</span><span class="p">)</span>
            
    <span class="n">scl_good_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scl_raw</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># No data</span>
                                       <span class="mi">1</span><span class="p">,</span> <span class="c1"># Saturated/defective pixel</span>
                                       <span class="mi">6</span><span class="p">,</span> <span class="c1"># Water</span>
                                       <span class="mi">9</span><span class="p">,</span> <span class="c1"># Cloud high prob</span>
                                       <span class="mi">11</span><span class="p">])</span> <span class="c1"># Snow or ice</span>

    <span class="k">return</span> <span class="n">scl_good_mask</span>
                               

        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;visual.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
               <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
               <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;RGB and Date-Specific S2 Scene Classification &quot;Good Pixel&quot; Mask&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "86b75f92ea1544dc9ad9e045e02b8ad0", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Define a second mask based on the SCL as pixels not labelled as vegetation on the entire year:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out pixels not labelled as vegetation according to S2 SCL for the entire period.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">mask_non_vegetation_scl</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">resample_scl</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;scl.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">4</span>
        
        <span class="k">return</span> <span class="n">res</span>

    <span class="n">base_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">/*/scl.tif&#39;</span>
    <span class="n">scl_never_veg</span> <span class="o">=</span> <span class="o">~</span><span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="p">[</span><span class="n">mask_non_vegetation_scl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">base_path</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">scl_never_veg</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;visual.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
               <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
               <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;RGB and S2 Scene Classification &quot;Never Vegetation&quot; Mask&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "539b2301639e4c1d87be686496252324", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Now get masks based on crop designation. The method was originally applied to spring cereals [1], so return a spring cereal mask.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To Do - test with a single AOI history, credit phenolopy</span>
<span class="n">SPRING_CEREAL_LUCODES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AC01&#39;</span><span class="p">,</span> <span class="c1"># barley</span>
                         <span class="s1">&#39;AC19&#39;</span><span class="p">,</span> <span class="c1"># oats</span>
                         <span class="s1">&#39;AC24&#39;</span><span class="p">,</span> <span class="c1"># rye</span>
                         <span class="s1">&#39;AC30&#39;</span><span class="p">,</span> <span class="c1"># triticale</span>
                         <span class="s1">&#39;AC32&#39;</span><span class="p">]</span> <span class="c1"># wheat</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rasterize_crome_mask</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">evi2_profile</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> 
                                        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">evi2_profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">evi2_profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])),</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">evi2_profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                        <span class="n">default_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="k">def</span> <span class="nf">get_crome_geoms</span><span class="p">(</span><span class="n">location_code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads crome data and converts to geometries on selected land-use codes.&#39;&#39;&#39;</span>
    <span class="n">crome_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crome_path</span><span class="p">)</span>
    
    <span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spring_cereal_geoms</span>


<span class="k">def</span> <span class="nf">get_farmed_area</span><span class="p">(</span><span class="n">location_code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads crome data and calculates the land area used for agriculture for this tile&#39;&#39;&#39;</span>
    <span class="n">crome_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crome_path</span><span class="p">)</span>
    
    <span class="n">spring_cereal_area</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">agric_area</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;LG&#39;</span><span class="p">,</span> <span class="s1">&#39;NU&#39;</span><span class="p">,</span> <span class="s1">&#39;TC&#39;</span><span class="p">,</span> <span class="s1">&#39;SR&#39;</span><span class="p">))]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spring_cereal_area</span><span class="p">,</span> <span class="n">agric_area</span>

<span class="k">def</span> <span class="nf">get_cereal_grass_masks</span><span class="p">(</span><span class="n">location_code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Gets agricultural land-use masks based on CROME data.&#39;&#39;&#39;</span>
    <span class="c1"># For this location get CROME data (constant on a year)</span>
    <span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">get_crome_geoms</span><span class="p">(</span><span class="n">location_code</span><span class="p">)</span>
    
    <span class="c1"># Convert shapes to rasters based on raster profile of an evi2.tif for this location (should all have the same profile)</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;*/evi2.tif&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">evi2_path</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span>
    
    <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">rasterize_crome_mask</span><span class="p">(</span><span class="n">spring_cereal_geoms</span><span class="p">,</span> <span class="n">evi2_profile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cereal_mask</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;visual.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
               <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
               <span class="n">extent</span><span class="o">=</span><span class="n">extent</span>
              <span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RGB </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">get_crome_geoms</span><span class="p">(</span><span class="n">location_code</span><span class="p">)</span>
<span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">spring_cereal_geoms</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">([</span><span class="n">location_geom_lookup</span><span class="p">[</span><span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>


<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">evi2</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">evi2</span><span class="p">),</span> 
               <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
               <span class="n">extent</span><span class="o">=</span><span class="n">extent</span>
              <span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;EVI2 </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">get_crome_geoms</span><span class="p">(</span><span class="n">location_code</span><span class="p">)</span>
<span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">spring_cereal_geoms</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">([</span><span class="n">location_geom_lookup</span><span class="p">[</span><span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;CROME Spring Cereal Polygons and Study Area on S2 Data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1092e1a07780408bb4c73c028697cb2c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Note that the Sentinel 2 data and CROME data is requested with a bounding box defined in different coordinate reference systems, meaning the data layer extents do not align.</p>
</section>
<section id="apply-masks">
<h4>Apply masks<a class="headerlink" href="#apply-masks" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_grass_masks</span><span class="p">(</span><span class="n">location_code</span><span class="p">)</span>

<span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;*/evi2.tif&#39;</span><span class="p">)))</span>

<span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
<span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                 <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                  <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Plot results of masking:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> <span class="n">evi2_xr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Visual test of xarray masking #1&quot;</span><span class="p">)</span>

<span class="c1"># xr.where(good_scl_masks_xr, evi2_xr, np.nan)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;Visual test of xarray masking #1&#39;)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "891452a6d22248a9b1f9d9864148fcbb", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">),</span> <span class="n">evi2_xr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Visual test of xarray masking #2&quot;</span><span class="p">)</span>


<span class="c1"># xr.where(get_scl_never_veg_mask(location_code), evi2_xr, np.nan)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;Visual test of xarray masking #2&#39;)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "35efe1283d9344ed92db43c18fb0aaa5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> <span class="n">evi2_xr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Visual test of xarray masking #3&quot;</span><span class="p">)</span>


<span class="c1"># xr.where(cereal_mask, evi2_xr, np.nan)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;Visual test of xarray masking #3&#39;)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "fdb278e306694155860765d02a52f7d1", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Create three masked xr datasets:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Used chained where condition:</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
             <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">),</span>
                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
             <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">),</span>
                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                               <span class="n">evi2_xr</span><span class="p">,</span> 
                               <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                      <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
             <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Visual test of xarray masking #6&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;Visual test of xarray masking #6&#39;)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "24f0f68cb9434369a3a0a763520b28a7", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Define evi2 xarray data arrays fully masked now:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                          <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">),</span>
                                   <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                            <span class="n">evi2_xr</span><span class="p">,</span> 
                                            <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                                   <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                          <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="phenology-parameter-calculations">
<h4>Phenology parameter calculations<a class="headerlink" href="#phenology-parameter-calculations" title="Permalink to this heading">#</a></h4>
<p>As per <a class="github reference external" href="https://github.com/lewistrotter/PhenoloPy/blob/main/Phenolopy.ipynb">lewistrotter/PhenoloPy</a></p>
<p>Note that I’ve made a few minor fixes in my local version of the phenolopy module to make the functions play nicely with new xarray and numpy releases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Just do a bit of xarray preparation</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redefine as a dataset</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_pval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set resample interval now, as a few functions require it</span>
<span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>

<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.
</pre></div>
</div>
</div>
</div>
<p>Calculate the phenology parameters using Phenolopy, modified slightly to follow methodology in [1] with a 5th percentile base level.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
</pre></div>
</div>
</div>
</div>
<p>Amplitude (aos) of the vegetation index id defined as the peak value (max observed in the season) minus the base value (fifth percentile of veg index) and was found to have the strongest correlation with farmer reported yields, alongside peak EVI2 [1].</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metric</span><span class="o">=</span><span class="mi">2</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)[</span><span class="s1">&#39;phen_metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;aos_values&#39;)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bba534ea6237498d880c8c958dc2e857", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Now plot the pixel-wise EVI2 time series, as well as the amplitude metric distribution for pixels labelled spring cereals according to CROME.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
<span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
<span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

<span class="c1"># Create 2x2 sub plots</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mf">.15</span><span class="p">,</span> <span class="mf">.85</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> 
<span class="k">for</span> <span class="n">pixel_ref</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="p">[:,</span> <span class="n">pixel_ref</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sample of EVI2 Pixel-Wise Time-Series&#39;</span><span class="p">)</span>

<span class="n">_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># row 0, col 1</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EVI2 Amplitude Distribution on Spring Cereal Pixels&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e56881c6e98c48a0aa74867a2f5cf139", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>The long left tail in the amplitude distribution results from deficiencies with the CROME designation; in particular the CROME dataset:</p>
<ul class="simple">
<li><p>has a resolution coarser than that of Sentinel 2, hence when sampled at S2 (10m) resolution pixels which are not in the field are included;</p></li>
<li><p>as a classification, is not perfect (it is produced by a random forest classifier); and,</p></li>
<li><p>assumes a single crop per pixel per year for the designations chosen</p></li>
</ul>
<p>The first two points mean that out-of-field pixels may be included, which very likely show lower EVI2 amplitudes than we see in the field, where there is a progression from bare earth to healthly crops.</p>
<p>The last two points also may result in erroneous spring cereal amplitudes if a second crop, associated with a greater EVI2 peak is grown in the same year, though looking at the time series data below this should not be an issue as the greatest peak majoratively corresponds to a spring-sown crop, and other peaks are of a similar magnitude.</p>
</section>
</section>
<section id="bulk-process-satellite-imagery">
<h3>Bulk process satellite imagery<a class="headerlink" href="#bulk-process-satellite-imagery" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">location_codes</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_aos</span><span class="p">(</span><span class="n">location_code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns the median evi2 amplitude on spring cereal fields in AOI&#39;&#39;&#39;</span>
    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beginning processing for location </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_grass_masks</span><span class="p">(</span><span class="n">location_code</span><span class="p">)</span>
        <span class="n">spring_cereal_area</span><span class="p">,</span> <span class="n">agric_area</span> <span class="o">=</span> <span class="n">get_farmed_area</span><span class="p">(</span><span class="n">location_code</span><span class="p">)</span>
        <span class="n">spr_cer_per</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">spring_cereal_area</span><span class="o">/</span><span class="n">agric_area</span>
        <span class="k">assert</span> <span class="n">spr_cer_per</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">distributed_print</span><span class="p">((</span><span class="n">location_code</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">location_code</span><span class="p">,</span> <span class="kc">None</span>
    
    <span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/Locations/location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;*/evi2.tif&#39;</span><span class="p">)))</span>
    <span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                     <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                      <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">distributed_print</span><span class="p">((</span><span class="n">location_code</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">location_code</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                          <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">location_code</span><span class="p">),</span>
                                   <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                            <span class="n">evi2_xr</span><span class="p">,</span> 
                                            <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                                   <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                          <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>


    <span class="c1"># Just do a bit of xarray preparation</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>

    <span class="c1"># Redefine as a dataset</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>

    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>

    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_pval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="c1"># set resample interval now, as a few functions require it</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>
    
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>

    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>

    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
    <span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
    <span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done processing </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">location_code</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">aos_vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dask_client</span> <span class="o">=</span> <span class="n">DaskClient</span><span class="p">(</span><span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">location_code</span> <span class="ow">in</span> <span class="n">location_codes</span><span class="p">:</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">dask_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">get_aos</span><span class="p">,</span> <span class="n">location_code</span><span class="p">)</span>
    <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;skip&#39;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">,</span> <span class="s1">&#39;median_aos&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/Locations/aos_results.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Beginning processing for location 25
Beginning processing for location 34
Beginning processing for location 94
Beginning processing for location 2
Beginning processing for location 87
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Beginning processing for location 91
Beginning processing for location 28
(87, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Beginning processing for location 138
(138, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 177
Beginning processing for location 36
(36, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 108
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 110
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:15: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:25: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:26: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(91, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 27
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_155729/1271191953.py:25: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:26: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:25: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:26: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:25: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:25: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:26: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:25: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(108, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 149
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_155729/1271191953.py:26: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
/tmp/ipykernel_155729/1271191953.py:25: FutureWarning: Currently, index_parts defaults to True, but in the future, it will default to False to be consistent with Pandas. Use `index_parts=True` to keep the current behavior and True/False to silence the warning.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(149, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 75
(75, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 73
(73, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 176
Done processing 94
Beginning processing for location 22
Done processing 34
Beginning processing for location 65
(65, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 67
(67, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 163
(163, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 1
Done processing 177
Beginning processing for location 10
Done processing 110
Beginning processing for location 76
(76, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 157
(157, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 63
(63, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 44
Beginning processing for location 25
Beginning processing for location 94
Beginning processing for location 2
Beginning processing for location 87
(87, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 36
(36, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 108
(2, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 110
(108, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 149
(149, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 75
(75, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 73
(73, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 176
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 94
Beginning processing for location 22
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 110
Beginning processing for location 76
(76, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 157
(157, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 63
(63, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 44
(44, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 112
(112, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 145
(145, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 89
(89, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 160
(160, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 47
(47, DriverError(&#39;../../../data/Agric_data/Locations/location_47/CROME: No such file or directory&#39;))
Beginning processing for location 166
(166, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 146
(146, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 131
(131, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 51
(51, DriverError(&#39;../../../data/Agric_data/Locations/location_51/CROME: No such file or directory&#39;))
Beginning processing for location 161
(161, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 42
(42, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 125
(125, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 71
(71, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 66
(66, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 59
(59, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 182
(182, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 74
(74, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 39
(39, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 32
Beginning processing for location 34
Beginning processing for location 91
Beginning processing for location 28
Beginning processing for location 138
(138, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 177
(91, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 27
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 34
Beginning processing for location 65
(65, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 67
(67, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 163
(163, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 1
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 177
Beginning processing for location 10
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
Done processing 28
Beginning processing for location 86
(86, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 5
Done processing 176
Beginning processing for location 64
(64, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 162
(162, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 172
Done processing 27
Beginning processing for location 128
(128, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 122
(122, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 54
(54, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 121
(121, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 173
(172, ValueError(&#39;all input arrays must have the same shape&#39;))
Beginning processing for location 106
Done processing 25
Beginning processing for location 100
Done processing 1
Beginning processing for location 7
(7, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 79
(44, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 112
(112, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 145
(145, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 89
(89, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 160
(160, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 47
(47, DriverError(&#39;../../../data/Agric_data/Locations/location_47/CROME: No such file or directory&#39;))
Beginning processing for location 166
(166, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 146
(146, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 131
(131, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 51
(51, DriverError(&#39;../../../data/Agric_data/Locations/location_51/CROME: No such file or directory&#39;))
Beginning processing for location 161
(161, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 42
(42, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 125
(125, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 71
(71, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 66
(66, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 59
(59, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 182
(182, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 74
(74, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 39
(39, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 32
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 176
Beginning processing for location 64
(64, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 162
(162, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 172
(172, ValueError(&#39;all input arrays must have the same shape&#39;))
Beginning processing for location 106
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 25
Beginning processing for location 100
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.Done processing 32
Beginning processing for location 6
Done processing 22
Beginning processing for location 19
Done processing 5
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 28
Beginning processing for location 86
(86, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 5
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 27
Beginning processing for location 128
(128, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 122
(122, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 54
(54, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 121
(121, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 173
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 1
Beginning processing for location 7
(7, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 79
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 5
Beginning processing for location 174Beginning processing for location 174
(19, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
(6, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 4
Beginning processing for location 118
(118, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 96
(96, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 13
(4, ValueError(&#39;all input arrays must have the same shape&#39;))
Beginning processing for location 180
(180, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 31
Done processing 10
Beginning processing for location 111
(111, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 183
Done processing 106
Done processing 173
Done processing 100
Done processing 79

&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Done processing 32
Beginning processing for location 6
Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 22
Beginning processing for location 19
(6, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
(19, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 4
Beginning processing for location 118
(118, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 96
(96, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 13
(4, ValueError(&#39;all input arrays must have the same shape&#39;))
Beginning processing for location 180
(180, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location 31
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 106
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 100
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
Done processing 174
Done processing 31
Done processing 13

&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 10
Beginning processing for location 111
(111, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location 183
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 173
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 79
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing 174
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
Done processing 183
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this heading">#</a></h2>
<section id="correlation-between-biodiversity-and-aos">
<h3>Correlation between biodiversity and AOS<a class="headerlink" href="#correlation-between-biodiversity-and-aos" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aos_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/Locations/aos_results.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">bee_hoverfly_biodiversity</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>median_aos</th>
      <th>abundance</th>
      <th>species_richness</th>
      <th>species_diversity</th>
    </tr>
    <tr>
      <th>location_code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>25</th>
      <td>1.669695</td>
      <td>108.0</td>
      <td>29.0</td>
      <td>2.931143</td>
    </tr>
    <tr>
      <th>34</th>
      <td>0.739178</td>
      <td>93.0</td>
      <td>27.0</td>
      <td>2.732728</td>
    </tr>
    <tr>
      <th>94</th>
      <td>0.643424</td>
      <td>45.0</td>
      <td>24.0</td>
      <td>2.976177</td>
    </tr>
    <tr>
      <th>28</th>
      <td>1.250893</td>
      <td>47.0</td>
      <td>18.0</td>
      <td>2.299780</td>
    </tr>
    <tr>
      <th>110</th>
      <td>1.636076</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>0.636514</td>
    </tr>
    <tr>
      <th>176</th>
      <td>1.415727</td>
      <td>55.0</td>
      <td>23.0</td>
      <td>2.926144</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1.586517</td>
      <td>130.0</td>
      <td>39.0</td>
      <td>3.207008</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.622874</td>
      <td>159.0</td>
      <td>35.0</td>
      <td>2.695120</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1.443116</td>
      <td>26.0</td>
      <td>15.0</td>
      <td>2.459000</td>
    </tr>
    <tr>
      <th>32</th>
      <td>1.333322</td>
      <td>36.0</td>
      <td>16.0</td>
      <td>2.436287</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.786882</td>
      <td>67.0</td>
      <td>25.0</td>
      <td>2.725591</td>
    </tr>
    <tr>
      <th>106</th>
      <td>1.335374</td>
      <td>7.0</td>
      <td>5.0</td>
      <td>1.475076</td>
    </tr>
    <tr>
      <th>100</th>
      <td>1.478244</td>
      <td>109.0</td>
      <td>25.0</td>
      <td>2.548509</td>
    </tr>
    <tr>
      <th>79</th>
      <td>0.905548</td>
      <td>21.0</td>
      <td>9.0</td>
      <td>1.838799</td>
    </tr>
    <tr>
      <th>174</th>
      <td>1.408726</td>
      <td>34.0</td>
      <td>17.0</td>
      <td>2.715492</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1.508570</td>
      <td>52.0</td>
      <td>16.0</td>
      <td>2.069636</td>
    </tr>
    <tr>
      <th>31</th>
      <td>1.614650</td>
      <td>106.0</td>
      <td>25.0</td>
      <td>2.484414</td>
    </tr>
    <tr>
      <th>183</th>
      <td>1.299074</td>
      <td>84.0</td>
      <td>30.0</td>
      <td>2.910603</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span> <span class="s1">&#39;species_diversity&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;median_aos&#39;, ylabel=&#39;species_diversity&#39;&gt;
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bdf36081a5b84945b6d8571365abcd79", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;abundance&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PearsonRResult(statistic=-0.11223042119617023, pvalue=0.657494442170121)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;species_richness&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PearsonRResult(statistic=-0.18643618215169605, pvalue=0.45885812005526905)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;species_diversity&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PearsonRResult(statistic=-0.20707239015455237, pvalue=0.40968085619018163)
</pre></div>
</div>
</div>
</div>
<p>There isn’t a significant correlation between any of the bee and hoverfly biodiversity measures and the S2 productivity parameters.</p>
<p>This does not align with the results detailed in [1]. Possible explanations include the following:</p>
<ul class="simple">
<li><p>The adaptations applied here (to work with PoMS data) render the methodology invalid, in particular the use of a 2.5km radius around the PoMS monitoring location for S2 parameter calculations; [1] takes only 4 in-field S2 pixels for each sampling location</p></li>
<li><p>The assumption that nearby spring cereal evi2 amplitude effectively proxies local agricultural intensity is invalid. Spring cereal fields form a relatively small proportion of the farmed land, and an even smaller proportion of total land in the vicininty of each PoMS location.</p></li>
<li><p>The sample size here is too small for generalization of the original method.</p></li>
<li><p>The method [1] is not reproducible.</p></li>
</ul>
<p>Can’t conclude the final point as the methodology used here is substantively different from [1].</p>
<p>Some ideas to rectify issues:</p>
<ol class="arabic simple">
<li><p>Look at vascular plant diversity indices on the larger UK National Plant Monitoring Scheme; filter for sites in spring cereal fields across possible CROME dates; download only in-field S2 imagery and repeat analysis done here.</p></li>
<li><p>Take the larger PoMS citizen science FIT counts dataset, generate sufficient S2 indices across the study area and compare distributions.</p></li>
</ol>
<p><strong>IYR vs PMS</strong> </br>
Look at IYR values on PMS data localities (potentially for this one look a PMS citizen science data instead of trap data). Identify areas for de-intensification of farming.:</p>
<p>Looking at the distribution of PMS indices with reference to honeybee-specific pesticide input to crop yield ratios (IYR) [2] can any potential priority areas for de-intensification be identified. Any particular risk zones?</p>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Abdi AM, Carrié R, Sidemo-Holm W, Cai Z, Boke-Olén N, Smith HG, Eklundh L, Ekroos J, Biodiversity Decline With Increasing Crop Productivity in Agricultural Fields Revealed by Satellite Remote Sensing. Ecological Indicators. 2021; 130():108098. <a class="reference external" href="https://doi.org/10.1016/j.ecolind.2021.108098">https://doi.org/10.1016/j.ecolind.2021.108098</a>.</p></li>
<li><p>Bullock JM, Jarvis SG, Fincham WNW, Risser H, Schultz C, Spurgeon DJ, et al.. Mapping the Ratio of Agricultural Inputs to Yields Reveals Areas With Potentially Less Sustainable Farming. Science of The Total Environment. 2024; 909(): 168491. <a class="reference external" href="https://doi.org/10.1016/j.scitotenv.2023.168491">https://doi.org/10.1016/j.scitotenv.2023.168491</a>.</p></li>
<li><p><a class="reference external" href="https://stateofnature.org.uk/wp-content/uploads/2023/09/TP25999-State-of-Nature-main-report_2023_FULL-DOC-v12.pdf">https://stateofnature.org.uk/wp-content/uploads/2023/09/TP25999-State-of-Nature-main-report_2023_FULL-DOC-v12.pdf</a> [Accessed 20/02/2024]</p></li>
<li><p><a class="reference external" href="https://www.biorxiv.org/content/10.1101/2022.08.21.504707v2">https://www.biorxiv.org/content/10.1101/2022.08.21.504707v2</a></p></li>
<li><p>Helen Phillips; Adriana De Palma; Ricardo E Gonzalez; Sara Contu et al. (2021). The Biodiversity Intactness Index - country, region and global-level summaries for the year 1970 to 2050 under various scenarios [Data set]. Natural History Museum. <a class="reference external" href="https://doi.org/10.5519/he1eqmg1">https://doi.org/10.5519/he1eqmg1</a></p></li>
<li><p>Structure of the agricultural industry in England and the UK at June</p></li>
<li><p><a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2664376/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2664376/</a></p></li>
<li><p>Agricultural intensification and the collapse of Europe’s farmland bird populations.</p></li>
<li><p>Linking agricultural practice to insect and bird populations: a historical study over three decades.</p></li>
<li><p>Patterns and causes of species endangerment in Canada</p></li>
<li><p>Farming and the fate of wild nature</p></li>
<li><p>UK PoMS data download</p></li>
<li><p><a class="reference external" href="https://uk-scape.ceh.ac.uk/our-science/projects/PoMS">https://uk-scape.ceh.ac.uk/our-science/projects/PoMS</a> [Accessed 20/02/2024]</p></li>
<li><p><a class="reference external" href="https://www.jstor.org/stable/1541">https://www.jstor.org/stable/1541</a></p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-do">To do</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#study-area">Study area</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data">Biodiversity data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#satellite-imagery-and-land-use-data">Satellite imagery and land-use data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-download">Data download</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#full-walkthrough-for-one-location">Full walkthrough for one location</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-masks">Apply masks</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#phenology-parameter-calculations">Phenology parameter calculations</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bulk-process-satellite-imagery">Bulk process satellite imagery</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-between-biodiversity-and-aos">Correlation between biodiversity and AOS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tom Whitehouse
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>