

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Ecological Data Science for Sustainable Agriculture (Part III) &#8212; Topics in Quantitative Ecology and Beyond</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/Ecological Data Science for Sustainable Agriculture (Part III)';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Ecological Data Science for Sustainable Agriculture (Part IV)" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20IV%29.html" />
    <link rel="prev" title="Ecological Data Science for Sustainable Agriculture (Part II)" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20II%29.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="Introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">Topics in Quantitative Ecology and Beyond</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Species%20Distribution%20Modelling%20with%20Python.html">Species Distribution Modelling with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20I%29.html">Ecological Data Science for Sustainable Agriculture (Part I)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20II%29.html">Ecological Data Science for Sustainable Agriculture (Part II)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Ecological Data Science for Sustainable Agriculture (Part III)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20IV%29.html">Ecological Data Science for Sustainable Agriculture (Part IV)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hybrid%20Learning%20for%20Species%20Classification%20on%20Image%20Datasets.html">Hybrid Learning for Species Classification on Image Datasets</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/twhit1/quant_ecolo" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/docs/Ecological Data Science for Sustainable Agriculture (Part III).ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Ecological Data Science for Sustainable Agriculture (Part III)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data">Biodiversity data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#uk-national-pollinator-monitoring-scheme">UK National Pollinator Monitoring Scheme</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#crome-data">CROME data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-sentinel-2-imagery">Download Sentinel-2 imagery</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spring-cereal-productivity-and-phenology-parameters-from-sentinel-2-images">Spring cereal productivity and phenology parameters from Sentinel-2 images</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phenology-and-productivity-parameter-calculations">Phenology and productivity parameter calculations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extend-process-to-full-imagery-dataset">Extend process to full imagery dataset</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="ecological-data-science-for-sustainable-agriculture-part-iii">
<h1>Ecological Data Science for Sustainable Agriculture (Part III)<a class="headerlink" href="#ecological-data-science-for-sustainable-agriculture-part-iii" title="Permalink to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vector processing</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">osgb</span>

<span class="c1"># Raster processing</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterio.warp</span>
<span class="kn">import</span> <span class="nn">rasterio.mask</span>
<span class="kn">import</span> <span class="nn">rasterio.plot</span>
<span class="kn">import</span> <span class="nn">rasterio.features</span>
<span class="kn">import</span> <span class="nn">rasterio.sample</span>
<span class="kn">from</span> <span class="nn">rasterio</span> <span class="kn">import</span> <span class="n">windows</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rioxarray</span>

<span class="c1"># Calcs and modelling</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Visualisation</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">cx</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.formatter.limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">FIGSIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

<span class="c1"># Practical</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pystac_client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">DaskClient</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="nb">print</span> <span class="k">as</span> <span class="n">distributed_print</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../../git_packages/PhenoloPy/scripts&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">phenolopy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

<span class="n">DATA_BASE_PATH</span> <span class="o">=</span> <span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/&#39;</span> <span class="c1"># all data under this path (global)</span>
<span class="n">WORKING_CRS</span> <span class="o">=</span> <span class="s1">&#39;EPSG:3035&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this heading">#</a></h2>
<section id="biodiversity-data">
<h3>Biodiversity data<a class="headerlink" href="#biodiversity-data" title="Permalink to this heading">#</a></h3>
<section id="uk-national-pollinator-monitoring-scheme">
<h4>UK National Pollinator Monitoring Scheme<a class="headerlink" href="#uk-national-pollinator-monitoring-scheme" title="Permalink to this heading">#</a></h4>
<p>Here Iâ€™m using data from the UK Pollinator Monitoring Scheme (PoMS) [12], which provides pan-trap records relating to systematic 1 km square surveys at 95 locations across the UK. The squares are visited four times per year for data collection. The UK PoMS is the only scheme in the world to conduct systematic pollinator survey data on pollinator species abundance at a national scale [13].</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../../../data/Agric_data/Pollinator/data/ukpoms_1kmpantrapdata_2017-2020_samples.csv&quot;</span><span class="p">)</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../../../data/Agric_data/Pollinator/data/ukpoms_1kmpantrapdata_2017-2020_insects.csv&quot;</span><span class="p">)</span>

<span class="c1"># X1km_square is the SW corner of the 1KM grid cell - so add 500m to centre the reference</span>
<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span>

<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">gridder</span><span class="o">.</span><span class="n">parse_grid</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">grid_to_ll</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">)</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">gridder</span><span class="o">.</span><span class="n">parse_grid</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">grid_to_ll</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">)</span>

<span class="c1"># Convert to datetime</span>
<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

<span class="c1"># Count records</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">insect_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year
2017    2103
2018    3255
2019    4326
2020    1538
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Selecting one year to simplify the analysis (as was the case for ###CITE main reference)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">insect_data</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2019&#39;</span><span class="p">)]</span>
<span class="n">sample_data</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2019&#39;</span><span class="p">)]</span>


<span class="c1"># Convert to an equal-area projection with units metres - so all the study areas have the same area</span>
<span class="n">insect_data</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sample_data</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Calulcate biodiversity metrics for each location, pooling over sampling rounds [1]:</p>
<ul class="simple">
<li><p>Species richness: the number of unique species observed  (note there may be different sampling rates at different locations, check this)</p></li>
<li><p>Species diversity (Shannon index): the number of unique species and their relative proportions</p></li>
<li><p>Total abundance: sum of all individuals from all species</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Insect tount cols</span>
<span class="n">count_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wasps_solitary&#39;</span><span class="p">,</span>
              <span class="s1">&#39;wasps_social&#39;</span><span class="p">,</span>
              <span class="s1">&#39;wasps_parasitic&#39;</span><span class="p">,</span>
              <span class="s1">&#39;sawflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;flies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;moths&#39;</span><span class="p">,</span>
              <span class="s1">&#39;butterflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;beetles_pollen&#39;</span><span class="p">,</span>
              <span class="s1">&#39;beetles_other&#39;</span><span class="p">,</span>
              <span class="s1">&#39;insects_small&#39;</span><span class="p">,</span>
              <span class="s1">&#39;insects_other&#39;</span><span class="p">,</span>
              <span class="s1">&#39;spiders&#39;</span><span class="p">,</span>
              <span class="s1">&#39;all_invertebrates_excluding_bees_hoverflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;bees&#39;</span><span class="p">,</span>
              <span class="s1">&#39;hoverflies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;all_invertebrates_including_bees_hoverflies&#39;</span><span class="p">]</span>

<span class="c1"># Convert types</span>
<span class="n">sample_data</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;location_code&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span> <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">count_cols</span><span class="p">}})</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;location_code&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">shannon</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
    <span class="n">shannon</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">shannon</span>


<span class="c1"># Calculate hoverfly and bee abundance using occurrence data, as well as other biodiversity indices</span>
<span class="k">def</span> <span class="nf">bee_hoverfly_metrics</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
    <span class="n">abundance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="n">species_richness</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;taxon_aggregated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="c1"># Note the PoMS suggests use of taxon_aggregated for analysis, see documentation for explanation</span>
    <span class="n">species_diversity</span> <span class="o">=</span> <span class="n">shannon</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;taxon_aggregated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># Shannon</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;abundance&#39;</span><span class="p">:</span> <span class="n">abundance</span><span class="p">,</span> <span class="s1">&#39;species_richness&#39;</span><span class="p">:</span> <span class="n">species_richness</span><span class="p">,</span> <span class="s1">&#39;shannon_diversity&#39;</span><span class="p">:</span> <span class="n">species_diversity</span><span class="p">})</span>


<span class="n">bee_hoverfly_biodiversity</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location_code&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">bee_hoverfly_metrics</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>##COMPARE against methodology with PMS data</p>
<p>For the purposes of estimating agricultural intensity in the vicinity of each sampling location, I consider a circle of radius 5 km centred on the sampling location.</p>
<p>This represents a divergence from the methodology described in [1], where only the fields surveyed were selected for imagery analysis. As the S2 method is described for spring-sown cereals and there can be significant differences in vegetation indexes for different species CITE, and furthermore there is no guarantee that the PoMS survey locations are on spring-sown cereal fields, it is not possible to exactly replicate the methodology here.</p>
<p>Instead I look at the S2 imagery on grassland and cropland (specifically spring-sown cereals) in the vicinitiy of the PoMS sampling location to estimate the local land-use intensity proxy. To this end, I define a circle of radius two kilometres around the PoMS sampling location and calculation S2 indices on these areas.</p>
<p>Note that honey bees regularly travel this distance to forage, and have been witnessed more than 10 km from the hive [14], so defining a study zone around each sampling location in this way is not only practical within the constraints of the methodology here but also likely largely overlaps with areas frequented by the insects observed in the pan-traps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">sample_data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">PositronNoLabels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e5fb5aa89781a0e860bcb6e1903417db1648f96bee41eb231b6f9d43676d57cf.png" src="../_images/e5fb5aa89781a0e860bcb6e1903417db1648f96bee41eb231b6f9d43676d57cf.png" />
</div>
</div>
</section>
</section>
<section id="crome-data">
<h3>CROME data<a class="headerlink" href="#crome-data" title="Permalink to this heading">#</a></h3>
<p>The CROME data for each of these locations is downloaded outside of this script (HOW).</p>
<p>The locations are filtered for those with a spring cereal grown in the year corresponding to the PMS data, requiring a minimum of 3 CROME cells labeled spring cereal intersecting a 100 metre radius of the PMS sampling location.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SPRING_CEREAL_LUCODES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AC01&#39;</span><span class="p">,</span> <span class="c1"># barley</span>
                         <span class="s1">&#39;AC19&#39;</span><span class="p">,</span> <span class="c1"># oats</span>
                         <span class="s1">&#39;AC24&#39;</span><span class="p">,</span> <span class="c1"># rye</span>
                         <span class="s1">&#39;AC30&#39;</span><span class="p">,</span> <span class="c1"># triticale</span>
                         <span class="s1">&#39;AC32&#39;</span><span class="p">]</span> <span class="c1"># wheat</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">######## PROBABLY GET RID OF THIS</span>

<span class="n">sc_aoi_dirs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># correspond to PMS sample IDs</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">location_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/NPMS_Locations/*/CROME&#39;</span><span class="p">)):</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">location_path</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    
    <span class="c1"># filter for spring cereals</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span>
    
    <span class="n">aoi_dir</span> <span class="o">=</span> <span class="n">location_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">sc_cells_in_radius</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">])]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sc_cells_in_radius</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">sc_aoi_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plot an example of a location where spring cereals were grown in the year, with the CROME data (SC only) and study zone overlaid:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">######## PROBABLY GET RID OF THIS</span>


<span class="nb">dir</span> <span class="o">=</span> <span class="n">sc_aoi_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">location_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/NPMS_Locations/</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">/CROME&#39;</span>

<span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">location_path</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    
<span class="c1"># filter for spring cereals</span>
<span class="n">crome_data</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span>

<span class="n">sc_cells_in_radius</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">])]</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">crome_data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;lucode&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">OpenStreetMap</span><span class="o">.</span><span class="n">Mapnik</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="nb">id</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="nb">id</span><span class="p">]][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sc_cells_in_radius</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../_images/08827ab9311c518655922175ce4b34a2d506e042633d932154b6f1668d74d6ac.png" src="../_images/08827ab9311c518655922175ce4b34a2d506e042633d932154b6f1668d74d6ac.png" />
</div>
</div>
</section>
<section id="download-sentinel-2-imagery">
<h3>Download Sentinel-2 imagery<a class="headerlink" href="#download-sentinel-2-imagery" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">2e3</span><span class="p">)</span>
<span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sample_data</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">locations</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_pystack_aws_sessions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Initiates a pystac client and rasterio AWS session to coordinate requests.&#39;&#39;&#39;</span>
    
    <span class="c1"># Instantiate a stac client to download the images</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;https://earth-search.aws.element84.com/v1&quot;</span><span class="p">)</span>
    
    <span class="c1"># Instantiate an AWS session to download S2 imagery</span>
    <span class="n">aws_session</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">AWSSession</span><span class="p">(</span><span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(),</span> <span class="n">requester_pays</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">client</span><span class="p">,</span> <span class="n">aws_session</span>

<span class="n">client</span><span class="p">,</span> <span class="n">aws_session</span> <span class="o">=</span> <span class="n">get_pystack_aws_sessions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_S3</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads the data and metadata corresponding to an acquisition, based on a </span>
<span class="sd">    reference and spatial filter (defined as a shapely bbox in EPSG:4326).&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">href</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Transform window to src crs</span>
        <span class="n">transform_geodetic_to_s2</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">src_bbox</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform_geodetic_to_s2</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span><span class="o">*</span><span class="n">conform_bbox</span><span class="p">(</span><span class="n">src_bbox</span><span class="p">),</span>
                                              <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span><span class="o">.</span><span class="n">round_lengths</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> 
        <span class="n">src_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
        
        <span class="n">src_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                            <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src_profile</span><span class="p">}</span>
    
<span class="k">def</span> <span class="nf">get_geodetic_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">bbox_crs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Transforms a bounding box (as a shapely box) in a given CRS to EPSG:4326&#39;&#39;&#39;</span>
    <span class="c1"># Get transformer for bbox</span>
    <span class="n">transform_working_to_geodetic</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">bbox_crs</span><span class="p">),</span> 
                                                                <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">),</span> 
                                                                <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>
    <span class="c1"># Get transformed bbox (in EPSG:4326)</span>
    <span class="n">bbox_geodetic_coords</span> <span class="o">=</span> <span class="n">transform_working_to_geodetic</span><span class="p">(</span><span class="o">*</span><span class="n">bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
    <span class="n">bbox_geodetic</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">bbox_geodetic_coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">bbox_geodetic</span>

<span class="k">def</span> <span class="nf">conform_bbox</span><span class="p">(</span><span class="n">shapely_bbox</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns coords as left, bottom, right, top from a shapely box.</span>
<span class="sd">    </span>
<span class="sd">    This is a utility function to go between shapely and (rasterio and pystac)&#39;&#39;&#39;</span>
    <span class="n">shapely_bbox_coords</span> <span class="o">=</span> <span class="n">shapely_bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">rio_stac_bbox_coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="c1"># Align shapely and pystac conventions</span>
                             <span class="nb">min</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                             <span class="nb">max</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                             <span class="nb">max</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            
    <span class="k">return</span> <span class="n">rio_stac_bbox_coords</span>
    
<span class="k">def</span> <span class="nf">search_stac</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;searchs a stac collection with using client, filtering based on aoi_bbox_geodetic</span>
<span class="sd">    (a shapely box in EPSG:4326), and based on datetime. See pystac docs for client.search </span>
<span class="sd">    API details.</span>

<span class="sd">    Note that pystac client expands datetimes, i.e. from the docs &quot;2017 </span>
<span class="sd">    expands to 2017-01-01T00:00:00Z/2017-12-31T23:59:59Z&quot;.</span>
<span class="sd">    </span>
<span class="sd">    query examples:</span>
<span class="sd">      filter on processing baseline (see https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/processing-baseline)</span>
<span class="sd">        query = {&#39;s2:processing_baseline&#39;: {&quot;neq&quot;: &quot;05.00&quot;}}</span>

<span class="sd">      filter on cloud cloverage</span>
<span class="sd">        query=[&#39;eo:cloud_cover&lt;50&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">search</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">max_items</span><span class="o">=</span><span class="n">max_items</span><span class="p">,</span> <span class="c1"># speed up</span>
                           <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sentinel-2-l2a&#39;</span><span class="p">],</span>
                           <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                           <span class="n">bbox</span><span class="o">=</span><span class="n">conform_bbox</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">),</span>
                           <span class="n">datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">matched</span><span class="p">()</span> <span class="o">==</span> <span class="n">max_items</span><span class="p">:</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="s1">&#39;Did not receive complete results. Consider increasing max_items kwarg &#39;</span> <span class="o">+</span> \
          <span class="sa">f</span><span class="s1">&#39;(currently </span><span class="si">{</span><span class="n">max_items</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">search</span>


<span class="k">def</span> <span class="nf">item_covers_aoi</span><span class="p">(</span><span class="n">stac_item</span><span class="p">,</span> <span class="n">aoi_geodetic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns true/false depending on whether the acquisition geometry fully covers the</span>
<span class="sd">    AOI.&#39;&#39;&#39;</span>
    
    <span class="k">return</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stac_item</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">aoi_geodetic</span><span class="p">)</span>

<span class="c1"># Filter on clouds</span>
<span class="k">def</span> <span class="nf">pass_clouds_snow</span><span class="p">(</span><span class="n">scl_data</span><span class="p">,</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns true/false depending on whether the area proportion of the acquisition which</span>
<span class="sd">    is cloudy (according to the S2 cloud detection algorithm) is less than max_cloud_perc.</span>
<span class="sd">    </span>
<span class="sd">    Also includes snow/ice (SCL code 11).&#39;&#39;&#39;</span>
    
    <span class="n">medium_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">high_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
    <span class="n">snow_ice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">medium_cloud_prob</span> <span class="o">+</span> <span class="n">high_cloud_prob</span> <span class="o">+</span> <span class="n">snow_ice</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">scl_data</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">max_cloud_perc</span>

<span class="k">def</span> <span class="nf">clean_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Clears up directories if download is re-run.&#39;&#39;&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Cleaning (removing) </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">calculate_evi2</span><span class="p">(</span><span class="n">nir_data</span><span class="p">,</span> <span class="n">red_data</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns the vegetation index EVI2 and corresponding raster profile.&#39;&#39;&#39;</span>
    <span class="n">QUANT_VAL</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="c1"># Calculate evi2</span>
    <span class="n">evi2</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">nir_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">red_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">nir_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.4</span><span class="o">*</span><span class="p">(</span><span class="n">red_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">profile</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">}}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">evi2</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">evi2_profile</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">get_reprojected_profile</span><span class="p">(</span><span class="n">src_profile</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculates necessary changes to an arbritary source profile (a dictionary</span>
<span class="sd">    based on a rasterio read) to write to a target CRS or target width, height.&#39;&#39;&#39;</span>
    
    <span class="n">transformer</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">AffineTransformer</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">])</span> 
    <span class="n">left</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
    <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get default transform</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">calculate_default_transform</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span> 
                                                                            <span class="n">target_crs</span><span class="p">,</span> 
                                                                            <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> 
                                                                            <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> 
                                                                            <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span>
                                                                            <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span>
                                                                            <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
                                                                            <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span>
                                                                            <span class="n">dst_width</span><span class="o">=</span><span class="n">target_width</span><span class="p">,</span>
                                                                            <span class="n">dst_height</span><span class="o">=</span><span class="n">target_height</span><span class="p">,</span>
                                                                            <span class="n">dst_resolution</span><span class="o">=</span><span class="n">target_res</span><span class="p">)</span>

    <span class="c1"># Update profile with new crs, transform and dimensions</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">aligned_target</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">target_res</span><span class="p">)</span>
    
    <span class="n">new_profile</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src_profile</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">new_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">target_crs</span><span class="p">,</span>
                        <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">new_profile</span>
    
<span class="k">def</span> <span class="nf">trim_raster</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Overwrites to_trim_path, trimming to (shapely) geometry defined in same CRS as raster.&#39;&#39;&#39;</span>
    
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">masked_transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="n">geometry</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
        
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">masked_transform</span><span class="p">})</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">reproject_clip_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">source_profile</span><span class="p">,</span> <span class="n">target_profile</span><span class="p">,</span> <span class="n">full_write_path</span><span class="p">,</span> <span class="n">aoi_geometry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reprojects S2 data to working CRS and writes to disk, clipping to AOI geometry.&#39;&#39;&#39;</span>
    <span class="n">target_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">],</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">],</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]})</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">full_write_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">target_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">target_profile</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                    <span class="n">src_transform</span><span class="o">=</span><span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                    <span class="n">src_crs</span><span class="o">=</span><span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span>
                                    <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>

    <span class="n">trim_raster</span><span class="p">(</span><span class="n">full_write_path</span><span class="p">,</span> <span class="n">aoi_geometry</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">band_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">]</span>

<span class="n">MAX_ITEMS</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">max_cloud_perc</span> <span class="o">=</span> <span class="mi">10</span>

<span class="k">def</span> <span class="nf">handle_download_errors</span><span class="p">(</span><span class="n">_download_items</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">log_and_skip_errors</span><span class="p">(</span><span class="n">_dir_name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_download_items</span><span class="p">(</span><span class="n">_dir_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">_dir_name</span><span class="si">}</span><span class="s1"> :: ERROR (skipping) &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">log_and_skip_errors</span>
    
<span class="nd">@handle_download_errors</span>
<span class="k">def</span> <span class="nf">download_items</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads all S2 data for a given PoMS location. dir_name contains the CROME data for the location (preprocessed).&#39;&#39;&#39;</span>
    <span class="n">location_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dir_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Starting location processing&#39;</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>

    <span class="c1"># # Skip this location if it was already processed</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)):</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Already processed, skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="c1"># Get search results</span>
    <span class="n">true_aoi_bbox</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="c1"># in projected coords</span>
    <span class="c1"># buffer this by a pixel so that there are no missing corners in the data download (this can happen because of reprojections and finite resolution imagery)</span>
    <span class="n">aoi_bbox</span> <span class="o">=</span> <span class="n">true_aoi_bbox</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">aoi_bbox_geodetic</span> <span class="o">=</span> <span class="n">get_geodetic_bbox</span><span class="p">(</span><span class="n">aoi_bbox</span><span class="p">,</span> <span class="n">locations</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span> <span class="c1"># in EPSG:4326</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="n">search_stac</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="o">=</span><span class="n">aoi_bbox_geodetic</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="s1">&#39;2019&#39;</span><span class="p">,</span> 
                                 <span class="n">max_items</span><span class="o">=</span><span class="n">MAX_ITEMS</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;s2:processing_baseline&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;neq&quot;</span><span class="p">:</span> <span class="s2">&quot;05.00&quot;</span><span class="p">}})</span> <span class="c1"># Sentinel 2 reprocessing has not completed for 2019</span>

    <span class="c1"># Now iterate through dates with S2 acquisitions and download if they&#39;re good enough (intersect PoMS location fully and not too many clouds)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">search_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Store date reference</span>
        <span class="n">date_ref</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">base_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">date_ref</span><span class="p">)</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Starting acquisition processing&#39;</span><span class="p">)</span> 
        
        <span class="c1"># If there is already a folder here and it contains the right number of files, consider this date to be processed and skip</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Already have correct number of files, skipping&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Require full coverage of the AOI</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item_covers_aoi</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">):</span>
            <span class="k">continue</span>
            
        <span class="c1"># Next a cloud check</span>
        <span class="n">s2_thematic</span> <span class="o">=</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_clouds_snow</span><span class="p">(</span><span class="n">s2_thematic</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="n">max_cloud_perc</span><span class="p">):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Too cloudy/snowy, skipping (more than </span><span class="si">{</span><span class="n">max_cloud_perc</span><span class="si">}</span><span class="s1">% of image medium or high cloud probability / snowy)&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># At this point we&#39;ll download the imagery, so create write directory if it does not already exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clean_dir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
            
        <span class="c1"># Read data from S3 - already calculated scl so just add that to the dictionary instead of redownloading</span>
        <span class="n">band_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">band_name</span><span class="p">:</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="n">band_name</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span> <span class="k">for</span> <span class="n">band_name</span> <span class="ow">in</span> <span class="n">band_names</span><span class="p">}</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2_thematic</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;evi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_evi2</span><span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="c1"># Vegetation index</span>
                                           <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                           <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Define a target profile, which each raster will be aligned with</span>
        <span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">])</span>
        <span class="n">target_res</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">target_profile</span> <span class="o">=</span> <span class="n">get_reprojected_profile</span><span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">],</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="n">target_width</span><span class="p">,</span> 
                                                 <span class="n">target_height</span><span class="o">=</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_res</span><span class="o">=</span><span class="n">target_res</span><span class="p">)</span>

        <span class="c1"># Write results, reprojecting everything into WORKING_CRS and trimming to the AOI bbox</span>
        <span class="k">for</span> <span class="n">band_name</span><span class="p">,</span> <span class="n">data_profile</span> <span class="ow">in</span> <span class="n">band_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">,</span> <span class="n">band_name</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
            <span class="n">reproject_clip_write</span><span class="p">(</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">],</span> <span class="n">target_profile</span><span class="p">,</span> <span class="n">full_write_path</span><span class="p">,</span> <span class="n">true_aoi_bbox</span><span class="p">)</span> <span class="c1"># clip to true aoi bbox</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> band: </span><span class="si">{</span><span class="n">band_name</span><span class="si">}</span><span class="s1"> :: Written to </span><span class="si">{</span><span class="n">full_write_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="c1"># Now create a file to hold any metadata we may want to add and also signals completion of this location&#39;s download            </span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;touch&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)])</span>
    
    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># with rasterio.Env(aws_session):</span>
<span class="c1">#     dask_client = DaskClient(threads_per_worker=4, n_workers=2)</span>
<span class="c1">#     futures = []</span>
<span class="c1">#     for dir in os.listdir(DATA_BASE_PATH):</span>
<span class="c1">#         future = dask_client.submit(download_items, dir)</span>
<span class="c1">#         futures.append(future)</span>
    
<span class="c1">#     dask_client.gather(futures)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">##### TO DELETE THIS CELL</span>

<span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span> <span class="p">):</span>
    <span class="n">location_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">location_path</span><span class="p">):</span>
        <span class="k">continue</span>
        
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">location_path</span><span class="p">):</span>
        <span class="n">date_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">location_path</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">red_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">date_path</span><span class="p">,</span> <span class="s1">&#39;red.tif&#39;</span><span class="p">)</span>
        <span class="n">scl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">date_path</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>
        


        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">red_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scl_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">tmp_profile</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">tmp_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                    <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                                    <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="o">.</span><span class="n">height</span><span class="p">})</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scl_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">tmp_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                           <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                           <span class="n">src_transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                                           <span class="n">src_crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                           <span class="n">dst_transform</span><span class="o">=</span><span class="n">dst</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                                           <span class="n">dst_crs</span><span class="o">=</span><span class="n">dst</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                           <span class="n">dst_resolution</span><span class="o">=</span><span class="n">dst</span><span class="o">.</span><span class="n">res</span><span class="p">,</span>
                                           <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>

        

            
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">location_code</span> <span class="o">=</span> <span class="mi">108</span>
<span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;2019_02_11&#39;</span>


<span class="c1"># Colormap as defined at https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/ndvi/</span>
<span class="n">edvi_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-1.0 $\leq$ EDVI $\leq$ -0.5&#39;</span><span class="p">,</span>
               <span class="s1">&#39;-0.5 &lt; EDVI $\leq$ 0.0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.0 &lt; EDVI $\leq$ 0.1&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.1 &lt; EDVI $\leq$ 0.2&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.2 &lt; EDVI $\leq$ 0.3&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.3 &lt; EDVI $\leq$ 0.4&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.4 &lt; EDVI $\leq$ 0.5&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.5 &lt; EDVI $\leq$ 0.6&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.6 &lt; EDVI $\leq$ 1.0&#39;</span>
              <span class="p">]</span>

<span class="n">edvi_ranges_nums</span> <span class="o">=</span>  <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                    <span class="mf">0.1</span><span class="p">,</span>
                                    <span class="mf">0.2</span><span class="p">,</span>
                                    <span class="mf">0.3</span><span class="p">,</span>
                                    <span class="mf">0.4</span><span class="p">,</span>
                                    <span class="mf">0.5</span><span class="p">,</span>
                                    <span class="mf">0.6</span><span class="p">,</span>
                                    <span class="mf">1.0</span><span class="p">]</span>
<span class="n">edvi_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">234</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">234</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">204</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">130</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">145</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">81</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">112</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">63</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">79</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">45</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">28</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]]</span>


<span class="c1"># Color mapping for the scene classification</span>
<span class="c1"># Color map as described at https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/scene-classification/</span>

<span class="n">classification_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Dark features/Shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Vegetation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Not-vegetated&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Water (dark and bright)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Unclassified&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud medium probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud high probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Thin cirrus&#39;</span><span class="p">]</span>

<span class="n">classification_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">90</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">]]]</span>

<span class="n">scl_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;SCL map&#39;</span><span class="p">,</span> <span class="n">classification_colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">))</span>
<span class="n">scl_thematic_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">,</span> 
                                                                                        <span class="n">classification_names</span><span class="p">)]</span>
<span class="n">scl_norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">([</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">)],</span> <span class="n">scl_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>



<span class="n">edvi_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;EDVI map&#39;</span><span class="p">,</span> <span class="n">edvi_colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edvi_colors</span><span class="p">))</span>
<span class="n">edvi_thematic_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edvi_colors</span><span class="p">,</span> <span class="n">edvi_ranges</span><span class="p">)]</span>
<span class="n">edvi_norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">edvi_ranges_nums</span><span class="p">,</span> <span class="n">edvi_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">views</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2&#39;</span><span class="p">,</span> <span class="s1">&#39;scl&#39;</span><span class="p">]</span>
<span class="n">norms</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">PowerNorm</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">edvi_norm</span><span class="p">,</span> <span class="n">scl_norm</span><span class="p">]</span>
<span class="n">cmaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">edvi_cmap</span><span class="p">,</span> <span class="n">scl_cmap</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">views</span><span class="p">):</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">view</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">view</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">data_profile</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">}</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">view</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">]:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10000</span> <span class="c1"># Quantification value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
                   <span class="n">norm</span><span class="o">=</span><span class="n">norms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                   <span class="c1"># extent = [ref_bounds.left, ref_bounds.right, ref_bounds.bottom, ref_bounds.top],</span>
                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
                  <span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="c1"># ax.text(0.5, -0.05, f&#39;({band_name})&#39;, horizontalalignment=&#39;center&#39;, transform=ax.transAxes)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">band_name</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;scl&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scl_thematic_map</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;evi2&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">edvi_thematic_map</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location code </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> on date </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="c1"># fig.tight_layout()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "52de0dfcc7d8483480c5ff8b24c1e83c", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="spring-cereal-productivity-and-phenology-parameters-from-sentinel-2-images">
<h3>Spring cereal productivity and phenology parameters from Sentinel-2 images<a class="headerlink" href="#spring-cereal-productivity-and-phenology-parameters-from-sentinel-2-images" title="Permalink to this heading">#</a></h3>
<p>Working through an example on the acquisition shown above, create masks and carry out productivity and phenology on S2 imagery:</p>
<p>Define a mask to select only the study area from a raster:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aoi_dir</span> <span class="o">=</span> <span class="s1">&#39;location_22&#39;</span> <span class="c1">#os.listdir(DATA_BASE_PATH)[0]</span>
<span class="n">date</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">))</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rasterize_geoms</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rasterizes geometries (geoms) according to a raster spec (profile).&#39;&#39;&#39;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> 
                                        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])),</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                        <span class="n">default_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="k">def</span> <span class="nf">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask for the study area for a given location&#39;&#39;&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Refer to arable_samples_loc_yr_unique as a global, which is the source of AOI specific metadata here</span>
    <span class="n">study_zone_geom</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">]</span>

    <span class="c1"># Use the EVI2 profile for rasterize op</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">evi2_path</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span>

    <span class="k">return</span> <span class="n">rasterize_geoms</span><span class="p">([</span><span class="n">study_zone_geom</span><span class="p">],</span> <span class="n">evi2_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Define a mask to remove bad pixels (according to Sentinel-2 scene classification):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out &quot;bad&quot; pixels according to the S2 scene classification.&#39;&#39;&#39;</span>
    <span class="n">scl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>

    <span class="n">scl_raw</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scl_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">scl_good_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scl_raw</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># No data</span>
                                       <span class="mi">1</span><span class="p">,</span> <span class="c1"># Saturated/defective pixel</span>
                                       <span class="mi">6</span><span class="p">,</span> <span class="c1"># Water</span>
                                       <span class="mi">9</span><span class="p">,</span> <span class="c1"># Cloud high prob</span>
                                       <span class="mi">11</span><span class="p">])</span> <span class="c1"># Snow or ice</span>

    <span class="k">return</span> <span class="n">scl_good_mask</span>
</pre></div>
</div>
</div>
</div>
<p>Define a mask to identify pixels that are never vegetated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out pixels not labelled as vegetation according to S2 SCL for the entire period.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">not_vegetated_mask</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span>

    <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>
    <span class="n">scl_never_veg</span> <span class="o">=</span> <span class="o">~</span><span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="p">[</span><span class="n">not_vegetated_mask</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">base_path</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">scl_never_veg</span>
</pre></div>
</div>
</div>
</div>
<p>Now get masks based on crop designation. The method was originally applied to spring cereals, so return a spring cereal mask.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_crome_geoms</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads CROME data and converts to geometries on selected land-use codes.&#39;&#39;&#39;</span>
    <span class="n">crome_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crome_path</span><span class="p">)</span>
    
    <span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spring_cereal_geoms</span>


<span class="k">def</span> <span class="nf">get_farmed_area</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads CROME data and calculates the land area used for spring cereal culitvation and also (all types of) agriculture for this tile.&#39;&#39;&#39;</span>
    <span class="n">crome_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crome_path</span><span class="p">)</span>
    
    <span class="n">spring_cereal_area</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">agric_area</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;LG&#39;</span><span class="p">,</span> <span class="s1">&#39;NU&#39;</span><span class="p">,</span> <span class="s1">&#39;TC&#39;</span><span class="p">,</span> <span class="s1">&#39;SR&#39;</span><span class="p">))]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spring_cereal_area</span><span class="p">,</span> <span class="n">agric_area</span>

<span class="k">def</span> <span class="nf">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Gets cereal land-use masks based on CROME data.&#39;&#39;&#39;</span>
    <span class="c1"># For this location get CROME data (constant on a year)</span>
    <span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">get_crome_geoms</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
    
    <span class="c1"># Convert shapes to rasters based on raster profile of an evi2.tif for this location (should all have the same profile)</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">evi2_path</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span>
    
    <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">rasterize_geoms</span><span class="p">(</span><span class="n">spring_cereal_geoms</span><span class="p">,</span> <span class="n">evi2_profile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cereal_mask</span>
</pre></div>
</div>
</div>
</div>
<p>Apply masks to demo datapoint (single date in the timeseries) to show masking effect:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Include the AOI mask and never_veg in the cereal mask for compactness</span>
<span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>

<span class="c1"># Define relevant Xarray variables</span>
<span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">)))</span>
<span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
<span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                 <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                  <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Used chained where condition</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Composite mask&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EVI2&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                               <span class="n">evi2_xr</span><span class="p">,</span> 
                               <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
             <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Masked EVI2&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Visual demo of xarray masking&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a0744b5994054c919f8c20e336262816", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="phenology-and-productivity-parameter-calculations">
<h3>Phenology and productivity parameter calculations<a class="headerlink" href="#phenology-and-productivity-parameter-calculations" title="Permalink to this heading">#</a></h3>
<p>Calculate imagery-derived phenology and productivity parameters for the demo datapoint.</p>
<p>As per <a class="github reference external" href="https://github.com/lewistrotter/PhenoloPy/blob/main/Phenolopy.ipynb">lewistrotter/PhenoloPy</a></p>
<p>Note that Iâ€™ve made a few minor fixes in my local version of the phenolopy module to make the functions play nicely with new xarray and numpy releases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mask the EVI2 dataset</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                                  <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                           <span class="n">evi2_xr</span><span class="p">,</span> 
                                           <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                          <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Just do a bit of xarray preparation</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>

<span class="c1"># Redefine as a dataset</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set resample interval now, as a few functions require it</span>
<span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>

<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
</pre></div>
</div>
</div>
</div>
<p>Amplitude (aos) of the vegetation index id defined as the peak value (max observed in the season) minus the base value (fifth percentile of veg index) and was found to have the strongest correlation with farmer reported yields, alongside peak EVI2 ###CITE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="c1"># plt.title(result.isel(phen_metric=metric)[&#39;phen_metric&#39;].to_numpy().__str__())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Pixelwise amplitude of season&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "15dca1b0c0284ac69563a5022b77eb2c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Now plot the pixel-wise EVI2 time series, as well as the amplitude metric distribution for pixels labelled spring cereals according to CROME.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
<span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
<span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

<span class="c1"># Create 2x2 sub plots</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mf">.15</span><span class="p">,</span> <span class="mf">.85</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> 
<span class="k">for</span> <span class="n">pixel_ref</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="p">[:,</span> <span class="n">pixel_ref</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sample of EVI2 Pixel-Wise Time-Series&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

<span class="n">_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># row 0, col 1</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EVI2 Amplitude Distribution on Spring Cereal Pixels&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "23a6c98df4f04dbc979730a0919d122f", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="extend-process-to-full-imagery-dataset">
<h3>Extend process to full imagery dataset<a class="headerlink" href="#extend-process-to-full-imagery-dataset" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_aos</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns the median evi2 amplitude on spring cereal fields in AOI&#39;&#39;&#39;</span>

    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beginning processing for </span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Get static mask (independent of time) - sometimes there is no geometry to rasterize</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
        <span class="n">spring_cereal_area</span><span class="p">,</span> <span class="n">agric_area</span> <span class="o">=</span> <span class="n">get_farmed_area</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
        <span class="n">spr_cer_per</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">spring_cereal_area</span><span class="o">/</span><span class="n">agric_area</span>
        <span class="k">assert</span> <span class="n">spr_cer_per</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">distributed_print</span><span class="p">((</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="kc">None</span>
        
    

    <span class="c1"># Define relevant Xarray variables</span>
    <span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">)))</span>
    <span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
    <span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                     <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                      <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>




    <span class="c1"># Mask the EVI2 dataset</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                               <span class="n">evi2_xr</span><span class="p">,</span> 
                                               <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                              <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Now for the phenology and productivity calculations</span>
    <span class="c1"># Just do a bit of xarray preparation</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_pval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
    <span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
    <span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done processing </span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">aos_vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aoi_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="ow">and</span> <span class="s1">&#39;metadata.csv&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">aoi_dir</span> <span class="ow">in</span> <span class="n">aoi_dirs</span><span class="p">:</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_aos</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">))</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;median_aos&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;aos_results.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Beginning processing for location_128
(&#39;location_128&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_32
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_32
Beginning processing for location_5
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_5
Beginning processing for location_28
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_28
Beginning processing for location_71
(&#39;location_71&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_108
(&#39;location_108&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_91
(&#39;location_91&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_36
(&#39;location_36&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_161
(&#39;location_161&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_183
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_183
Beginning processing for location_44
(&#39;location_44&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_19
(&#39;location_19&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_65
(&#39;location_65&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_160
(&#39;location_160&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_66
(&#39;location_66&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_111
(&#39;location_111&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_96
(&#39;location_96&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_74
(&#39;location_74&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_177
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_177
Beginning processing for location_4
(&#39;location_4&#39;, ValueError(&#39;operands could not be broadcast together with shapes (401,401) (400,401) &#39;))
Beginning processing for location_22
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_22
Beginning processing for location_73
(&#39;location_73&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_121
(&#39;location_121&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_112
(&#39;location_112&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_163
(&#39;location_163&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_2
(&#39;location_2&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_59
(&#39;location_59&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_64
(&#39;location_64&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_7
(&#39;location_7&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_42
(&#39;location_42&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_31
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_31
Beginning processing for location_145
(&#39;location_145&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_34
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_34
Beginning processing for location_13
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_13
Beginning processing for location_173
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_173
Beginning processing for location_1
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_1
Beginning processing for location_86
(&#39;location_86&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_76
(&#39;location_76&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_176
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_176
Beginning processing for location_118
(&#39;location_118&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_6
(&#39;location_6&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_166
(&#39;location_166&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_125
(&#39;location_125&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_174
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_174
Beginning processing for location_27
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_27
Beginning processing for location_51
(&#39;location_51&#39;, DriverError(&#39;../../../data/Agric_data/PoMS_Locations/location_51/CROME: No such file or directory&#39;))
Beginning processing for location_146
(&#39;location_146&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_47
(&#39;location_47&#39;, DriverError(&#39;../../../data/Agric_data/PoMS_Locations/location_47/CROME: No such file or directory&#39;))
Beginning processing for location_131
(&#39;location_131&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_87
(&#39;location_87&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_54
(&#39;location_54&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_89
(&#39;location_89&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_63
(&#39;location_63&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_180
(&#39;location_180&#39;, AssertionError(&#39;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&#39;))
Beginning processing for location_106
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_106
Beginning processing for location_39
(&#39;location_39&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_75
(&#39;location_75&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_157
(&#39;location_157&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_79
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_79
Beginning processing for location_67
(&#39;location_67&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_10
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_10
Beginning processing for location_94
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_94
Beginning processing for location_110
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_110
Beginning processing for location_162
(&#39;location_162&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_182
(&#39;location_182&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_149
(&#39;location_149&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_25
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_25
Beginning processing for location_138
(&#39;location_138&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
Beginning processing for location_172
(&#39;location_172&#39;, ValueError(&#39;operands could not be broadcast together with shapes (401,401) (400,401) &#39;))
Beginning processing for location_100
Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.

Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.

Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.

Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.

Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
Done processing location_100
Beginning processing for location_122
(&#39;location_122&#39;, ValueError(&#39;No valid geometry objects found for rasterize&#39;))
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aos_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;aos_results.csv&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">aos_vals</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aos_vals</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">aos_vals</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">bee_hoverfly_biodiversity</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">bio_aos</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;median_aos&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>location</th>
      <th>median_aos</th>
      <th>abundance</th>
      <th>species_richness</th>
      <th>shannon_diversity</th>
    </tr>
    <tr>
      <th>location_code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>94</th>
      <td>location_94</td>
      <td>0.271053</td>
      <td>45.0</td>
      <td>24.0</td>
      <td>2.976177</td>
    </tr>
    <tr>
      <th>1</th>
      <td>location_1</td>
      <td>0.290002</td>
      <td>159.0</td>
      <td>35.0</td>
      <td>2.695120</td>
    </tr>
    <tr>
      <th>34</th>
      <td>location_34</td>
      <td>0.309578</td>
      <td>93.0</td>
      <td>27.0</td>
      <td>2.732728</td>
    </tr>
    <tr>
      <th>79</th>
      <td>location_79</td>
      <td>0.360096</td>
      <td>21.0</td>
      <td>9.0</td>
      <td>1.838799</td>
    </tr>
    <tr>
      <th>5</th>
      <td>location_5</td>
      <td>0.400586</td>
      <td>67.0</td>
      <td>25.0</td>
      <td>2.725591</td>
    </tr>
    <tr>
      <th>183</th>
      <td>location_183</td>
      <td>0.412538</td>
      <td>84.0</td>
      <td>30.0</td>
      <td>2.910603</td>
    </tr>
    <tr>
      <th>28</th>
      <td>location_28</td>
      <td>0.443202</td>
      <td>47.0</td>
      <td>18.0</td>
      <td>2.299780</td>
    </tr>
    <tr>
      <th>10</th>
      <td>location_10</td>
      <td>0.466537</td>
      <td>26.0</td>
      <td>15.0</td>
      <td>2.459000</td>
    </tr>
    <tr>
      <th>174</th>
      <td>location_174</td>
      <td>0.484767</td>
      <td>34.0</td>
      <td>17.0</td>
      <td>2.715492</td>
    </tr>
    <tr>
      <th>176</th>
      <td>location_176</td>
      <td>0.504533</td>
      <td>55.0</td>
      <td>23.0</td>
      <td>2.926144</td>
    </tr>
    <tr>
      <th>100</th>
      <td>location_100</td>
      <td>0.518995</td>
      <td>109.0</td>
      <td>25.0</td>
      <td>2.548509</td>
    </tr>
    <tr>
      <th>13</th>
      <td>location_13</td>
      <td>0.532955</td>
      <td>52.0</td>
      <td>16.0</td>
      <td>2.069636</td>
    </tr>
    <tr>
      <th>32</th>
      <td>location_32</td>
      <td>0.567060</td>
      <td>36.0</td>
      <td>16.0</td>
      <td>2.436287</td>
    </tr>
    <tr>
      <th>110</th>
      <td>location_110</td>
      <td>0.569948</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>0.636514</td>
    </tr>
    <tr>
      <th>31</th>
      <td>location_31</td>
      <td>0.574779</td>
      <td>106.0</td>
      <td>25.0</td>
      <td>2.484414</td>
    </tr>
    <tr>
      <th>22</th>
      <td>location_22</td>
      <td>0.589482</td>
      <td>130.0</td>
      <td>39.0</td>
      <td>3.207008</td>
    </tr>
    <tr>
      <th>25</th>
      <td>location_25</td>
      <td>0.594339</td>
      <td>108.0</td>
      <td>29.0</td>
      <td>2.931143</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span> <span class="s1">&#39;shannon_diversity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9a175aee3954430990dcce2ccdfec9df", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span> <span class="s1">&#39;abundance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f6fa630663944f5bac1eae4ab95e4dbd", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span> <span class="s1">&#39;species_richness&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f418e9e7a2c94a2eab58d4b8f25bc63c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;abundance&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PearsonRResult(statistic=-0.05224663057278717, pvalue=0.8421493156067585)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;species_richness&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PearsonRResult(statistic=-0.14325802327965145, pvalue=0.5833352075844004)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;shannon_diversity&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PearsonRResult(statistic=-0.18678552938832535, pvalue=0.4728614046554873)
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20II%29.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Ecological Data Science for Sustainable Agriculture (Part II)</p>
      </div>
    </a>
    <a class="right-next"
       href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20IV%29.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Ecological Data Science for Sustainable Agriculture (Part IV)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data">Biodiversity data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#uk-national-pollinator-monitoring-scheme">UK National Pollinator Monitoring Scheme</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#crome-data">CROME data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-sentinel-2-imagery">Download Sentinel-2 imagery</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spring-cereal-productivity-and-phenology-parameters-from-sentinel-2-images">Spring cereal productivity and phenology parameters from Sentinel-2 images</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phenology-and-productivity-parameter-calculations">Phenology and productivity parameter calculations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extend-process-to-full-imagery-dataset">Extend process to full imagery dataset</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tom Whitehouse
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>