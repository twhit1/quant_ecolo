

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Ecological Data Science for Sustainable Agriculture (Part II) &#8212; Topics in Quantitative Ecology and Beyond</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/Ecological Data Science for Sustainable Agriculture (Part II)';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Ecological Data Science for Sustainable Agriculture (Part III)" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20III%29.html" />
    <link rel="prev" title="Ecological Data Science for Sustainable Agriculture (Part I)" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20I%29.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="Introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">Topics in Quantitative Ecology and Beyond</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Species%20Distribution%20Modelling%20with%20Python.html">Species Distribution Modelling with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20I%29.html">Ecological Data Science for Sustainable Agriculture (Part I)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Ecological Data Science for Sustainable Agriculture (Part II)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20III%29.html">Ecological Data Science for Sustainable Agriculture (Part III)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20IV%29.html">Ecological Data Science for Sustainable Agriculture (Part IV)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hybrid%20Learning%20for%20Species%20Classification%20on%20Image%20Datasets.html">Hybrid Learning for Species Classification on Image Datasets</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/twhit1/quant_ecolo" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/docs/Ecological Data Science for Sustainable Agriculture (Part II).ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Ecological Data Science for Sustainable Agriculture (Part II)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-datapoint-used-for-demo-graphs-and-maps">Set datapoint used for demo graphs and maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data-uk-national-pollinator-monitoring-scheme">Biodiversity data: UK National Pollinator Monitoring Scheme</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agricultural-land-use-data-crome">Agricultural land use data: CROME</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-sentinel-2-imagery">Download Sentinel-2 imagery</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#productivity-and-phenology-parameters-calculations">Productivity and phenology parameters calculations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-for-one-location-and-date">Example for one location and date</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-analysis-for-s2-based-phenology-and-productivity-parameters">Time-series analysis for S2-based phenology and productivity parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-and-conclusions">Discussion and conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="ecological-data-science-for-sustainable-agriculture-part-ii">
<h1>Ecological Data Science for Sustainable Agriculture (Part II)<a class="headerlink" href="#ecological-data-science-for-sustainable-agriculture-part-ii" title="Permalink to this heading">#</a></h1>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vector processing</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">osgb</span>

<span class="c1"># Raster processing</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterio.warp</span>
<span class="kn">import</span> <span class="nn">rasterio.mask</span>
<span class="kn">import</span> <span class="nn">rasterio.plot</span>
<span class="kn">import</span> <span class="nn">rasterio.features</span>
<span class="kn">import</span> <span class="nn">rasterio.sample</span>
<span class="kn">from</span> <span class="nn">rasterio</span> <span class="kn">import</span> <span class="n">windows</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rioxarray</span>

<span class="c1"># Calcs and modelling</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Visualisation</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">cx</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.formatter.limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">FIGSIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

<span class="c1"># Practical</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pystac_client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">DaskClient</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="nb">print</span> <span class="k">as</span> <span class="n">distributed_print</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../../git_packages/PhenoloPy/scripts&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">phenolopy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

<span class="n">DATA_BASE_PATH</span> <span class="o">=</span> <span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/&#39;</span> <span class="c1"># all data under this path (global)</span>
<span class="n">WORKING_CRS</span> <span class="o">=</span> <span class="s1">&#39;EPSG:3035&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>The UK is one of the most nature-depleted countries in the world, with a Biodiversity Intactness Index (BII) within the lowest fifth percentile of countries globally between 1970 and 2014 [1]. The BII is produced by the Natural History Museum in London and captures ecosystem intactness based on the PREDICTS database and an assessment of the impacts of anthropogenic pressures on species abundance and compositional similarity. The UK’s standing marginally increased during this period to finish with the sixth lowest BII of any country globally.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in BII</span>
<span class="n">bii</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../../../data/NHM_BII/resource.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;area_code&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>
<span class="n">bii</span> <span class="o">=</span> <span class="n">bii</span><span class="p">[(</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bii&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;historical&#39;</span><span class="p">)]</span>
<span class="n">bii</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span>

<span class="c1"># Area code map</span>
<span class="n">code_map_bii</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../../../data/NHM_BII/code_maps.json&#39;</span><span class="p">)[[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">]]</span>
<span class="n">code_map_bii</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_map_bii</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">area_codes_bii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code_map_bii</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">area_codes_bii</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">))</span>
<span class="n">bii</span> <span class="o">=</span> <span class="n">bii</span><span class="p">[</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;[A-Za-z]&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span> <span class="c1"># countries only</span>

<span class="c1"># Rank</span>
<span class="n">bii</span><span class="p">[</span><span class="s1">&#39;year_rank_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">bii</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">])[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="s1">&#39;dense&#39;</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">bii</span><span class="p">[</span><span class="s1">&#39;year_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bii</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">])[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="s1">&#39;dense&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">agg_gen_lower</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">agg_gen_upper</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>

<span class="n">agg_funcs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)):</span>
    <span class="n">agg_funcs</span><span class="p">[</span><span class="s1">&#39;lower_quantiles_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">agg_gen_lower</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="n">agg_funcs</span><span class="p">[</span><span class="s1">&#39;upper_quantiles_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">agg_gen_upper</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>

<span class="n">summary_ts</span> <span class="o">=</span> <span class="n">bii</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="o">**</span><span class="n">agg_funcs</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bii</span><span class="p">[</span><span class="n">bii</span><span class="p">[</span><span class="s1">&#39;area_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;001-150-154-GBR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;UK_BII&#39;</span><span class="p">}))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">summary_ts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">summary_ts</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Global median BII&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">summary_ts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">summary_ts</span><span class="p">[</span><span class="s1">&#39;lower_quantiles_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">summary_ts</span><span class="p">[</span><span class="s1">&#39;upper_quantiles_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">summary_ts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">summary_ts</span><span class="p">[</span><span class="s1">&#39;lower_quantiles_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">summary_ts</span><span class="p">[</span><span class="s1">&#39;upper_quantiles_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Global BII distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">summary_ts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">summary_ts</span><span class="p">[</span><span class="s1">&#39;UK_BII&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;UK BII&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">[</span><span class="mf">1.05</span><span class="p">,</span><span class="mf">0.75</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;BII (-)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Historical national-level BII</span><span class="se">\n</span><span class="s1">series compared with UK series&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Latest data shows UK with highest</span><span class="se">\n</span><span class="s1">BII relative to other countries,</span><span class="se">\n</span><span class="s1">but still 6th lowest globally&#39;</span><span class="p">,</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span><span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
             <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8d610ae9d495a3b421891c0b0c87608bfabf4c52be8df37cf273630554a6074a.png" src="../_images/8d610ae9d495a3b421891c0b0c87608bfabf4c52be8df37cf273630554a6074a.png" />
</div>
</div>
<p>Land used for agriculture accounted for 70% of the total area of the UK in 2023 [2]. The intensification of agriculture has, and continues to have negative consequences for biodiversity [3, 4]. Fertiliser inputs are often used to proxy agricultural intensity. Global application of inorganic nitrogen for agricultural use has increased by an order of magnitude in the last 60 years [5].</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fert_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/Global_fertiliser_input/FAOSTAT_data_en_2-20-2024.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span>
<span class="n">fert_series</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)[[</span><span class="s1">&#39;Value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Global Nitrogen Input (tonnes)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/4b956fcdc8d884fb9561214586ff663621e003184359c0e8670a35fcc5f98306.png" src="../_images/4b956fcdc8d884fb9561214586ff663621e003184359c0e8670a35fcc5f98306.png" />
</div>
</div>
<p>Development of a cohesive high-level strategy on the intersection of biodiversity and agriculture can be aided by analysis of multi-scale datasets. This notebook, together with the next in the series, investigates applicability of a method linking remote sensing parameters with biodiversity data [6], to UK pollinator (UK PoMS) and plant monitoring (UK NPMS) survey data.</p>
<p><strong>Objectives</strong></p>
<ol class="arabic simple">
<li><p>Reproduce the method described in [6] from scratch in this Python-based notebook environment.</p></li>
<li><p>Extend that method such that it can be applied to PoMS samples.</p></li>
<li><p>Evaluate whether a significant correlation exists between remote sensing-derived parameters and PoMS biodiversity metrics.</p></li>
</ol>
</section>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this heading">#</a></h2>
<section id="set-datapoint-used-for-demo-graphs-and-maps">
<h3>Set datapoint used for demo graphs and maps<a class="headerlink" href="#set-datapoint-used-for-demo-graphs-and-maps" title="Permalink to this heading">#</a></h3>
<p>This is done retrospectively taking one of the directories generated in the subsequent download process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">location_code</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">aoi_dir</span> <span class="o">=</span> <span class="s1">&#39;location_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location_code</span><span class="p">)</span>
<span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;2019_02_23&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="biodiversity-data-uk-national-pollinator-monitoring-scheme">
<h3>Biodiversity data: UK National Pollinator Monitoring Scheme<a class="headerlink" href="#biodiversity-data-uk-national-pollinator-monitoring-scheme" title="Permalink to this heading">#</a></h3>
<p>The UK Pollinator Monitoring Scheme (PoMS) [7], provides pan-trap records relating to systematic 1 km square surveys at 95 locations across the UK. The squares are visited four times per year for data collection. The UK PoMS is the only scheme in the world to conduct systematic pollinator survey data on pollinator species abundance at a national scale [8].</p>
<p>To align the methodology with [6], select a single year for analysis. Data for 2019 are used, as the sampling rate was highest for this year.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in PoMS data</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../../../data/Agric_data/Pollinator/data/ukpoms_1kmpantrapdata_2017-2020_insects.csv&quot;</span><span class="p">)</span>

<span class="c1"># Set geometry</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_square&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span> <span class="c1"># X1km_square is the SW corner of the 1KM grid cell - so add 500m to centre the reference</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;X1km_centre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">gridder</span><span class="o">.</span><span class="n">parse_grid</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">osgb</span><span class="o">.</span><span class="n">grid_to_ll</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">)</span>

<span class="c1"># Convert to an equal-area projection with units metres - so all the study areas have the same area</span>
<span class="n">insect_data</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Add geometries for study zones (now in working crs)</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">2e3</span><span class="p">)</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># Define study locations</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;location_code&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
<span class="n">locations</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span>

<span class="c1"># Convert types</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Select year</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[(</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2019&#39;</span><span class="p">)]</span> <span class="c1"># 2019 has the most records: insect_data.groupby(&#39;year&#39;)[&#39;count&#39;].sum()</span>

<span class="c1"># Select England (no crop data for other nations in the UK)</span>
<span class="n">insect_data</span> <span class="o">=</span> <span class="n">insect_data</span><span class="p">[</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;England&#39;</span><span class="p">]</span>

<span class="n">insect_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sample_id</th>
      <th>country</th>
      <th>location_code</th>
      <th>location_name</th>
      <th>X1km_square</th>
      <th>date</th>
      <th>year</th>
      <th>pan_trap_station</th>
      <th>occurrence_id</th>
      <th>specimen_code</th>
      <th>taxon_group</th>
      <th>taxon_source</th>
      <th>English_name</th>
      <th>source_taxon_version_key</th>
      <th>taxon_standardised</th>
      <th>taxon_aggregated</th>
      <th>count</th>
      <th>sex</th>
      <th>stage</th>
      <th>comment</th>
      <th>Order</th>
      <th>Family</th>
      <th>geometry</th>
      <th>X1km_centre</th>
      <th>study_zone</th>
      <th>study_zone_bbox</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5358</th>
      <td>5641556</td>
      <td>England</td>
      <td>25</td>
      <td>Conington</td>
      <td>TL3266</td>
      <td>2019-05-13</td>
      <td>2019</td>
      <td>1</td>
      <td>12640765</td>
      <td>3939</td>
      <td>insect - hymenopteran</td>
      <td>Lasioglossum puncticolle</td>
      <td>Ridge-cheeked Furrow Bee</td>
      <td>NHMSYS0000876203</td>
      <td>Lasioglossum puncticolle</td>
      <td>Lasioglossum puncticolle</td>
      <td>1</td>
      <td>female</td>
      <td>adult</td>
      <td></td>
      <td>Hymenoptera</td>
      <td>Halictidae</td>
      <td>POINT (3637007.773 3288593.600)</td>
      <td>TL325665</td>
      <td>POLYGON ((3639007.773 3288593.600, 3638998.143...</td>
      <td>POLYGON ((3639007.773399447 3286593.600411404,...</td>
    </tr>
    <tr>
      <th>5359</th>
      <td>5641566</td>
      <td>England</td>
      <td>25</td>
      <td>Conington</td>
      <td>TL3266</td>
      <td>2019-05-13</td>
      <td>2019</td>
      <td>2</td>
      <td>12640565</td>
      <td>3941</td>
      <td>insect - hymenopteran</td>
      <td>Lasioglossum calceatum</td>
      <td>Slender Mining Bee</td>
      <td>NHMSYS0000876174</td>
      <td>Lasioglossum calceatum</td>
      <td>Lasioglossum calceatum</td>
      <td>1</td>
      <td>female</td>
      <td>adult</td>
      <td></td>
      <td>Hymenoptera</td>
      <td>Halictidae</td>
      <td>POINT (3637007.773 3288593.600)</td>
      <td>TL325665</td>
      <td>POLYGON ((3639007.773 3288593.600, 3638998.143...</td>
      <td>POLYGON ((3639007.773399447 3286593.600411404,...</td>
    </tr>
    <tr>
      <th>5360</th>
      <td>5641566</td>
      <td>England</td>
      <td>25</td>
      <td>Conington</td>
      <td>TL3266</td>
      <td>2019-05-13</td>
      <td>2019</td>
      <td>2</td>
      <td>12640566</td>
      <td>3942</td>
      <td>insect - hymenopteran</td>
      <td>Lasioglossum malachurum</td>
      <td>Sharp-collared Furrow Bee</td>
      <td>NBNSYS0100003670</td>
      <td>Lasioglossum malachurum</td>
      <td>Lasioglossum malachurum</td>
      <td>1</td>
      <td>female</td>
      <td>adult</td>
      <td></td>
      <td>Hymenoptera</td>
      <td>Halictidae</td>
      <td>POINT (3637007.773 3288593.600)</td>
      <td>TL325665</td>
      <td>POLYGON ((3639007.773 3288593.600, 3638998.143...</td>
      <td>POLYGON ((3639007.773399447 3286593.600411404,...</td>
    </tr>
    <tr>
      <th>5361</th>
      <td>5641566</td>
      <td>England</td>
      <td>25</td>
      <td>Conington</td>
      <td>TL3266</td>
      <td>2019-05-13</td>
      <td>2019</td>
      <td>2</td>
      <td>12640567</td>
      <td>3943</td>
      <td>insect - hymenopteran</td>
      <td>Lasioglossum calceatum</td>
      <td>Slender Mining Bee</td>
      <td>NHMSYS0000876174</td>
      <td>Lasioglossum calceatum</td>
      <td>Lasioglossum calceatum</td>
      <td>1</td>
      <td>female</td>
      <td>adult</td>
      <td></td>
      <td>Hymenoptera</td>
      <td>Halictidae</td>
      <td>POINT (3637007.773 3288593.600)</td>
      <td>TL325665</td>
      <td>POLYGON ((3639007.773 3288593.600, 3638998.143...</td>
      <td>POLYGON ((3639007.773399447 3286593.600411404,...</td>
    </tr>
    <tr>
      <th>5362</th>
      <td>5641566</td>
      <td>England</td>
      <td>25</td>
      <td>Conington</td>
      <td>TL3266</td>
      <td>2019-05-13</td>
      <td>2019</td>
      <td>2</td>
      <td>12640568</td>
      <td>3944</td>
      <td>insect - hymenopteran</td>
      <td>Lasioglossum calceatum</td>
      <td>Slender Mining Bee</td>
      <td>NHMSYS0000876174</td>
      <td>Lasioglossum calceatum</td>
      <td>Lasioglossum calceatum</td>
      <td>1</td>
      <td>female</td>
      <td>adult</td>
      <td></td>
      <td>Hymenoptera</td>
      <td>Halictidae</td>
      <td>POINT (3637007.773 3288593.600)</td>
      <td>TL325665</td>
      <td>POLYGON ((3639007.773 3288593.600, 3638998.143...</td>
      <td>POLYGON ((3639007.773399447 3286593.600411404,...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Calculate biodiversity metrics for each location, pooling over sampling rounds, again to align with [6]:</p>
<ul class="simple">
<li><p>Species richness: the number of unique species observed</p></li>
<li><p>Total abundance: sum of all individuals from all species</p></li>
</ul>
<p>The sampling rate varied between locations. This is due to a varying number of location visits, and a varying number of pan traps used per visit. To ensure comparability across sampling locations, biodiversity metrics are scaled accordingly: abundance is scaled to the number of pan trap samples taken, and species richness is scaled according to a rarefaction function [9]. This produces expected biodiversity metrics based on a single pan-trap sample at each location.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bee_hoverfly_metrics</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculates PoMS biodiversity metrics (abundances and species richness).</span>
<span class="sd">    </span>
<span class="sd">    Includes adjustment for variable sampling rate at locations, correcting to 1-pantrap equivalent metrics.&#39;&#39;&#39;</span>
    <span class="n">unique_species</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;taxon_aggregated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">s_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_species</span><span class="p">)</span> <span class="c1"># number of unique species found at this location</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;pan_trap_station&#39;</span><span class="p">]))</span> <span class="c1"># number of sampling stations across dates (equal weight)</span>
    <span class="n">n_i</span> <span class="o">=</span> <span class="n">group</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;pan_trap_station&#39;</span><span class="p">,</span> <span class="s1">&#39;taxon_aggregated&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()[</span><span class="s1">&#39;taxon_aggregated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="c1"># number of sampling locations where each species is found </span>
    
    <span class="n">e_s_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_i</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># expected species richness based on one pantrap station</span>
    <span class="n">abundance_1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">*</span>  <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="c1"># expected abundance based on one pantrap station</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;abundance_1&#39;</span><span class="p">:</span> <span class="n">abundance_1</span><span class="p">,</span> <span class="s1">&#39;species_richness_1&#39;</span><span class="p">:</span> <span class="n">e_s_1</span><span class="p">})</span>


<span class="n">bee_hoverfly_biodiversity</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location_code&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">bee_hoverfly_metrics</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">bee_hoverfly_biodiversity</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Single Pan-Trap Equivalent Biodiversity Metrics Distributions&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/9af0527d50d1a50c5204e396883e615e4d19a58363fe82799382a5a318a50335.png" src="../_images/9af0527d50d1a50c5204e396883e615e4d19a58363fe82799382a5a318a50335.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">insect_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cadetblue&#39;</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">insect_data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">PositronNoLabels</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of selected PoMS study sites&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/07d99c67f049cdcb6618bf220b52b4b88e48ecdaaa7403ebdf12424ae4fad064.png" src="../_images/07d99c67f049cdcb6618bf220b52b4b88e48ecdaaa7403ebdf12424ae4fad064.png" />
</div>
</div>
</section>
<section id="agricultural-land-use-data-crome">
<h3>Agricultural land use data: CROME<a class="headerlink" href="#agricultural-land-use-data-crome" title="Permalink to this heading">#</a></h3>
<p>Spring cereal fields were used for the study on which this notebook is based [6]. Here, the Crop Map of England (CROME) [10] was used to identify spring cereal fields based on agricultural land use codes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SPRING_CEREAL_LUCODES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AC01&#39;</span><span class="p">,</span> <span class="c1"># barley</span>
                         <span class="s1">&#39;AC19&#39;</span><span class="p">,</span> <span class="c1"># oats</span>
                         <span class="s1">&#39;AC24&#39;</span><span class="p">,</span> <span class="c1"># rye</span>
                         <span class="s1">&#39;AC30&#39;</span><span class="p">,</span> <span class="c1"># triticale</span>
                         <span class="s1">&#39;AC32&#39;</span><span class="p">]</span> <span class="c1"># wheat</span>
</pre></div>
</div>
</div>
</div>
<p>For the purposes of estimating agricultural intensity in the vicinity of each sampling location, I consider a circle of radius 2km centred on the sampling location.</p>
<p>This represents an adaptation of the methodology described in [6], which analyses only the four Sentinel-2 pixels at the centre of each field used for biodiversity surveys. Implementing such a constraint on the PoMS dataset cuts the sample size significantly. Given that pollinators are relatively mobile, a larger study area was chosen here; honey bees regularly travel the chosen radius (2km) to forage, and have been observed as far as 10km from the hive [11].</p>
<p>An example study location (with surrounding CROME spring cereal cells) is shown below; CROME data is published on a hex grid (resolution ~40m side length).</p>
<p>Note that the CROME data for each of these locations is downloaded outside of this script, see <a class="github reference external" href="https://github.com/twhit1/quant_ecolo/blob/dev/docs/get_crome_2019.sh">twhit1/quant_ecolo</a>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">location_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/PoMS_Locations/</span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">/CROME&#39;</span>

<span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">location_path</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">insect_data</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    
<span class="c1"># filter for spring cereals</span>
<span class="n">crome_data</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span>
<span class="n">sc_cells_in_radius</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">insect_data</span><span class="p">[</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">crome_data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">insect_data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">OpenStreetMap</span><span class="o">.</span><span class="n">Mapnik</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">insect_data</span><span class="p">[</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">insect_data</span><span class="p">[</span><span class="n">insect_data</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Study area boundary and centroid&#39;</span><span class="p">)</span>
<span class="n">sc_cells_in_radius</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spring cereals in range of study location&#39;</span><span class="p">)</span>

<span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Spring cereals 2019 (CROME)&quot;</span><span class="p">),</span>
                  <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Spring cereals in range of study location&quot;</span><span class="p">)]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>  <span class="n">legend_handles</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PoMS location </span><span class="si">{}</span><span class="s1"> study area with surrounding spring cereal crop cover (CROME)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location_code</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/5a1bf9bdd5c42c9e74492a93fd32ff48916fd4685962d1a8024905a999baa03c.png" src="../_images/5a1bf9bdd5c42c9e74492a93fd32ff48916fd4685962d1a8024905a999baa03c.png" />
</div>
</div>
</section>
<section id="download-sentinel-2-imagery">
<h3>Download Sentinel-2 imagery<a class="headerlink" href="#download-sentinel-2-imagery" title="Permalink to this heading">#</a></h3>
<p>For each PoMS location, the 2019 timeseries of Sentinel-2 crops (thematic maps, visual and vegetation index inputs) is downloaded.</p>
<p>Expand the cell below to see the methodology.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_pystack_aws_sessions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Initiates a pystac client and rasterio AWS session to coordinate requests.&#39;&#39;&#39;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;https://earth-search.aws.element84.com/v1&quot;</span><span class="p">)</span>
    <span class="n">aws_session</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">AWSSession</span><span class="p">(</span><span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(),</span> <span class="n">requester_pays</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">client</span><span class="p">,</span> <span class="n">aws_session</span>

<span class="k">def</span> <span class="nf">read_S3</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads the data and metadata corresponding to an acquisition, based on a </span>
<span class="sd">    reference and spatial filter (defined as a shapely bbox in EPSG:4326).&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">href</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Transform window to src crs</span>
        <span class="n">transform_geodetic_to_s2</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">src_bbox</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform_geodetic_to_s2</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span><span class="o">*</span><span class="n">conform_bbox</span><span class="p">(</span><span class="n">src_bbox</span><span class="p">),</span>
                                              <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span><span class="o">.</span><span class="n">round_lengths</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> 
        <span class="n">src_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">src_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                            <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src_profile</span><span class="p">}</span>
    
<span class="k">def</span> <span class="nf">get_geodetic_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">bbox_crs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Transforms a bounding box (as a shapely box) in a given CRS to EPSG:4326&#39;&#39;&#39;</span>
    <span class="c1"># Get transformer for bbox</span>
    <span class="n">transform_working_to_geodetic</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">bbox_crs</span><span class="p">),</span> 
                                                                <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">),</span> 
                                                                <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>
    <span class="c1"># Get transformed bbox (in EPSG:4326)</span>
    <span class="n">bbox_geodetic_coords</span> <span class="o">=</span> <span class="n">transform_working_to_geodetic</span><span class="p">(</span><span class="o">*</span><span class="n">bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
    <span class="n">bbox_geodetic</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">bbox_geodetic_coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">bbox_geodetic</span>

<span class="k">def</span> <span class="nf">conform_bbox</span><span class="p">(</span><span class="n">shapely_bbox</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns coords as left, bottom, right, top from a shapely box.</span>
<span class="sd">    </span>
<span class="sd">    This is a utility function to go between shapely and (rasterio and pystac)&#39;&#39;&#39;</span>
    <span class="n">shapely_bbox_coords</span> <span class="o">=</span> <span class="n">shapely_bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">rio_stac_bbox_coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="c1"># Align shapely and pystac conventions</span>
                             <span class="nb">min</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                             <span class="nb">max</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                             <span class="nb">max</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            
    <span class="k">return</span> <span class="n">rio_stac_bbox_coords</span>
    
<span class="k">def</span> <span class="nf">search_stac</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;searchs a stac collection with using client, filtering based on aoi_bbox_geodetic</span>
<span class="sd">    (a shapely box in EPSG:4326), and based on datetime. See pystac docs for client.search </span>
<span class="sd">    API details.</span>

<span class="sd">    Note that pystac client expands datetimes, i.e. from the docs &quot;2017 </span>
<span class="sd">    expands to 2017-01-01T00:00:00Z/2017-12-31T23:59:59Z&quot;.</span>
<span class="sd">    </span>
<span class="sd">    query examples:</span>
<span class="sd">      filter on processing baseline (see https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/processing-baseline)</span>
<span class="sd">        query = {&#39;s2:processing_baseline&#39;: {&quot;neq&quot;: &quot;05.00&quot;}}</span>

<span class="sd">      filter on cloud cloverage</span>
<span class="sd">        query=[&#39;eo:cloud_cover&lt;50&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span> 
    <span class="n">search</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">max_items</span><span class="o">=</span><span class="n">max_items</span><span class="p">,</span> <span class="c1"># speed up</span>
                           <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sentinel-2-l2a&#39;</span><span class="p">],</span>
                           <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                           <span class="n">bbox</span><span class="o">=</span><span class="n">conform_bbox</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">),</span>
                           <span class="n">datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">matched</span><span class="p">()</span> <span class="o">==</span> <span class="n">max_items</span><span class="p">:</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="s1">&#39;Did not receive complete results. Consider increasing max_items kwarg &#39;</span> <span class="o">+</span> \
          <span class="sa">f</span><span class="s1">&#39;(currently </span><span class="si">{</span><span class="n">max_items</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">search</span>


<span class="k">def</span> <span class="nf">item_covers_aoi</span><span class="p">(</span><span class="n">stac_item</span><span class="p">,</span> <span class="n">aoi_geodetic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns true/false depending on whether the acquisition geometry fully covers the</span>
<span class="sd">    AOI.&#39;&#39;&#39;</span>
    
    <span class="k">return</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stac_item</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">aoi_geodetic</span><span class="p">)</span>

<span class="c1"># Filter on clouds</span>
<span class="k">def</span> <span class="nf">pass_clouds_snow</span><span class="p">(</span><span class="n">scl_data</span><span class="p">,</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns true/false depending on whether the area proportion of the acquisition which</span>
<span class="sd">    is cloudy (according to the S2 cloud detection algorithm) is less than max_cloud_perc.</span>
<span class="sd">    </span>
<span class="sd">    Also includes snow/ice (SCL code 11).&#39;&#39;&#39;</span>
    <span class="n">medium_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">high_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
    <span class="n">snow_ice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">medium_cloud_prob</span> <span class="o">+</span> <span class="n">high_cloud_prob</span> <span class="o">+</span> <span class="n">snow_ice</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">scl_data</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">max_cloud_perc</span>

<span class="k">def</span> <span class="nf">clean_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Clears up directories if download is re-run.&#39;&#39;&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Cleaning (removing) </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">calculate_evi2</span><span class="p">(</span><span class="n">nir_data</span><span class="p">,</span> <span class="n">red_data</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns the vegetation index EVI2 and corresponding raster profile.&#39;&#39;&#39;</span>
    <span class="n">QUANT_VAL</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># Need this because EVI2 has a constant in the denominator (so scale matters) - for many S2 indices the quantification value cancels</span>
    <span class="c1"># Calculate evi2</span>
    <span class="n">evi2</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">nir_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">red_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">nir_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.4</span><span class="o">*</span><span class="p">(</span><span class="n">red_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">profile</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">}}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">evi2</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">evi2_profile</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">get_reprojected_profile</span><span class="p">(</span><span class="n">src_profile</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculates necessary changes to an arbritary source profile (a dictionary</span>
<span class="sd">    based on a rasterio read) to write to a target CRS or target width, height.</span>
<span class="sd">    </span>
<span class="sd">    Note that the rasterio method to do this is not ideal; open issue here</span>
<span class="sd">    https://github.com/rasterio/rasterio/issues/3009&#39;&#39;&#39;</span>
    <span class="n">transformer</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">AffineTransformer</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">])</span> 
    <span class="n">left</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
    <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get default transform</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">calculate_default_transform</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span> 
                                                                            <span class="n">target_crs</span><span class="p">,</span> 
                                                                            <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> 
                                                                            <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> 
                                                                            <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span>
                                                                            <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span>
                                                                            <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
                                                                            <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span>
                                                                            <span class="n">dst_width</span><span class="o">=</span><span class="n">target_width</span><span class="p">,</span>
                                                                            <span class="n">dst_height</span><span class="o">=</span><span class="n">target_height</span><span class="p">,</span>
                                                                            <span class="n">dst_resolution</span><span class="o">=</span><span class="n">target_res</span><span class="p">)</span>

    <span class="c1"># Update profile with new crs, transform and dimensions</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">aligned_target</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">target_res</span><span class="p">)</span>
    
    <span class="n">new_profile</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src_profile</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">new_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">target_crs</span><span class="p">,</span>
                        <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">new_profile</span>
    
<span class="k">def</span> <span class="nf">trim_raster</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Overwrites to_trim_path, trimming to (shapely) geometry defined in same CRS as raster.&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">masked_transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="n">geometry</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
        
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">masked_transform</span><span class="p">})</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">reproject_clip_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">source_profile</span><span class="p">,</span> <span class="n">target_profile</span><span class="p">,</span> <span class="n">full_write_path</span><span class="p">,</span> <span class="n">aoi_geometry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reprojects S2 data to working CRS and writes to disk, clipping to AOI geometry.&#39;&#39;&#39;</span>
    <span class="n">target_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">],</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">],</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]})</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">full_write_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">target_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">target_profile</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                    <span class="n">src_transform</span><span class="o">=</span><span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                    <span class="n">src_crs</span><span class="o">=</span><span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span>
                                    <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>

    <span class="n">trim_raster</span><span class="p">(</span><span class="n">full_write_path</span><span class="p">,</span> <span class="n">aoi_geometry</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_download_errors</span><span class="p">(</span><span class="n">_download_items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Decorator to skip over errors, printing details to display for investigation later&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">log_and_skip_errors</span><span class="p">(</span><span class="n">_dir_name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_download_items</span><span class="p">(</span><span class="n">_dir_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">_dir_name</span><span class="si">}</span><span class="s1"> :: ERROR (skipping) &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">log_and_skip_errors</span>

<span class="c1"># Some constants / global scope objects</span>
<span class="n">band_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">]</span> <span class="c1"># S2 bands to be downloaded</span>
<span class="n">MAX_ITEMS</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># Max items returned by the each STAC server request (this is in a 1 year period)</span>
<span class="n">max_cloud_perc</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Max allowable cloud / snow pixels</span>
<span class="n">client</span><span class="p">,</span> <span class="n">aws_session</span> <span class="o">=</span> <span class="n">get_pystack_aws_sessions</span><span class="p">()</span>

<span class="nd">@handle_download_errors</span>
<span class="k">def</span> <span class="nf">download_items</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads S2 data for a given PoMS location. dir_name contains the CROME data for the location (preprocessed).&#39;&#39;&#39;</span>
    <span class="n">location_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dir_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Starting location processing&#39;</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>

    <span class="c1"># # Skip this location if it was already processed</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)):</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1"> :: Already processed, skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="c1"># Get search results</span>
    <span class="n">true_aoi_bbox</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">location_code</span><span class="p">][</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="c1"># in projected coords</span>
    <span class="c1"># buffer this by a pixel so that there are no missing corners in the data download (this can happen because of reprojections and finite resolution imagery)</span>
    <span class="n">aoi_bbox</span> <span class="o">=</span> <span class="n">true_aoi_bbox</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">aoi_bbox_geodetic</span> <span class="o">=</span> <span class="n">get_geodetic_bbox</span><span class="p">(</span><span class="n">aoi_bbox</span><span class="p">,</span> <span class="n">locations</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span> <span class="c1"># in EPSG:4326</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="n">search_stac</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="o">=</span><span class="n">aoi_bbox_geodetic</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="s1">&#39;2019&#39;</span><span class="p">,</span> 
                                 <span class="n">max_items</span><span class="o">=</span><span class="n">MAX_ITEMS</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;s2:processing_baseline&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;neq&quot;</span><span class="p">:</span> <span class="s2">&quot;05.00&quot;</span><span class="p">}})</span> <span class="c1"># Sentinel 2 reprocessing has not completed for 2019</span>

    <span class="c1"># Now iterate through dates with S2 acquisitions and download if they&#39;re good enough (intersect PoMS location fully and not too many clouds)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">search_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Store date reference</span>
        <span class="n">date_ref</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">base_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">date_ref</span><span class="p">)</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Starting acquisition processing&#39;</span><span class="p">)</span> 
        
        <span class="c1"># If there is already a folder here and it contains the right number of files, consider this date to be processed and skip</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Already have correct number of files, skipping&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Require full coverage of the AOI</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item_covers_aoi</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">):</span>
            <span class="k">continue</span>
            
        <span class="c1"># Next a cloud check</span>
        <span class="n">s2_thematic</span> <span class="o">=</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_clouds_snow</span><span class="p">(</span><span class="n">s2_thematic</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="n">max_cloud_perc</span><span class="p">):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Too cloudy/snowy, skipping (more than </span><span class="si">{</span><span class="n">max_cloud_perc</span><span class="si">}</span><span class="s1">% of image medium or high cloud probability / snowy)&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># At this point we&#39;ll download the imagery, so create write directory if it does not already exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clean_dir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
            
        <span class="c1"># Read data from S3 - already calculated scl so just add that to the dictionary instead of redownloading</span>
        <span class="n">band_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">band_name</span><span class="p">:</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="n">band_name</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span> <span class="k">for</span> <span class="n">band_name</span> <span class="ow">in</span> <span class="n">band_names</span><span class="p">}</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2_thematic</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;evi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_evi2</span><span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="c1"># Vegetation index</span>
                                           <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                           <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Define a target profile, which each raster will be aligned with</span>
        <span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">])</span>
        <span class="n">target_res</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">target_profile</span> <span class="o">=</span> <span class="n">get_reprojected_profile</span><span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">],</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="n">target_width</span><span class="p">,</span> 
                                                 <span class="n">target_height</span><span class="o">=</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_res</span><span class="o">=</span><span class="n">target_res</span><span class="p">)</span>

        <span class="c1"># Write results, reprojecting everything into WORKING_CRS and trimming to the AOI bbox</span>
        <span class="k">for</span> <span class="n">band_name</span><span class="p">,</span> <span class="n">data_profile</span> <span class="ow">in</span> <span class="n">band_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">,</span> <span class="n">band_name</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
            <span class="n">reproject_clip_write</span><span class="p">(</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">],</span> <span class="n">target_profile</span><span class="p">,</span> <span class="n">full_write_path</span><span class="p">,</span> <span class="n">true_aoi_bbox</span><span class="p">)</span> <span class="c1"># clip to true aoi bbox</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">, Date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> band: </span><span class="si">{</span><span class="n">band_name</span><span class="si">}</span><span class="s1"> :: Written to </span><span class="si">{</span><span class="n">full_write_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="c1"># Now create a file to hold any metadata we may want to add and also signals completion of this location&#39;s download            </span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;touch&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)])</span>
    
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">aws_session</span><span class="p">):</span>
    <span class="n">dask_client</span> <span class="o">=</span> <span class="n">DaskClient</span><span class="p">(</span><span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">):</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">dask_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">download_items</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
    
    <span class="n">dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The resulting data set for one location, on one date looks like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Colormap as defined at https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/ndvi/</span>
<span class="n">edvi_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-1.0 $\leq$ EDVI $\leq$ -0.5&#39;</span><span class="p">,</span>
               <span class="s1">&#39;-0.5 &lt; EDVI $\leq$ 0.0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.0 &lt; EDVI $\leq$ 0.1&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.1 &lt; EDVI $\leq$ 0.2&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.2 &lt; EDVI $\leq$ 0.3&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.3 &lt; EDVI $\leq$ 0.4&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.4 &lt; EDVI $\leq$ 0.5&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.5 &lt; EDVI $\leq$ 0.6&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.6 &lt; EDVI $\leq$ 1.0&#39;</span>
              <span class="p">]</span>

<span class="n">edvi_ranges_nums</span> <span class="o">=</span>  <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                    <span class="mf">0.1</span><span class="p">,</span>
                                    <span class="mf">0.2</span><span class="p">,</span>
                                    <span class="mf">0.3</span><span class="p">,</span>
                                    <span class="mf">0.4</span><span class="p">,</span>
                                    <span class="mf">0.5</span><span class="p">,</span>
                                    <span class="mf">0.6</span><span class="p">,</span>
                                    <span class="mf">1.0</span><span class="p">]</span>
<span class="n">edvi_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">234</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">234</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">204</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">130</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">145</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">81</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">112</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">63</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">79</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">45</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">28</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]]</span>


<span class="c1"># Color mapping for the scene classification</span>
<span class="c1"># Color map as described at https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/scene-classification/</span>

<span class="n">classification_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Dark features/Shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Vegetation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Not-vegetated&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Water (dark and bright)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Unclassified&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud medium probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud high probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Thin cirrus&#39;</span><span class="p">]</span>

<span class="n">classification_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">90</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">]]]</span>

<span class="n">scl_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;SCL map&#39;</span><span class="p">,</span> <span class="n">classification_colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">))</span>
<span class="n">scl_thematic_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">,</span> 
                                                                                        <span class="n">classification_names</span><span class="p">)]</span>
<span class="n">scl_norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">([</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">)],</span> <span class="n">scl_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>



<span class="n">edvi_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;EDVI map&#39;</span><span class="p">,</span> <span class="n">edvi_colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edvi_colors</span><span class="p">))</span>
<span class="n">edvi_thematic_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edvi_colors</span><span class="p">,</span> <span class="n">edvi_ranges</span><span class="p">)]</span>
<span class="n">edvi_norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">edvi_ranges_nums</span><span class="p">,</span> <span class="n">edvi_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>



<span class="n">views</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2&#39;</span><span class="p">,</span> <span class="s1">&#39;scl&#39;</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sentinel-2 RGB and study zone&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-2 Red&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-2 NIR&#39;</span><span class="p">,</span> <span class="s1">&#39;Computed EVI2&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-2 SCL&#39;</span><span class="p">]</span>
<span class="n">norms</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">PowerNorm</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">edvi_norm</span><span class="p">,</span> <span class="n">scl_norm</span><span class="p">]</span>
<span class="n">cmaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">edvi_cmap</span><span class="p">,</span> <span class="n">scl_cmap</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">views</span><span class="p">):</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">view</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;location_</span><span class="si">{</span><span class="n">location_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">view</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">data_profile</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">}</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">view</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">]:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10000</span> <span class="c1"># Quantification value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
                   <span class="n">norm</span><span class="o">=</span><span class="n">norms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
                   <span class="n">extent</span><span class="o">=</span><span class="n">extent</span>
                  <span class="p">)</span>

    <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span>
        <span class="n">locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">location_code</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PoMS study area centroid&#39;</span><span class="p">)</span>
        <span class="n">locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">location_code</span><span class="p">]][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;study zone&#39;</span><span class="p">,</span> 
                                                               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;scl&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scl_thematic_map</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;evi2&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">edvi_thematic_map</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        

<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sentinel-2 and EVI2 rasters for PoMS location </span><span class="si">{}</span><span class="s1"> on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location_code</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d0c8f47a2e82dbd5af4cd0c7d270834c14bbd4d87b58ef8865d9f4f8effdd17e.png" src="../_images/d0c8f47a2e82dbd5af4cd0c7d270834c14bbd4d87b58ef8865d9f4f8effdd17e.png" />
</div>
</div>
</section>
<section id="productivity-and-phenology-parameters-calculations">
<h3>Productivity and phenology parameters calculations<a class="headerlink" href="#productivity-and-phenology-parameters-calculations" title="Permalink to this heading">#</a></h3>
<p>Before executing a productivity and phenology analysis based on Sentinel-2 imagery, a mask to remove “bad” pixels is defined.</p>
<p>In this section, the process is demonstrated for one example location, before looping through all PoMS localities.</p>
<p>Note that in place of the more frequently used NDVI index, the authors of [6] use the EVI2 index as a vegetation index, citing deficiencies with NDVI in relation to this use case.</p>
<br />
$$
  EVI2 = 2.5*\frac{NIR - RED}{NIR + 2.4*RED + 1}
$$
<br />
<section id="example-for-one-location-and-date">
<h4>Example for one location and date<a class="headerlink" href="#example-for-one-location-and-date" title="Permalink to this heading">#</a></h4>
<p>Define a mask to select only the study area from a raster:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rasterize_geoms</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rasterizes geometries (geoms) according to a raster spec (profile).&#39;&#39;&#39;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> 
                                        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])),</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                        <span class="n">default_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="k">def</span> <span class="nf">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask for the study area for a given location&#39;&#39;&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Refer to arable_samples_loc_yr_unique as a global, which is the source of AOI specific metadata here</span>
    <span class="n">study_zone_geom</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">]</span>

    <span class="c1"># Use the EVI2 profile for rasterize op</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">evi2_path</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span>

    <span class="k">return</span> <span class="n">rasterize_geoms</span><span class="p">([</span><span class="n">study_zone_geom</span><span class="p">],</span> <span class="n">evi2_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Define a mask to remove bad pixels (according to Sentinel-2 scene classification):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out &quot;bad&quot; pixels according to the S2 scene classification.&#39;&#39;&#39;</span>
    <span class="n">scl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>
    <span class="n">scl_raw</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scl_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scl_good_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scl_raw</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># No data</span>
                                       <span class="mi">1</span><span class="p">,</span> <span class="c1"># Saturated/defective pixel</span>
                                       <span class="mi">6</span><span class="p">,</span> <span class="c1"># Water</span>
                                       <span class="mi">9</span><span class="p">,</span> <span class="c1"># Cloud high prob</span>
                                       <span class="mi">11</span><span class="p">])</span> <span class="c1"># Snow or ice</span>

    <span class="k">return</span> <span class="n">scl_good_mask</span>
</pre></div>
</div>
</div>
</div>
<p>Define a mask to identify pixels that are never vegetated according to the Sentinel-2 scene classification map:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out pixels not labelled as vegetation according to S2 SCL for the entire period.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">not_vegetated_mask</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span>

    <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>
    <span class="n">scl_never_veg</span> <span class="o">=</span> <span class="o">~</span><span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="p">[</span><span class="n">not_vegetated_mask</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">base_path</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">scl_never_veg</span>
</pre></div>
</div>
</div>
</div>
<p>Now get masks based on CROME crop designation. The method was originally applied to spring cereals [6], so return a spring cereal mask.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_crome_series</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a geometry series of CROME spring cereals and agricultural land for a given location.&#39;&#39;&#39;</span>
    <span class="n">crome_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crome_path</span><span class="p">)</span>
    <span class="n">crome_sc_series</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span>
    <span class="n">crome_ag_series</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;LG&#39;</span><span class="p">,</span> <span class="s1">&#39;NU&#39;</span><span class="p">,</span> <span class="s1">&#39;TC&#39;</span><span class="p">,</span> <span class="s1">&#39;SR&#39;</span><span class="p">))]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span>
    
    <span class="k">return</span> <span class="n">crome_sc_series</span><span class="p">,</span> <span class="n">crome_ag_series</span>


<span class="k">def</span> <span class="nf">get_farmed_area</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads CROME data and calculates the land area used for spring cereal culitvation and also (all types of) agriculture for this tile.&#39;&#39;&#39;</span>
    <span class="n">spring_cereals</span><span class="p">,</span> <span class="n">ag_series</span> <span class="o">=</span> <span class="n">get_crome_sc_series</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
    <span class="n">spring_cereal_area</span> <span class="o">=</span> <span class="n">spring_cereals</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">agric_area</span> <span class="o">=</span> <span class="n">ag_series</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spring_cereal_area</span><span class="p">,</span> <span class="n">agric_area</span>

<span class="k">def</span> <span class="nf">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Gets cereal land-use masks based on CROME data.&#39;&#39;&#39;</span>
    <span class="c1"># For this location get CROME data (constant on a year)</span>
    <span class="n">spring_cereal_geoms</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_crome_series</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="c1"># Convert shapes to rasters based on raster profile of an evi2.tif for this location (should all have the same profile)</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">evi2_path</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span>

    <span class="c1"># Generate spring cereal mask</span>
    <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">rasterize_geoms</span><span class="p">(</span><span class="n">spring_cereal_geoms</span><span class="p">,</span> <span class="n">evi2_profile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cereal_mask</span>
</pre></div>
</div>
</div>
</div>
<p>Apply masks to demo datapoint (single date in the timeseries) to show masking effect. Note that the composite mask is an intersection between the spring cereal mask, the study area mask and the Sentinel-2 scene classification mask (not never vegetated).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Include the AOI mask and never_veg in the cereal mask for compactness</span>
<span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>

<span class="c1"># Define relevant Xarray variables</span>
<span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">)))</span>
<span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
<span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                 <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                  <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>

<span class="c1"># Masks at a given timestep are then given as</span>
<span class="c1"># xr.where(cereal_mask, xr.where(good_scl_masks_xr, 1, 0), 0).isel(time=0)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Used chained where condition</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Composite mask&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EVI2&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                               <span class="n">evi2_xr</span><span class="p">,</span> 
                               <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
             <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Masked EVI2&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;EVI2 masking for PoMS location </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">date</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e27a2797270df474b2f803216da2b0519683e0e86deeafb221b29ec793aeac05.png" src="../_images/e27a2797270df474b2f803216da2b0519683e0e86deeafb221b29ec793aeac05.png" />
</div>
</div>
</section>
<section id="time-series-analysis-for-s2-based-phenology-and-productivity-parameters">
<h4>Time-series analysis for S2-based phenology and productivity parameters<a class="headerlink" href="#time-series-analysis-for-s2-based-phenology-and-productivity-parameters" title="Permalink to this heading">#</a></h4>
<p>It is now possible to calculate phenology and productivity parameters, based on the timeseries of masked vegetation indices.</p>
<p>The following shows the approach for a single PoMS location, using Python distributions of Xarray, and PhenoloPy. The analysis process shown here follows a PhenoloPy tutorial for a similar use case [12].</p>
<p>Note that several minor fixes to my local PhenoloPy functions were necessary for usage with the newer Xarray and NumPy releases used in this environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mask the EVI2 dataset</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                                  <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                           <span class="n">evi2_xr</span><span class="p">,</span> 
                                           <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                          <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Just do a bit of xarray preparation</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>

<span class="c1"># Redefine as a dataset</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Now for the productivity/phenology calculation routine:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Group dataset interval: month via reducer: median
&gt; Selecting year: 2019 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set resample interval now, as a few functions require it</span>
<span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
</pre></div>
</div>
</div>
</div>
<p>Amplitude of Season (AOS) of the vegetation index is defined as the peak value (max observed in the season) minus the base value (fifth percentile of vegetation index) and was found to have the strongest correlation with farmer reported yields and biodiversity metrics, alongside peak EVI2 [6].</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Pixelwise amplitude of season on spring cereals </span><span class="se">\n</span><span class="s2"> for PoMS location </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">date</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f4591eaa2539a1c82e855ad1050a8ad39c54bada7413ae2f25d8dfc3dbbb20ac.png" src="../_images/f4591eaa2539a1c82e855ad1050a8ad39c54bada7413ae2f25d8dfc3dbbb20ac.png" />
</div>
</div>
<p>With reference to the EVI2 timeseries and amplitude distributions for pixels labelled spring cereal according to CROME, the pixel-wise EVI2 time series for this location clearly shows that despite a bimodal amplitude distribution, the majority of pixels exhibit a similar peak in the early summer period.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
<span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
<span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

<span class="c1"># Create 2x2 sub plots</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mf">.15</span><span class="p">,</span> <span class="mf">.85</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> 
<span class="k">for</span> <span class="n">pixel_ref</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="p">[:,</span> <span class="n">pixel_ref</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sample of EVI2 pixel-wise time-series&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;EVI2 value&#39;</span><span class="p">)</span>

<span class="n">_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># row 0, col 1</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EVI2 amplitude distribution on spring cereal pixels&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;EVI2 amplitude&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;PoMS location </span><span class="si">{}</span><span class="s2"> crop phenology and productivity&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/3a4c1780c64f93dba98c42d872fefea05b51f1dfbc0209ad875a10cc59cc8d03.png" src="../_images/3a4c1780c64f93dba98c42d872fefea05b51f1dfbc0209ad875a10cc59cc8d03.png" />
</div>
</div>
<p>The above method is now applied to the remaining PoMS locations, and the median AOS across all spring cereal pixels is recorded for each site.</p>
<p>Expand the cell below for the implementation.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_aos</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns the median evi2 amplitude on spring cereal fields in AOI&#39;&#39;&#39;</span>
    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beginning processing for </span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get static mask (independent of time) - sometimes there is no geometry to rasterize</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
        <span class="n">spring_cereal_area</span><span class="p">,</span> <span class="n">agric_area</span> <span class="o">=</span> <span class="n">get_farmed_area</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
        <span class="n">spr_cer_per</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">spring_cereal_area</span><span class="o">/</span><span class="n">agric_area</span>
        <span class="k">assert</span> <span class="n">spr_cer_per</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Spring cereal fields as percentage of farmed area less than threshold (5%), skipping&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">distributed_print</span><span class="p">((</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="kc">None</span>
        
    <span class="c1"># Define relevant Xarray variables</span>
    <span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">)))</span>
    <span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
    <span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                     <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                      <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>

    <span class="c1"># Mask the EVI2 dataset</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                               <span class="n">evi2_xr</span><span class="p">,</span> 
                                               <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                              <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Now for the phenology and productivity calculations</span>
    <span class="c1"># Just do a bit of xarray preparation</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_pval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
    <span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
    <span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done processing </span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">aos_vals</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aoi_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="ow">and</span> <span class="s1">&#39;metadata.csv&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">aoi_dir</span> <span class="ow">in</span> <span class="n">aoi_dirs</span><span class="p">:</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_aos</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">))</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;median_aos&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;aos_results.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this heading">#</a></h2>
<p>Comparing the Sentinel-2 derived median AOS figures against modelled biodiversity metrics, no significant correlation is observed for either abundance or species richness. This contrasts with the findings of [6], in which significant correlations were reported for biodiversity metrics (and farmer reported yields, not analysed here), and is discussed in the following section.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aos_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;aos_results.csv&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">aos_vals</span><span class="p">[</span><span class="s1">&#39;location_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aos_vals</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">aos_vals</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location_code&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bio_aos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">bee_hoverfly_biodiversity</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">bio_aos</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;median_aos&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>location</th>
      <th>median_aos</th>
      <th>abundance_1</th>
      <th>species_richness_1</th>
    </tr>
    <tr>
      <th>location_code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>94</th>
      <td>location_94</td>
      <td>0.271053</td>
      <td>3.461538</td>
      <td>2.538462</td>
    </tr>
    <tr>
      <th>1</th>
      <td>location_1</td>
      <td>0.290002</td>
      <td>8.833333</td>
      <td>4.166667</td>
    </tr>
    <tr>
      <th>34</th>
      <td>location_34</td>
      <td>0.309578</td>
      <td>5.166667</td>
      <td>3.444444</td>
    </tr>
    <tr>
      <th>79</th>
      <td>location_79</td>
      <td>0.360096</td>
      <td>2.333333</td>
      <td>1.777778</td>
    </tr>
    <tr>
      <th>5</th>
      <td>location_5</td>
      <td>0.400586</td>
      <td>4.187500</td>
      <td>2.750000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;abundance_1&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">bio_aos</span><span class="p">,</span><span class="n">fit_reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;species_richness_1&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">bio_aos</span><span class="p">,</span><span class="n">fit_reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.27</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s1">&#39;PearsonR:: stat: </span><span class="si">{}</span><span class="s1">, pval: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;abundance_1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                                              <span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;abundance_1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.27</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;PearsonR:: stat: </span><span class="si">{}</span><span class="s1">, pval: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;species_richness_1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                                              <span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">bio_aos</span><span class="p">[</span><span class="s1">&#39;species_richness_1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Scatter plots of biodiversity variables and median EVI2 amplitude figures&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/5b07c3af47254b9d774f690030ba452b1123371f9dc1254acafa83c8f8ba0284.png" src="../_images/5b07c3af47254b9d774f690030ba452b1123371f9dc1254acafa83c8f8ba0284.png" />
</div>
</div>
</section>
<section id="discussion-and-conclusions">
<h2>Discussion and conclusions<a class="headerlink" href="#discussion-and-conclusions" title="Permalink to this heading">#</a></h2>
<p>As observed in the results section, a significant correlation between Sentinel-2 derived productivity parameters and pollinator biodiversity metrics as observed by the authors of [6] was not reproduced in this study. There are a number of possible explanations for this result, which are discussed in this section.</p>
<p>The methodology applied in this study constitutes an adaptation of that presented in [6], for use with the PoMS dataset, as described in the methodology section. Notably, Sentinel-2 derived parameters are calculated on a 2km radius zone around the PoMS study location here; therefore aiming to proxy agricultural intensity in the surrounding area for each PoMS location, instead of taking the immediate vicinity as in the original study [6]. The assumptions are that firstly pollinators are mobile within a distance greater than the study area use here, and secondly, surrounding spring cereal remote sensing-derived productivity parameters can effectively proxy agricultural intensity and hence would correlate (negatively) with biodiversity metrics.</p>
<p>Assessing the reliability of the first of those assumptions in further detail is out of the scope of this study, though the literature would suggest that is is not unreasonable (as discussed earlier in the methodology).</p>
<p>On the second assumption, it is possible that correlations observed at small spatial scales as in [6] do not translate to statistics based on the surrounding area at each PoMS location, the effects being too weak to discernibly influence biodiversity metrics. Indeed spring cereal fields represent just one element of the agricultural environment surrounding each PoMS sampling location. Combined with a relatively small sample size, and limitations with the resolution of the CROME dataset which causes Sentinel-2 grid pixels to be incorrectly labelled spring cereal on resampling, it would be incorrect to call into question the repeatability of the methodology presented in [6] based on the findings documented in this notebook.</p>
<p>Further research should focus on the following topics:</p>
<ol class="arabic simple">
<li><p>Derivation of remote sensing agricultural intensity proxies based on other crop types, which would allow greater generalisation of the type of analysis explored here.</p></li>
<li><p>Direct comparison of remote sensing derived parameters against agricultural intensity data for broader validation of the methodology: for instance, large-scale spatial datasets of artificial agricultural input rates exist (though are not open access), see the UKCEH’s “Land Cover plus: Fertilisers and Pesticides” product as an example.</p></li>
<li><p>Replication of the methodology presented in this notebook, maintaining greater fidelity to that presented by the authors of [6], particularly in relation to spatial scales.</p></li>
</ol>
<p>The next notebook in this series will focus on the third point, performing a similar analysis on much smaller study locations, which is possible because of the larger pool of sampling locations used for the UK’s National Plant Monitoring Scheme.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Phillips H, De Palma A, Gonzalez RE, Contu S et al. The Biodiversity Intactness Index - Country, Region and Global-Level Summaries for the Year 1970 to 2050 Under Various Scenarios (Data set). Natural History Museum. <a class="reference external" href="https://doi.org/10.5519/he1eqmg1">https://doi.org/10.5519/he1eqmg1</a></p></li>
<li><p>UK Department for Environment, Food and Rural Affairs (DEFRA). Agricultural Land Use in United Kingdom at 1 June 2023. Updated 14 December 2023. UK GOV website. <a class="reference external" href="https://www.gov.uk/government/statistics/agricultural-land-use-in-the-united-kingdom">https://www.gov.uk/government/statistics/agricultural-land-use-in-the-united-kingdom</a>.</p></li>
<li><p>Reidsma P, Tekelenburg T, van der Berg M, Alkemade R. Impacts of Land-Use Change on Biodiversity: An Assessment of Agricultural Biodiversity in the European Union. Agriculture, Ecosystems &amp; Environment. 2006; 144(1): 86-102. <a class="reference external" href="https://doi.org/10.1016/j.agee.2005.11.026">https://doi.org/10.1016/j.agee.2005.11.026</a>.</p></li>
<li><p>Robinson RA and Sutherland WJ. Post-war Changes in Arable Farming and Biodiversity in Great Britain. Journal of Applied Ecology. 2002. 39(1): 157-176. <a class="reference external" href="https://doi.org/10.1046/j.1365-2664.2002.00695.x">https://doi.org/10.1046/j.1365-2664.2002.00695.x</a>.</p></li>
<li><p>Food and Agriculture Organization of the United Nations. Land, Inputs and Sustainability / Fertilizers by Nutrient. <a class="reference external" href="https://www.fao.org/faostat/en/#data/RFN">https://www.fao.org/faostat/en/#data/RFN</a>.</p></li>
<li><p>Abdi AM, Carrié R, Sidemo-Holm W, Cai Z, Boke-Olén N, Smith HG, Eklundh L, Ekroos J, Biodiversity Decline With Increasing Crop Productivity in Agricultural Fields Revealed by Satellite Remote Sensing. Ecological Indicators. 2021; 130():108098. <a class="reference external" href="https://doi.org/10.1016/j.ecolind.2021.108098">https://doi.org/10.1016/j.ecolind.2021.108098</a>.</p></li>
<li><p>UK Pollinator Monitoring Scheme (2022). Pan-Trap Survey Data From the UK Pollinator Monitoring Scheme, 2017-2020 version 2 NERC EDS Environmental Information Data Centre. <a class="reference external" href="https://doi.org/10.5285/2c43ba3c-d821-442c-989b-754451d72091">https://doi.org/10.5285/2c43ba3c-d821-442c-989b-754451d72091</a>.</p></li>
<li><p>UK-SCAPE (UK Centre for Ecology and Hydrology). UK Pollinator Monitoring Scheme. <a class="reference external" href="https://uk-scape.ceh.ac.uk/our-science/projects/PoMS">https://uk-scape.ceh.ac.uk/our-science/projects/PoMS</a>. [Accessed 20/02/2024].</p></li>
<li><p>Koellner T, Hersperger AM and Wohlgemuth T. Rarefaction Method for Assessing Plant Species Diversity on a Regional Scale. Ecography. 2004. 27(1): 532-544. <a class="reference external" href="https://doi.org/10.1111/j.0906-7590.2004.03832.x">https://doi.org/10.1111/j.0906-7590.2004.03832.x</a>.</p></li>
<li><p>UK Rural Payments Agency (RPA). Crop Map of England (CROME), 2019. Licence: <a class="reference external" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/</a>.</p></li>
<li><p>Ribbands CR.The Flight Range of the Honey-Bee. Journal of Animal Ecology. 1951. 20(2); 220–226. <a class="reference external" href="https://doi.org/10.2307/1541">https://doi.org/10.2307/1541</a>.</p></li>
<li><p>Trotter L. PhenoloPy Tutorial. <a class="github reference external" href="https://github.com/lewistrotter/PhenoloPy/blob/main/Phenolopy.ipynb">lewistrotter/PhenoloPy</a>.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20I%29.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Ecological Data Science for Sustainable Agriculture (Part I)</p>
      </div>
    </a>
    <a class="right-next"
       href="Ecological%20Data%20Science%20for%20Sustainable%20Agriculture%20%28Part%20III%29.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Ecological Data Science for Sustainable Agriculture (Part III)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-datapoint-used-for-demo-graphs-and-maps">Set datapoint used for demo graphs and maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data-uk-national-pollinator-monitoring-scheme">Biodiversity data: UK National Pollinator Monitoring Scheme</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agricultural-land-use-data-crome">Agricultural land use data: CROME</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-sentinel-2-imagery">Download Sentinel-2 imagery</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#productivity-and-phenology-parameters-calculations">Productivity and phenology parameters calculations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-for-one-location-and-date">Example for one location and date</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-analysis-for-s2-based-phenology-and-productivity-parameters">Time-series analysis for S2-based phenology and productivity parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-and-conclusions">Discussion and conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tom Whitehouse
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>