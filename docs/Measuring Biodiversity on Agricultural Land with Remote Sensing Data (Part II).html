

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part II) &#8212; Data Science for Ecology and Beyond</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part II)';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Assessing Spatial Patterns of Agricultural Pesticide Use and Risks to Pollinator Populations" href="Assessing%20Spatial%20Patterns%20of%20Agricultural%20Pesticide%20Use%20and%20Risks%20to%20Pollinator%20Populations.html" />
    <link rel="prev" title="Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part I)" href="Measuring%20Biodiversity%20on%20Agricultural%20Land%20with%20Remote%20Sensing%20Data%20%28Part%20I%29.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="Introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">Data Science for Ecology and Beyond</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Species%20Distribution%20Modelling%20with%20Python.html">Species Distribution Modelling with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="Earth%20Observation%20Data%20with%20Python%20and%20SpatioTemporal%20Asset%20Catalogs%20%28STACs%29.html">Earth Observation Data with Python and SpatioTemporal Asset Catalogs (STACs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Measuring%20Biodiversity%20on%20Agricultural%20Land%20with%20Remote%20Sensing%20Data%20%28Part%20I%29.html">Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part I)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part II)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assessing%20Spatial%20Patterns%20of%20Agricultural%20Pesticide%20Use%20and%20Risks%20to%20Pollinator%20Populations.html">Assessing Spatial Patterns of Agricultural Pesticide Use and Risks to Pollinator Populations</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hybrid%20Learning%20for%20Species%20Classification%20on%20Image%20Datasets.html">Hybrid Learning for Species Classification on Image Datasets</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/twhit1/quant_ecolo" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/docs/Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part II).ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part II)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-datapoint-used-for-demo-graphs-and-maps">Set datapoint used for demo graphs and maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data-uk-national-plant-monitoring-scheme">Biodiversity data: UK National Plant Monitoring Scheme</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agricultural-land-use-data-crome">Agricultural land use data: CROME</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-sentinel-2-imagery">Download Sentinel-2 imagery</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#productivity-and-phenology-parameters-calculations">Productivity and phenology parameters calculations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-for-one-location-and-date">Example for one location and date</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-analysis-for-s2-based-phenology-and-productivity-parameters">Time-series analysis for S2-based phenology and productivity parameters</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data-post-processing">Biodiversity data post-processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cover-calculations">Cover calculations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#abundance">Abundance</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#species-richness">Species richness</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shannon-diversity">Shannon diversity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-and-conclusions">Discussion and conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="measuring-biodiversity-on-agricultural-land-with-remote-sensing-data-part-ii">
<h1>Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part II)<a class="headerlink" href="#measuring-biodiversity-on-agricultural-land-with-remote-sensing-data-part-ii" title="Permalink to this heading">#</a></h1>
<p><strong>Published: 14/05/2024</strong></p>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vector processing</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">osgb</span>

<span class="c1"># Raster processing</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterio.warp</span>
<span class="kn">import</span> <span class="nn">rasterio.mask</span>
<span class="kn">import</span> <span class="nn">rasterio.plot</span>
<span class="kn">import</span> <span class="nn">rasterio.features</span>
<span class="kn">import</span> <span class="nn">rasterio.sample</span>
<span class="kn">from</span> <span class="nn">rasterio</span> <span class="kn">import</span> <span class="n">windows</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rioxarray</span>

<span class="c1"># Calcs and modelling</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Visualisation</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">cx</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.formatter.limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">FIGSIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

<span class="c1"># Practical</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pystac_client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">DaskClient</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="nb">print</span> <span class="k">as</span> <span class="n">distributed_print</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../../git_packages/PhenoloPy/scripts&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">phenolopy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

<span class="n">DATA_BASE_PATH</span> <span class="o">=</span> <span class="s1">&#39;../../../data/Agric_data/NPMS_Locations/&#39;</span> <span class="c1"># all data under this path (global)</span>
<span class="n">WORKING_CRS</span> <span class="o">=</span> <span class="s1">&#39;EPSG:3035&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>In the previous article, a method linking remote sensing parameters on agricultural land to biodiversity survey data [1] was adapted to UK Pollinator Monitoring Scheme (PoMS) data. In order to retain sufficient PoMS sampling locations whilst ensuring proximity to fields used for spring cereal cultivation in the chosen survey year (2019), quite a large study area around each PoMS location was adopted. This potentially has the effect of weakening correlations between small-scale biodiversity metrics and larger-scale agricultural intensity proxies. Whilst the authors of [1] did find significant correlations between biodiversity and remote sensing-derived measurements, those correlations were not observed using the adapted method presented in the last notebook. Amongst the conclusions was the concept that the adapted study area was likely too large to maintain a possible relationship between the measured variables.</p>
<p>Here, that conclusion is explored by applying a very similar process as presented before to a different biodiversity dataset, the UK National Plant Monitoring Scheme (NPMS). The authors of [1] also found significant correlations between biodiversity metrics for vascular plants and agricultural intensity parameters, and the greater quantity of NPMS sampling locations (compared to the PoMS dataset) means that a much smaller study area can be used. This enables a higher-fidelity reproduction of the original methodology, whilst retaining a reasonable sample size.</p>
<p><strong>Objectives</strong>
The objectives are the same as those laid out in the last article, this time applied to NPMS data:</p>
<ol class="arabic simple">
<li><p>Reproduce the method described in [1] from scratch in this Python-based notebook environment.</p></li>
<li><p>Extend that method such that it can be applied to NPMS samples.</p></li>
<li><p>Evaluate whether a significant correlation exists between remote sensing-derived parameters and NPMS biodiversity metrics.</p></li>
</ol>
</section>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this heading">#</a></h2>
<section id="set-datapoint-used-for-demo-graphs-and-maps">
<h3>Set datapoint used for demo graphs and maps<a class="headerlink" href="#set-datapoint-used-for-demo-graphs-and-maps" title="Permalink to this heading">#</a></h3>
<p>This is done retrospectively taking one of the directories generated in the subsequent download process.</p>
<p>Expand the cell below to show the code snippet.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select an AOI with data</span>
<span class="n">aoi_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;metadata.csv&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">)))]</span>
<span class="n">aoi_dir</span> <span class="o">=</span> <span class="n">aoi_dirs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># Construct location code from path</span>
<span class="n">location_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Select one date&#39;s data for that AOI</span>
<span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">))</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span> <span class="c1"># Just date directories</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span>

<span class="c1"># Construct full path</span>
<span class="n">aoi_date_download_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="biodiversity-data-uk-national-plant-monitoring-scheme">
<h3>Biodiversity data: UK National Plant Monitoring Scheme<a class="headerlink" href="#biodiversity-data-uk-national-plant-monitoring-scheme" title="Permalink to this heading">#</a></h3>
<p>The NPMS is a national-scale plant monitoring survey in which volunteers visit randomly allocated locations and record plant observations in around five plots at each location, amounting to typically thousands of locations surveyed each year [2]. The data was downloaded from the UK CEH Environmental Information Data Centre and is read in a preprocessed below [3].</p>
<p>Locations at which sensitive species were found are dropped because geolocation data was spatially blurred by the NPMS for these observations, which would make the remainder of the process here invalid. These records correspond to less than 1% of the dataset.</p>
<p>Note that some of the post-processing of biodiversity data is done in the results section, per site in the filtered dataset, which is more efficient than calculating metrics on the entire dataset here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">########################################################################</span>
<span class="c1"># Read in occurrences</span>
<span class="n">occurrences</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/Plant/data/occurrences_2015to2022.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

<span class="c1"># Drop spatially blurred observations</span>
<span class="n">occurrences</span> <span class="o">=</span> <span class="n">occurrences</span><span class="p">[</span><span class="n">occurrences</span><span class="p">[</span><span class="s1">&#39;sensitivity_precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sensitivity_precision&#39;</span><span class="p">,</span><span class="s1">&#39;record_status&#39;</span><span class="p">])</span>
<span class="c1">########################################################################</span>


<span class="c1">########################################################################</span>
<span class="c1"># Read in sample data </span>
<span class="n">_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/Plant/data/sampleinfowithlatlong_2015to2022.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;location_id&#39;</span><span class="p">:</span><span class="s1">&#39;Int64&#39;</span><span class="p">})</span>
<span class="n">sample_info</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">_temp</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="o">.</span><span class="n">from_xy</span><span class="p">(</span><span class="n">_temp</span><span class="p">[</span><span class="s1">&#39;LONGITUDE&#39;</span><span class="p">],</span> <span class="n">_temp</span><span class="p">[</span><span class="s1">&#39;LATITUDE&#39;</span><span class="p">]),</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
<span class="n">sample_info</span> <span class="o">=</span> <span class="n">sample_info</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span>
<span class="n">sample_info</span><span class="p">[</span><span class="s1">&#39;date_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s1">&#39;date_start&#39;</span><span class="p">])</span>
<span class="n">sample_info</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_info</span><span class="p">[</span><span class="s1">&#39;date_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>

<span class="c1"># Define study regions for data download later</span>
<span class="n">buffer_radius</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sample_info</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_info</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_radius</span><span class="p">)</span>
<span class="n">sample_info</span><span class="p">[</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="c1">########################################################################</span>


<span class="c1">########################################################################</span>
<span class="c1"># Read in sample attributes </span>
<span class="n">sample_attributes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../../data/Agric_data/Plant/data/sampleattributes_2015to2022.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;sample_attribute_id&#39;</span><span class="p">)</span>

<span class="c1"># Get samples which are tagged with arable agriculture attributes</span>
<span class="n">arable_samples</span> <span class="o">=</span> <span class="n">sample_attributes</span><span class="p">[(</span><span class="n">sample_attributes</span><span class="p">[</span><span class="s1">&#39;caption&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NPMS Habitat&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sample_attributes</span><span class="p">[</span><span class="s1">&#39;text_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Arable field margins&#39;</span><span class="p">,</span> <span class="s1">&#39;Arable margins&#39;</span><span class="p">])]</span>
<span class="c1">########################################################################</span>
</pre></div>
</div>
</div>
</div>
<p>To arrive at a set of study locations to download satellite imagery and agricultural land use data for, the sample data is filtered, keeping locations with arable attribute tags, and years for which agricultural land use data is available, and dropping duplicates:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arable_samples_loc_yr_unique</span> <span class="o">=</span> <span class="n">sample_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">arable_samples</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()][[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;date_start&#39;</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">,</span> <span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">,</span> <span class="s1">&#39;survey_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;date_start&#39;</span><span class="p">])</span>
<span class="n">arable_samples_loc_yr_unique</span> <span class="o">=</span> <span class="n">arable_samples_loc_yr_unique</span><span class="p">[(</span><span class="n">arable_samples_loc_yr_unique</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2020</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2018</span><span class="p">)]</span>
<span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>year</th>
      <th>date_start</th>
      <th>study_zone</th>
      <th>study_zone_bbox</th>
      <th>survey_id</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2459716</th>
      <td>POINT (3347328.898 3112656.417)</td>
      <td>2018</td>
      <td>2018-05-18</td>
      <td>POLYGON ((3347428.898 3112656.417, 3347428.417...</td>
      <td>POLYGON ((3347428.8984529204 3112556.417126075...</td>
      <td>87</td>
    </tr>
    <tr>
      <th>3374584</th>
      <td>POINT (3613310.248 3353483.205)</td>
      <td>2018</td>
      <td>2018-04-01</td>
      <td>POLYGON ((3613410.248 3353483.205, 3613409.767...</td>
      <td>POLYGON ((3613410.2482128586 3353383.205378609...</td>
      <td>155</td>
    </tr>
    <tr>
      <th>3425299</th>
      <td>POINT (3587828.892 3171514.315)</td>
      <td>2018</td>
      <td>2018-04-22</td>
      <td>POLYGON ((3587928.892 3171514.315, 3587928.410...</td>
      <td>POLYGON ((3587928.8916301527 3171414.315482463...</td>
      <td>154</td>
    </tr>
    <tr>
      <th>3432713</th>
      <td>POINT (3509784.399 3428080.153)</td>
      <td>2018</td>
      <td>2018-04-23</td>
      <td>POLYGON ((3509884.399 3428080.153, 3509883.918...</td>
      <td>POLYGON ((3509884.399378102 3427980.153094661,...</td>
      <td>154</td>
    </tr>
    <tr>
      <th>3440706</th>
      <td>POINT (3436618.076 2977607.276)</td>
      <td>2018</td>
      <td>2018-04-29</td>
      <td>POLYGON ((3436718.076 2977607.276, 3436717.594...</td>
      <td>POLYGON ((3436718.075516487 2977507.276026127,...</td>
      <td>154</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">aoi_dirs</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cadetblue&#39;</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">PositronNoLabels</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of selected NPMS study sites&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/eed3c2c619f4bd3a80bd8661470b848282f99f1c63c24e01ba503afd86231295.png" src="../_images/eed3c2c619f4bd3a80bd8661470b848282f99f1c63c24e01ba503afd86231295.png" />
</div>
</div>
</section>
<section id="agricultural-land-use-data-crome">
<h3>Agricultural land use data: CROME<a class="headerlink" href="#agricultural-land-use-data-crome" title="Permalink to this heading">#</a></h3>
<p>This subsection is largely identical to that presented in the last article.</p>
<p>Spring cereal fields were used for the study on which this notebook is based [1]. Here, the Crop Map of England (CROME) [4] was used to identify spring cereal fields based on agricultural land use codes.</p>
<p>CROME data was downloaded for each location, for years corresponding to the NPMS sampling dates (note that CROME designations are constant within each year).</p>
<p>The CROME download is handled outside of this script, see <a class="github reference external" href="https://github.com/twhit1/quant_ecolo/blob/dev/docs/get_crome_2019.sh">twhit1/quant_ecolo</a> as an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SPRING_CEREAL_LUCODES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AC01&#39;</span><span class="p">,</span> <span class="c1"># barley</span>
                         <span class="s1">&#39;AC19&#39;</span><span class="p">,</span> <span class="c1"># oats</span>
                         <span class="s1">&#39;AC24&#39;</span><span class="p">,</span> <span class="c1"># rye</span>
                         <span class="s1">&#39;AC30&#39;</span><span class="p">,</span> <span class="c1"># triticale</span>
                         <span class="s1">&#39;AC32&#39;</span><span class="p">]</span> <span class="c1"># wheat</span>
</pre></div>
</div>
</div>
</div>
<p>Locations have already been filtered for those marked “arable (field) margins” by NPMS volunteers, and here are further filtered for locations in proximity of spring cereals.</p>
<p>Specifically, a minimum of three CROME cells labelled “spring cereal” intersecting a 100 metre radius of the NPMS sampling location is required. The study area size was determined by trial and error, by minimizing the study area whilst retaining sufficient sampling locations. This was done by repeatedly running the following code snippet with different study areas and recording the count of remaining NPMS locations (not shown here).</p>
<p>Compared to the previous notebook which used a circle of radius 2km, the study area used here is significantly closer to that used in the original study [1], which consisted of four Sentinel-2 pixels at the center of the field in which biodiversity survey data was collected. Requiring at least three CROME cells in proximity to the NPMS sampling locations ensures a significant presence of agricultural cereal cropping activity in the vicinity (CROME data is defined on a ~40m side-length hex grid).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc_aoi_dirs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># correspond to NPMS sample IDs</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">location_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">))):</span>
    <span class="c1"># Read in agricultural land use data</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">location_path</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span>

    <span class="c1"># Datapoint references</span>
    <span class="n">aoi_dir</span> <span class="o">=</span> <span class="n">location_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Check spring cereal intersection</span>
    <span class="n">sc_cells_in_radius</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">])]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sc_cells_in_radius</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">sc_aoi_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>An example study location (with surrounding CROME spring cereal cells) is shown below.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">location_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/NPMS_Locations/</span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">/CROME&#39;</span>
<span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">location_path</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    
<span class="c1"># filter for spring cereals</span>
<span class="n">crome_data</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span>
<span class="n">sc_cells_in_radius</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">location_code</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">])]</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">crome_data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">cx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">OpenStreetMap</span><span class="o">.</span><span class="n">Mapnik</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">location_code</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">location_code</span><span class="p">]][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Study area boundary and centroid&#39;</span><span class="p">)</span>
<span class="n">sc_cells_in_radius</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spring cereals in range of study location&#39;</span><span class="p">)</span>



<span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Spring cereals </span><span class="si">{</span><span class="n">location_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (CROME)&quot;</span><span class="p">),</span>
                  <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Spring cereals in range of study location&quot;</span><span class="p">)]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>  <span class="n">legend_handles</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Example selected NPMS study location with surrounding spring cereal crop cover&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f1158a9b5ca4c2ff853a084c878237d92a60077ad4233e8f4b539336d2df0084.png" src="../_images/f1158a9b5ca4c2ff853a084c878237d92a60077ad4233e8f4b539336d2df0084.png" />
</div>
</div>
</section>
<section id="download-sentinel-2-imagery">
<h3>Download Sentinel-2 imagery<a class="headerlink" href="#download-sentinel-2-imagery" title="Permalink to this heading">#</a></h3>
<p>For each NPMS location and survey year, the corresponding Sentinel-2 crops (thematic maps, visual and vegetation index inputs) is downloaded.</p>
<p>Expand the cell below to see the methodology.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_pystack_aws_sessions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Initiates a pystac client and rasterio AWS session to coordinate requests.&#39;&#39;&#39;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;https://earth-search.aws.element84.com/v1&quot;</span><span class="p">)</span>
    <span class="n">aws_session</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">AWSSession</span><span class="p">(</span><span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(),</span> <span class="n">requester_pays</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">client</span><span class="p">,</span> <span class="n">aws_session</span>


<span class="k">def</span> <span class="nf">read_S3</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads the data and metadata corresponding to an acquisition, based on a </span>
<span class="sd">    reference and spatial filter (defined as a shapely bbox in EPSG:4326).&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">href</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Transform window to src crs</span>
        <span class="n">transform_geodetic_to_s2</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">src_bbox</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform_geodetic_to_s2</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span><span class="o">*</span><span class="n">conform_bbox</span><span class="p">(</span><span class="n">src_bbox</span><span class="p">),</span>
                                              <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span><span class="o">.</span><span class="n">round_lengths</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> 
        <span class="n">src_profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">src_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                            <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)})</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src_profile</span><span class="p">}</span>
    
<span class="k">def</span> <span class="nf">get_geodetic_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">bbox_crs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Transforms a bounding box (as a shapely box) in a given CRS to EPSG:4326&#39;&#39;&#39;</span>
    <span class="c1"># Get transformer for bbox</span>
    <span class="n">transform_working_to_geodetic</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">bbox_crs</span><span class="p">),</span> 
                                                                <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">),</span> 
                                                                <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span>
    <span class="c1"># Get transformed bbox (in EPSG:4326)</span>
    <span class="n">bbox_geodetic_coords</span> <span class="o">=</span> <span class="n">transform_working_to_geodetic</span><span class="p">(</span><span class="o">*</span><span class="n">bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
    <span class="n">bbox_geodetic</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">bbox_geodetic_coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">bbox_geodetic</span>

<span class="k">def</span> <span class="nf">conform_bbox</span><span class="p">(</span><span class="n">shapely_bbox</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns coords as left, bottom, right, top from a shapely box.</span>
<span class="sd">    </span>
<span class="sd">    This is a utility function to go between shapely and (rasterio and pystac)&#39;&#39;&#39;</span>
    <span class="n">shapely_bbox_coords</span> <span class="o">=</span> <span class="n">shapely_bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">rio_stac_bbox_coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="c1"># Align shapely and pystac conventions</span>
                             <span class="nb">min</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                             <span class="nb">max</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                             <span class="nb">max</span><span class="p">(</span><span class="n">shapely_bbox_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            
    <span class="k">return</span> <span class="n">rio_stac_bbox_coords</span>
    
<span class="k">def</span> <span class="nf">search_stac</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;searchs a stac collection with using client, filtering based on aoi_bbox_geodetic</span>
<span class="sd">    (a shapely box in EPSG:4326), and based on datetime. See pystac docs for client.search </span>
<span class="sd">    API details.</span>

<span class="sd">    Note that pystac client expands datetimes, i.e. from the docs &quot;2017 </span>
<span class="sd">    expands to 2017-01-01T00:00:00Z/2017-12-31T23:59:59Z&quot;.</span>
<span class="sd">    </span>
<span class="sd">    query examples:</span>
<span class="sd">      filter on processing baseline (see https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/processing-baseline)</span>
<span class="sd">        query = {&#39;s2:processing_baseline&#39;: {&quot;neq&quot;: &quot;05.00&quot;}}</span>

<span class="sd">      filter on cloud cloverage</span>
<span class="sd">        query=[&#39;eo:cloud_cover&lt;50&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">max_items</span><span class="o">=</span><span class="n">max_items</span><span class="p">,</span> <span class="c1"># speed up</span>
                           <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sentinel-2-l2a&#39;</span><span class="p">],</span>
                           <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                           <span class="n">bbox</span><span class="o">=</span><span class="n">conform_bbox</span><span class="p">(</span><span class="n">aoi_bbox_geodetic</span><span class="p">),</span>
                           <span class="n">datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">matched</span><span class="p">()</span> <span class="o">==</span> <span class="n">max_items</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Did not receive complete results. Consider increasing max_items kwarg &#39;</span> <span class="o">+</span> \
          <span class="sa">f</span><span class="s1">&#39;(currently </span><span class="si">{</span><span class="n">max_items</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">search</span>


<span class="k">def</span> <span class="nf">item_covers_aoi</span><span class="p">(</span><span class="n">stac_item</span><span class="p">,</span> <span class="n">aoi_geodetic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns true/false depending on whether the acquisition geometry fully covers the</span>
<span class="sd">    AOI.&#39;&#39;&#39;</span>
    
    <span class="k">return</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stac_item</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">aoi_geodetic</span><span class="p">)</span>

<span class="c1"># Filter on clouds</span>
<span class="k">def</span> <span class="nf">pass_clouds_snow</span><span class="p">(</span><span class="n">scl_data</span><span class="p">,</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns true/false depending on whether the area proportion of the acquisition which</span>
<span class="sd">    is cloudy (according to the S2 cloud detection algorithm) is less than max_cloud_perc.</span>
<span class="sd">    </span>
<span class="sd">    Also includes snow/ice (SCL code 11).&#39;&#39;&#39;</span>
    <span class="n">medium_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">high_cloud_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
    <span class="n">snow_ice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl_data</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">((</span><span class="n">medium_cloud_prob</span> <span class="o">+</span> <span class="n">high_cloud_prob</span> <span class="o">+</span> <span class="n">snow_ice</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">scl_data</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">max_cloud_perc</span>

<span class="k">def</span> <span class="nf">clean_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Clears up directories if download is re-run.&#39;&#39;&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Cleaning (removing) </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">calculate_evi2</span><span class="p">(</span><span class="n">nir_data</span><span class="p">,</span> <span class="n">red_data</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns the vegetation index EVI2 and corresponding raster profile.&#39;&#39;&#39;</span>
    <span class="n">QUANT_VAL</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="c1"># Calculate evi2</span>
    <span class="n">evi2</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">nir_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">red_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">nir_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.4</span><span class="o">*</span><span class="p">(</span><span class="n">red_data</span> <span class="o">/</span> <span class="n">QUANT_VAL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">profile</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">}}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">evi2</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">evi2_profile</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">get_reprojected_profile</span><span class="p">(</span><span class="n">src_profile</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculates necessary changes to an arbritary source profile (a dictionary</span>
<span class="sd">    based on a rasterio read) to write to a target CRS or target width, height.</span>
<span class="sd">    </span>
<span class="sd">    Note that the rasterio method to do this is not ideal; open issue here</span>
<span class="sd">    https://github.com/rasterio/rasterio/issues/3009&#39;&#39;&#39;</span>
    <span class="n">transformer</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">AffineTransformer</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">])</span> 
    <span class="n">left</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
    <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get default transform</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">calculate_default_transform</span><span class="p">(</span><span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span> 
                                                                            <span class="n">target_crs</span><span class="p">,</span> 
                                                                            <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> 
                                                                            <span class="n">src_profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> 
                                                                            <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span>
                                                                            <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span>
                                                                            <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
                                                                            <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span>
                                                                            <span class="n">dst_width</span><span class="o">=</span><span class="n">target_width</span><span class="p">,</span>
                                                                            <span class="n">dst_height</span><span class="o">=</span><span class="n">target_height</span><span class="p">,</span>
                                                                            <span class="n">dst_resolution</span><span class="o">=</span><span class="n">target_res</span><span class="p">)</span>

    <span class="c1"># Update profile with new crs, transform and dimensions</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">aligned_target</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">target_res</span><span class="p">)</span>
    <span class="n">new_profile</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src_profile</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">new_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">target_crs</span><span class="p">,</span>
                        <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
                        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">new_profile</span>
    
<span class="k">def</span> <span class="nf">trim_raster</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">,</span> <span class="n">geometry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Overwrites to_trim_path, trimming to (shapely) geometry defined in same CRS as raster.&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">masked_transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="n">geometry</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
        
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">masked_transform</span><span class="p">})</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">to_trim_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">reproject_clip_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">source_profile</span><span class="p">,</span> <span class="n">target_profile</span><span class="p">,</span> <span class="n">full_write_path</span><span class="p">,</span> <span class="n">aoi_geometry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reprojects S2 data to working CRS and writes to disk, clipping to AOI geometry.&#39;&#39;&#39;</span>
    <span class="n">target_profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">],</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">],</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]})</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">full_write_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">target_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">target_profile</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                    <span class="n">src_transform</span><span class="o">=</span><span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                    <span class="n">src_crs</span><span class="o">=</span><span class="n">source_profile</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span>
                                    <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">warp</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>

    <span class="n">trim_raster</span><span class="p">(</span><span class="n">full_write_path</span><span class="p">,</span> <span class="n">aoi_geometry</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_download_errors</span><span class="p">(</span><span class="n">_download_items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Decorator to skip over errors, printing details to display for investigation later&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">log_and_skip_errors</span><span class="p">(</span><span class="n">_dir_name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_download_items</span><span class="p">(</span><span class="n">_dir_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">_dir_name</span><span class="si">}</span><span class="s1"> :: ERROR (skipping) &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">log_and_skip_errors</span>

<span class="c1"># Some constants / global scope objects</span>
<span class="n">band_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">]</span> <span class="c1"># S2 bands to be downloaded</span>
<span class="n">MAX_ITEMS</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># Max items returned by the each STAC server request (this is in a 1 year period)</span>
<span class="n">max_cloud_perc</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Max allowable cloud / snow pixels</span>
<span class="n">client</span><span class="p">,</span> <span class="n">aws_session</span> <span class="o">=</span> <span class="n">get_pystack_aws_sessions</span><span class="p">()</span>

<span class="nd">@handle_download_errors</span>
<span class="k">def</span> <span class="nf">download_items</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Downloads  S2 data for a given NPMS location, with directory of structure: location_{NPMS sample ID}_{NPMS sample year}.&#39;&#39;&#39;</span>
    <span class="n">sample_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dir_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">sample_year</span> <span class="o">=</span> <span class="n">dir_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">data_path</span> <span class="o">=</span>  <span class="sa">f</span><span class="s1">&#39;../../../data/Agric_data/NPMS_Locations/</span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s1">/&#39;</span>    
    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample ID: </span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s1">, sample year: </span><span class="si">{</span><span class="n">sample_year</span><span class="si">}</span><span class="s1"> :: Starting processing&#39;</span><span class="p">)</span>

    <span class="c1"># Skip this location if it was already processed</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)):</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location: </span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s1"> :: Already processed, skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="c1"># Get search results</span>
    <span class="n">true_aoi_bbox</span> <span class="o">=</span> <span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_id</span><span class="p">][</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span> <span class="c1"># in projected coords</span>
    <span class="c1"># buffer this by a pixel so that there are no missing corners in the data download (this can happen because of reprojections and finite resolution imagery)</span>
    <span class="n">aoi_bbox</span> <span class="o">=</span> <span class="n">true_aoi_bbox</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">aoi_bbox_geodetic</span> <span class="o">=</span> <span class="n">get_geodetic_bbox</span><span class="p">(</span><span class="n">aoi_bbox</span><span class="p">,</span> <span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span> <span class="c1"># in EPSG:4326</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="n">search_stac</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="o">=</span><span class="n">aoi_bbox_geodetic</span><span class="p">,</span> <span class="n">datetime</span><span class="o">=</span><span class="n">sample_year</span><span class="p">,</span> 
                                 <span class="n">max_items</span><span class="o">=</span><span class="n">MAX_ITEMS</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;s2:processing_baseline&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;neq&quot;</span><span class="p">:</span> <span class="s2">&quot;05.00&quot;</span><span class="p">}})</span> <span class="c1"># Sentinel 2 reprocessing has not completed for 2019</span>

    <span class="c1"># Now iterate through dates with S2 acquisitions and download if they&#39;re good enough (intersect NPMS location fully and not too many clouds)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">search_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Store date reference</span>
        <span class="n">date_ref</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">base_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">date_ref</span><span class="p">)</span>
        <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample ID: </span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s1">, sample year: </span><span class="si">{</span><span class="n">sample_year</span><span class="si">}</span><span class="s1">, date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Starting acquisition processing&#39;</span><span class="p">)</span>
        
        <span class="c1"># If there is already a folder here and it contains the right number of files, consider this date to be processed and skip</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample ID: </span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s1">, sample year: </span><span class="si">{</span><span class="n">sample_year</span><span class="si">}</span><span class="s1">, date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Already have correct number of files, skipping&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Require full coverage of the AOI</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item_covers_aoi</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">):</span>
            <span class="k">continue</span>
            
        <span class="c1"># Next a cloud check</span>
        <span class="n">s2_thematic</span> <span class="o">=</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_clouds_snow</span><span class="p">(</span><span class="n">s2_thematic</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">max_cloud_perc</span><span class="o">=</span><span class="n">max_cloud_perc</span><span class="p">):</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample ID: </span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s1">, sample year: </span><span class="si">{</span><span class="n">sample_year</span><span class="si">}</span><span class="s1">, date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1"> :: Too cloudy/snowy, skipping (more than </span><span class="si">{</span><span class="n">max_cloud_perc</span><span class="si">}</span><span class="s1">% of image medium or high cloud probability or snow/ice)&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># At this point we&#39;ll download the imagery, so create write directory if it does not already exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clean_dir</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">)</span>
            
        <span class="c1"># Read data from S3 - already calculated scl so just add that to the dictionary instead of redownloading</span>
        <span class="n">band_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">band_name</span><span class="p">:</span> <span class="n">read_S3</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assets</span><span class="p">[</span><span class="n">band_name</span><span class="p">]</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="n">aoi_bbox_geodetic</span><span class="p">)</span> <span class="k">for</span> <span class="n">band_name</span> <span class="ow">in</span> <span class="n">band_names</span><span class="p">}</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;scl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2_thematic</span>
        <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;evi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_evi2</span><span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="c1"># Vegetation index</span>
                                           <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                           <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Define a target profile, which each raster will be aligned with</span>
        <span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">])</span>
        <span class="n">target_res</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">][</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">target_profile</span> <span class="o">=</span> <span class="n">get_reprojected_profile</span><span class="p">(</span><span class="n">band_data</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">][</span><span class="s1">&#39;profile&#39;</span><span class="p">],</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="n">target_width</span><span class="p">,</span> 
                                                 <span class="n">target_height</span><span class="o">=</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_res</span><span class="o">=</span><span class="n">target_res</span><span class="p">)</span>
        
        <span class="c1"># Write results, reprojecting everything into WORKING_CRS and trimming to the AOI bbox</span>
        <span class="k">for</span> <span class="n">band_name</span><span class="p">,</span> <span class="n">data_profile</span> <span class="ow">in</span> <span class="n">band_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_write_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_write_path</span><span class="p">,</span> <span class="n">band_name</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
            <span class="n">reproject_clip_write</span><span class="p">(</span><span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">],</span> <span class="n">target_profile</span><span class="p">,</span> <span class="n">full_write_path</span><span class="p">,</span> <span class="n">true_aoi_bbox</span><span class="p">)</span> <span class="c1"># clip to true aoi bbox</span>
            <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample ID: </span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s1">, sample year: </span><span class="si">{</span><span class="n">sample_year</span><span class="si">}</span><span class="s1">, date: </span><span class="si">{</span><span class="n">date_ref</span><span class="si">}</span><span class="s1">, band: </span><span class="si">{</span><span class="n">band_name</span><span class="si">}</span><span class="s1"> :: Written to </span><span class="si">{</span><span class="n">full_write_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="c1"># Now create a file to hold any metadata we may want to add and also signals completion of this location&#39;s download            </span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;touch&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)])</span>
    
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">aws_session</span><span class="p">):</span>
    <span class="n">dask_client</span> <span class="o">=</span> <span class="n">DaskClient</span><span class="p">(</span><span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">sc_aoi_dirs</span><span class="p">:</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">dask_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">download_items</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
    
    <span class="n">dask_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The resulting data set for one location, on one date looks like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Colormap as defined at https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/ndvi/</span>
<span class="n">edvi_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-1.0 $\leq$ EDVI $\leq$ -0.5&#39;</span><span class="p">,</span>
               <span class="s1">&#39;-0.5 &lt; EDVI $\leq$ 0.0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.0 &lt; EDVI $\leq$ 0.1&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.1 &lt; EDVI $\leq$ 0.2&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.2 &lt; EDVI $\leq$ 0.3&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.3 &lt; EDVI $\leq$ 0.4&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.4 &lt; EDVI $\leq$ 0.5&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.5 &lt; EDVI $\leq$ 0.6&#39;</span><span class="p">,</span>
               <span class="s1">&#39;0.6 &lt; EDVI $\leq$ 1.0&#39;</span>
              <span class="p">]</span>

<span class="n">edvi_ranges_nums</span> <span class="o">=</span>  <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                    <span class="mf">0.1</span><span class="p">,</span>
                                    <span class="mf">0.2</span><span class="p">,</span>
                                    <span class="mf">0.3</span><span class="p">,</span>
                                    <span class="mf">0.4</span><span class="p">,</span>
                                    <span class="mf">0.5</span><span class="p">,</span>
                                    <span class="mf">0.6</span><span class="p">,</span>
                                    <span class="mf">1.0</span><span class="p">]</span>
<span class="n">edvi_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">234</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">234</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">204</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">130</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">145</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">81</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">112</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">63</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">79</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">45</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">28</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]]</span>


<span class="c1"># Color mapping for the scene classification</span>
<span class="c1"># Color map as described at https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/scene-classification/</span>

<span class="n">classification_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Dark features/Shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud shadows&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Vegetation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Not-vegetated&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Water (dark and bright)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Unclassified&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud medium probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cloud high probability&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Thin cirrus&#39;</span><span class="p">]</span>

<span class="n">classification_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">90</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">]]]</span>

<span class="n">scl_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;SCL map&#39;</span><span class="p">,</span> <span class="n">classification_colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">))</span>
<span class="n">scl_thematic_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classification_colors</span><span class="p">,</span> 
                                                                                        <span class="n">classification_names</span><span class="p">)]</span>
<span class="n">scl_norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">([</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">)],</span> <span class="n">scl_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>



<span class="n">edvi_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;EDVI map&#39;</span><span class="p">,</span> <span class="n">edvi_colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edvi_colors</span><span class="p">))</span>
<span class="n">edvi_thematic_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edvi_colors</span><span class="p">,</span> <span class="n">edvi_ranges</span><span class="p">)]</span>
<span class="n">edvi_norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">edvi_ranges_nums</span><span class="p">,</span> <span class="n">edvi_cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">views</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2&#39;</span><span class="p">,</span> <span class="s1">&#39;scl&#39;</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sentinel-2 RGB and study zone (with bbox)&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-2 Red&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-2 NIR&#39;</span><span class="p">,</span> <span class="s1">&#39;Computed EVI2&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-2 SCL&#39;</span><span class="p">]</span>
<span class="n">norms</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">PowerNorm</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">edvi_norm</span><span class="p">,</span> <span class="n">scl_norm</span><span class="p">]</span>
<span class="n">cmaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">edvi_cmap</span><span class="p">,</span> <span class="n">scl_cmap</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">views</span><span class="p">):</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">view</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aoi_date_download_path</span><span class="p">,</span> <span class="n">view</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">data_profile</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">}</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">view</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">]:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10000</span> <span class="c1"># Quantification value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">data_profile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
                   <span class="n">norm</span><span class="o">=</span><span class="n">norms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="c1"># Just for image / display resolution mismatches, does not alter underlying values</span>
                   <span class="n">extent</span><span class="o">=</span><span class="n">extent</span>
                  <span class="p">)</span>

    <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span>
        <span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">location_code</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NPMS study area centroid&#39;</span><span class="p">)</span>
        <span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">location_code</span><span class="p">]][</span><span class="s1">&#39;study_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;study zone&#39;</span><span class="p">,</span> 
                                                               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">location_code</span><span class="p">]]</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">)[</span><span class="s1">&#39;study_zone_bbox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;study zone bbox&#39;</span><span class="p">,</span> 
                                                               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;scl&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scl_thematic_map</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s1">&#39;evi2&#39;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">edvi_thematic_map</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        

<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sentinel-2 and EVI2 rasters for NPMS location </span><span class="si">{}</span><span class="s1"> on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location_code</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/508a7b4885d9a82eaeac41016c95412844247052206294c896bfa44e7405787a.png" src="../_images/508a7b4885d9a82eaeac41016c95412844247052206294c896bfa44e7405787a.png" />
</div>
</div>
</section>
<section id="productivity-and-phenology-parameters-calculations">
<h3>Productivity and phenology parameters calculations<a class="headerlink" href="#productivity-and-phenology-parameters-calculations" title="Permalink to this heading">#</a></h3>
<p>The methodology presented in this subsection is the same as that applied in the last article.</p>
<p>Before executing a productivity and phenology analysis based on Sentinel-2 imagery, a mask to remove “bad” pixels is defined.</p>
<p>In this section, the process is demonstrated for one example location, before looping through all NPMS localities and years.</p>
<p>Note that in place of the more frequently used NDVI index, the authors of [1] use the EVI2 index as a vegetation index, citing deficiencies with NDVI in relation to this use case.</p>
<div class="math notranslate nohighlight">
\[
  EVI2 = 2.5*\frac{NIR - RED}{NIR + 2.4*RED + 1}
\]</div>
<section id="example-for-one-location-and-date">
<h4>Example for one location and date<a class="headerlink" href="#example-for-one-location-and-date" title="Permalink to this heading">#</a></h4>
<p>Define a mask to select only the study area from a raster:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rasterize_geoms</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rasterizes geometries (geoms) according to a raster spec (profile).&#39;&#39;&#39;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> 
                                        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])),</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">transform</span><span class="o">=</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span>
                                        <span class="n">default_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="k">def</span> <span class="nf">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask for the study area for a given location&#39;&#39;&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Refer to arable_samples_loc_yr_unique as a global, which is the source of AOI specific metadata here</span>
    <span class="n">study_zone_geom</span> <span class="o">=</span> <span class="n">arable_samples_loc_yr_unique</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;study_zone&#39;</span><span class="p">]</span>

    <span class="c1"># Use the EVI2 profile for rasterize op</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">evi2_path</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span>

    <span class="k">return</span> <span class="n">rasterize_geoms</span><span class="p">([</span><span class="n">study_zone_geom</span><span class="p">],</span> <span class="n">evi2_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Define a mask to remove bad pixels (according to Sentinel-2 scene classification):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out &quot;bad&quot; pixels according to the S2 scene classification.&#39;&#39;&#39;</span>
    <span class="n">scl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>
    <span class="n">scl_raw</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scl_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scl_good_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scl_raw</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># No data</span>
                                       <span class="mi">1</span><span class="p">,</span> <span class="c1"># Saturated/defective pixel</span>
                                       <span class="mi">6</span><span class="p">,</span> <span class="c1"># Water</span>
                                       <span class="mi">9</span><span class="p">,</span> <span class="c1"># Cloud high prob</span>
                                       <span class="mi">11</span><span class="p">])</span> <span class="c1"># Snow or ice</span>

    <span class="k">return</span> <span class="n">scl_good_mask</span>
</pre></div>
</div>
</div>
</div>
<p>Define a mask to identify pixels that are never vegetated according to the Sentinel-2 scene classification map:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a mask that filters out pixels not labelled as vegetation according to S2 SCL for the entire period.&#39;&#39;&#39;</span>  
    <span class="k">def</span> <span class="nf">not_vegetated_mask</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span>

    <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;scl.tif&#39;</span><span class="p">)</span>
    <span class="n">scl_never_veg</span> <span class="o">=</span> <span class="o">~</span><span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="p">[</span><span class="n">not_vegetated_mask</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">base_path</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">scl_never_veg</span>
</pre></div>
</div>
</div>
</div>
<p>Now get masks based on CROME crop designation. The method was originally applied to spring cereals [1], so return a spring cereal mask.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_crome_geoms</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads CROME data and converts to geometries on selected land-use codes.&#39;&#39;&#39;</span>
    <span class="n">crome_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crome_path</span><span class="p">)</span>
    <span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spring_cereal_geoms</span>


<span class="k">def</span> <span class="nf">get_farmed_area</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads CROME data and calculates the land area used for spring cereal culitvation and also (all types of) agriculture for this tile.&#39;&#39;&#39;</span>
    <span class="n">crome_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;CROME&#39;</span><span class="p">)</span>
    <span class="n">crome_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">crome_path</span><span class="p">)</span>
    <span class="n">spring_cereal_area</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SPRING_CEREAL_LUCODES</span><span class="p">)]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">agric_area</span> <span class="o">=</span> <span class="n">crome_data</span><span class="p">[</span><span class="n">crome_data</span><span class="p">[</span><span class="s1">&#39;lucode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;LG&#39;</span><span class="p">,</span> <span class="s1">&#39;NU&#39;</span><span class="p">,</span> <span class="s1">&#39;TC&#39;</span><span class="p">,</span> <span class="s1">&#39;SR&#39;</span><span class="p">))]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">WORKING_CRS</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spring_cereal_area</span><span class="p">,</span> <span class="n">agric_area</span>

<span class="k">def</span> <span class="nf">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Gets cereal land-use masks based on CROME data.&#39;&#39;&#39;</span>
    <span class="c1"># For this location get CROME data (constant on a year)</span>
    <span class="n">spring_cereal_geoms</span> <span class="o">=</span> <span class="n">get_crome_geoms</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>
    
    <span class="c1"># Convert shapes to rasters based on raster profile of an evi2.tif for this location (should all have the same profile)</span>
    <span class="n">evi2_path</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evi2_profile</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">evi2_path</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span>
    
    <span class="c1"># Generate spring cereal mask</span>
    <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">rasterize_geoms</span><span class="p">(</span><span class="n">spring_cereal_geoms</span><span class="p">,</span> <span class="n">evi2_profile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cereal_mask</span>
</pre></div>
</div>
</div>
</div>
<p>Apply masks to demo datapoint (single date in the timeseries) to show masking effect. Note that the composite mask is an intersection between the spring cereal mask, the study area mask and the Sentinel-2 scene classification mask (not never vegetated).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Include the AOI mask and never_veg in the cereal mask for compactness</span>
<span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>

<span class="c1"># Define relevant Xarray variables</span>
<span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">)))</span>
<span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
<span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                 <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                  <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Used chained where condition</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Composite mask&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EVI2&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                               <span class="n">evi2_xr</span><span class="p">,</span> 
                               <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
             <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Masked EVI2&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;EVI2 masking for NPMS location </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">date</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/b1be83295e6f56bf78dda3a822c9abd5b4a6f1dbee86629b8aa708b637890ce6.png" src="../_images/b1be83295e6f56bf78dda3a822c9abd5b4a6f1dbee86629b8aa708b637890ce6.png" />
</div>
</div>
</section>
<section id="time-series-analysis-for-s2-based-phenology-and-productivity-parameters">
<h4>Time-series analysis for S2-based phenology and productivity parameters<a class="headerlink" href="#time-series-analysis-for-s2-based-phenology-and-productivity-parameters" title="Permalink to this heading">#</a></h4>
<p>It is now possible to calculate phenology and productivity parameters, based on the timeseries of masked vegetation indices.</p>
<p>The following shows the approach for a single NPMS location, using Python distributions of Xarray, and PhenoloPy. The analysis process shown here follows a PhenoloPy tutorial for a similar use case [5].</p>
<p>Note that several minor fixes to my local PhenoloPy functions were necessary for usage with the newer Xarray and NumPy releases used in this environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mask the EVI2 dataset</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                                  <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                           <span class="n">evi2_xr</span><span class="p">,</span> 
                                           <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                          <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Just do a bit of xarray preparation</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>

<span class="c1"># Redefine as a dataset</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Now for the productivity/phenology calculation routine:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Group dataset interval: month via reducer: median
&gt; Selecting year: 2018 to re-label times after groupby.
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Group successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Outlier removal method: median with a user factor of: 2
&gt; Generated roll window size less than 3, setting to default (3).
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Outlier removal successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set resample interval now, as a few functions require it</span>
<span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correcting last datetime value to ensure adequate resampling output.
&gt; Changing day of last datetime value in dataset to the 31st.
&gt; Corrected late datetime value successfully.
Resampling dataset interval: 2W via reducer: median
&gt; Warning: dataset contains nan values. You should interpolate nan values next.
&gt; Resample successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
<span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Interpolating dataset using method: interpolate_na.
&gt; Warning: dataset still contains nan values. The first and/or last time slices may be empty.
&gt; Interpolation successful.

Checking and removing non-dominant year often introduced following resampling.
&gt; More than one year detected in dataset. Removal non-dominant years.
&gt; Checked and removed non-dominant year (if needed) successfully.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Smoothing method: savitsky with window length: 3 and polyorder: 1.
&gt; Warning: dataset contains nan values. You may want to interpolate next.
&gt; Smoothing successful.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initialising calculation of phenometrics.

Beginning extraction of CRS metadata.
&gt; Extracting CRS metadata.
&gt; No CRS metadata found. Returning None.

Beginning calculation of phenometrics. This can take awhile - please wait.

Beginning calculation of peak of season (pos) values and times.
&gt; Calculating peak of season (pos) values.
&gt; Calculating peak of season (pos) times.
&gt; Success!

Beginning calculation of fifth percentile veg index (bse_fifth_per) values.
&gt; Calculating fifth percentile veg index (bse_fifth_per) values.
&gt; Success!

Beginning calculation of amplitude of season (aos) values (times not possible).
&gt; Calculating amplitude of season (aos) values.
&gt; Success!

Beginning addition of CRS metadata.
&gt; Adding CRS metadata.
&gt; Could not add CRS metadata to data. Aborting.

Phenometrics calculated successfully!
</pre></div>
</div>
</div>
</div>
<p>Amplitude (aos) of the vegetation index id defined as the peak value (max observed in the season) minus the base value (fifth percentile of veg index) and was found to have the strongest correlation with farmer reported yields, alongside peak EVI2 ###CITE.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Pixelwise amplitude of season on spring cereals </span><span class="se">\n</span><span class="s2"> for NPMS location </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">date</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d43d70a42d28ef9dbe4e9e872b53688730388fdbcb7f634d27c1679c2a8565c2.png" src="../_images/d43d70a42d28ef9dbe4e9e872b53688730388fdbcb7f634d27c1679c2a8565c2.png" />
</div>
</div>
<p>The EVI2 timeseries and amplitude distributions for pixels labelled spring cereal according to CROME are presented below.</p>
<p>Similarly to the results shown in the last article, the pixel-wise EVI2 time series for this location clearly shows that despite a bimodal amplitude distribution, the majority of pixels exhibit a similar peak in the early summer period.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
<span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
<span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

<span class="c1"># Create 2x2 sub plots</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mf">.15</span><span class="p">,</span> <span class="mf">.85</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> 
<span class="k">for</span> <span class="n">pixel_ref</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">veg_index_timeseries</span><span class="p">[:,</span> <span class="n">pixel_ref</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sample of EVI2 pixel-wise time-series&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;EVI2 value&#39;</span><span class="p">)</span>

<span class="n">_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># row 0, col 1</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">_ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EVI2 amplitude distribution on spring cereal pixels&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">_ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aos_vals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;EVI2 amplitude&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;NPMS location </span><span class="si">{}</span><span class="s2"> crop phenology and productivity&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d65dbbff1e71bc9ee98cf8592a8e707b266f59ec1d1a6a24a9adc8ba99b6c27d.png" src="../_images/d65dbbff1e71bc9ee98cf8592a8e707b266f59ec1d1a6a24a9adc8ba99b6c27d.png" />
</div>
</div>
<p>The above method is now applied to the remaining NPMS locations and dates, and the median AOS across all spring cereal pixels is recorded for each.</p>
<p>Expand the cell below for the implementation.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_aos</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns the median evi2 amplitude on spring cereal fields in AOI&#39;&#39;&#39;</span>
    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beginning processing for </span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Get static mask (independent of time)</span>
    <span class="n">cereal_mask</span> <span class="o">=</span> <span class="n">get_cereal_masks</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_study_area_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_scl_never_veg_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">)</span>

    <span class="c1"># Define relevant Xarray variables</span>
    <span class="n">evi2_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2.tif&#39;</span><span class="p">)))</span>
    <span class="n">dates_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">evi2_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">evi2_paths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">dates_xr</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="c1"># Create masks (date-specific) based on SCL good pixels</span>
    <span class="n">good_scl_masks_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">get_scl_good_mask</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates_xr</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]),</span>
                                     <span class="n">coords</span><span class="o">=</span><span class="n">evi2_xr</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                      <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>

    <span class="c1"># Mask the EVI2 dataset</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cereal_mask</span><span class="p">,</span> 
                                      <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_scl_masks_xr</span><span class="p">,</span> 
                                               <span class="n">evi2_xr</span><span class="p">,</span> 
                                               <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> 
                              <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Now for the phenology and productivity calculations</span>
    <span class="c1"># as in the example above</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;spatial_ref&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">WORKING_CRS</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]))})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;veg_index&#39;</span><span class="p">:</span> <span class="n">evi2_cereal_xr</span><span class="p">})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">WORKING_CRS</span><span class="p">,</span> <span class="s1">&#39;grid_mapping&#39;</span><span class="p">:</span> <span class="s1">&#39;spatial_ref&#39;</span><span class="p">})</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">user_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_pval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;2W&#39;</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">correct_last_datetime</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">reducer</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interpolate_na&#39;</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">remove_non_dominant_year</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">)</span>
    <span class="n">evi2_cereal_xr</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">evi2_cereal_xr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;savitsky&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">phenolopy</span><span class="o">.</span><span class="n">calc_phenometrics</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="p">[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">],</span> 
                                     <span class="n">peak_metric</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> 
                                     <span class="n">base_metric</span><span class="o">=</span><span class="s1">&#39;bse_fifth_per&#39;</span><span class="p">,</span> 
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;first_of_slope&#39;</span><span class="p">,</span> 
                                     <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                     <span class="n">thresh_sides</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">,</span> 
                                     <span class="n">abs_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">non_null_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># All nan slices</span>
    <span class="n">veg_index_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)[</span><span class="s1">&#39;veg_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evi2_cereal_xr</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
    <span class="n">aos_vals</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phen_metric</span><span class="o">=</span><span class="s1">&#39;aos_values&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">non_null_mask</span><span class="p">]</span>

    <span class="n">distributed_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done processing </span><span class="si">{</span><span class="n">aoi_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aoi_dir</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">aos_vals</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aoi_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="ow">and</span> <span class="s1">&#39;metadata.csv&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">aoi_dir</span> <span class="ow">in</span> <span class="n">aoi_dirs</span><span class="p">:</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_aos</span><span class="p">(</span><span class="n">aoi_dir</span><span class="p">))</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;median_aos&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;aos_results.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="biodiversity-data-post-processing">
<h3>Biodiversity data post-processing<a class="headerlink" href="#biodiversity-data-post-processing" title="Permalink to this heading">#</a></h3>
<p>For each of the selected locations and years, the biodiversity metrics used by the authors of [1] for analysis of vascular plant data are calculated.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;aos_results.csv&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[[</span><span class="s1">&#39;survey_id&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>median_aos</th>
      <th>sample_id</th>
      <th>survey_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.302184</td>
      <td>6276882</td>
      <td>155</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.320410</td>
      <td>8148381</td>
      <td>155</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.265604</td>
      <td>10530878</td>
      <td>87</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.420162</td>
      <td>3536063</td>
      <td>155</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.690783</td>
      <td>14727289</td>
      <td>87</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="cover-calculations">
<h4>Cover calculations<a class="headerlink" href="#cover-calculations" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">occurrences</span><span class="p">,</span> 
                         <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> 
                         <span class="n">on</span><span class="o">=</span><span class="s1">&#39;sample_id&#39;</span><span class="p">)</span>

<span class="c1"># Domin scale Range (%) Mid-range value (%)</span>
<span class="c1"># Based on https://www.researchgate.net/publication/273759339_Irish_semi-natural_grasslands_survey_2007-2012/citation/download</span>

<span class="n">domin_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;10&#39;</span>    <span class="p">:</span> <span class="mi">96</span><span class="p">,</span>
             <span class="s1">&#39;9&#39;</span>     <span class="p">:</span> <span class="mi">83</span><span class="p">,</span>
             <span class="s1">&#39;8&#39;</span>     <span class="p">:</span> <span class="mi">63</span><span class="p">,</span>
             <span class="s1">&#39;7&#39;</span>     <span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
             <span class="s1">&#39;6&#39;</span>     <span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
             <span class="s1">&#39;5&#39;</span>     <span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
             <span class="s1">&#39;4&#39;</span>     <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
             <span class="s1">&#39;3&#39;</span>     <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
             <span class="s1">&#39;2&#39;</span>     <span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
             <span class="s1">&#39;1&#39;</span>     <span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
             <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>

<span class="n">results</span><span class="p">[</span><span class="s1">&#39;perc_cover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;domin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">domin_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">cover_totals</span>  <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sample_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;perc_cover&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;perc_cover&#39;</span><span class="p">:</span> <span class="s1">&#39;cover_total&#39;</span><span class="p">})</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cover_totals</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s1">&#39;rel_cover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;perc_cover&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cover_total&#39;</span><span class="p">]</span>
<span class="n">results</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>median_aos</th>
      <th>sample_id</th>
      <th>survey_id</th>
      <th>taxonversionkey</th>
      <th>preferred_taxon</th>
      <th>domin</th>
      <th>perc_cover</th>
      <th>cover_total</th>
      <th>rel_cover</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.302184</td>
      <td>6276882</td>
      <td>155</td>
      <td>NBNSYS0000004492</td>
      <td>Cirsium arvense</td>
      <td>2. &lt; 1% (several indivs)</td>
      <td>0.005</td>
      <td>0.048</td>
      <td>0.104167</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.302184</td>
      <td>6276882</td>
      <td>155</td>
      <td>NBNSYS0000004319</td>
      <td>Galium aparine</td>
      <td>2. &lt; 1% (several indivs)</td>
      <td>0.005</td>
      <td>0.048</td>
      <td>0.104167</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.302184</td>
      <td>6276882</td>
      <td>155</td>
      <td>NBNSYS0000003222</td>
      <td>Medicago lupulina</td>
      <td>3. 1-4%</td>
      <td>0.030</td>
      <td>0.048</td>
      <td>0.625000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.302184</td>
      <td>6276882</td>
      <td>155</td>
      <td>NBNSYS0000003807</td>
      <td>Urtica dioica</td>
      <td>2. &lt; 1% (several indivs)</td>
      <td>0.005</td>
      <td>0.048</td>
      <td>0.104167</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.302184</td>
      <td>6276882</td>
      <td>155</td>
      <td>NBNSYS0000004542</td>
      <td>Sonchus arvensis</td>
      <td>1. &lt; 1% (1-2 indivs)</td>
      <td>0.003</td>
      <td>0.048</td>
      <td>0.062500</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="abundance">
<h4>Abundance<a class="headerlink" href="#abundance" title="Permalink to this heading">#</a></h4>
<p>Abundance is not calculated here for two reasons:</p>
<ul class="simple">
<li><p>the authors of [1] use total flower cover as an abundance measure, which isn’t available in the NPMS data;</p></li>
<li><p>they also do not present correlation analysis for abundance figures on vascular plants, instead focusing on diversity measures.</p></li>
</ul>
</section>
</section>
<section id="species-richness">
<h3>Species richness<a class="headerlink" href="#species-richness" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">species_richness</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;survey_id&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="s1">&#39;median_aos&#39;</span><span class="p">])[[</span><span class="s1">&#39;preferred_taxon&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;preferred_taxon&#39;</span><span class="p">:</span> <span class="s1">&#39;species_richness&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="shannon-diversity">
<h3>Shannon diversity<a class="headerlink" href="#shannon-diversity" title="Permalink to this heading">#</a></h3>
<p>Use relative cover computed per sample to estimate shannon diversity [1].</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">shannon</span><span class="p">(</span><span class="n">sample_rel_covers</span><span class="p">):</span>
    <span class="n">shannon</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sample_rel_covers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sample_rel_covers</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">shannon</span>

<span class="n">shannon_diversity</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;survey_id&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="s1">&#39;median_aos&#39;</span><span class="p">])[[</span><span class="s1">&#39;rel_cover&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">shannon</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rel_cover&#39;</span><span class="p">:</span> <span class="s1">&#39;shannon_diversity&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this heading">#</a></h2>
<p>Comparing the Sentinel-2 derived median AOS figures against modelled biodiversity metrics, separated by survey level (see note below), a significant negative correlation is not observed for either species richness or shannon diversity. On the contrary, positive correlations are observed in general here though none are significant at the 5% level.</p>
<p>This contrasts with the findings of [1], in which significant negative correlations were reported for biodiversity metrics (and farmer reported yields, not analysed here), and is discussed in the following section.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">cs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]</span>
<span class="n">survey_levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Wildflower survey&#39;</span><span class="p">,</span> <span class="s1">&#39;Inventory survey&#39;</span><span class="p">,</span> <span class="s1">&#39;Indicator survey&#39;</span><span class="p">]</span>
<span class="n">legend_handles</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">survey_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">87</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">155</span><span class="p">]):</span>
    <span class="n">_species_richness</span> <span class="o">=</span> <span class="n">species_richness</span><span class="p">[</span><span class="n">species_richness</span><span class="p">[</span><span class="s1">&#39;survey_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">survey_id</span><span class="p">]</span>
    <span class="n">_shannon_diversity</span> <span class="o">=</span> <span class="n">shannon_diversity</span><span class="p">[</span><span class="n">shannon_diversity</span><span class="p">[</span><span class="s1">&#39;survey_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">survey_id</span><span class="p">]</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;species_richness&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_species_richness</span><span class="p">,</span> <span class="n">fit_reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.95</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;PearsonR:: stat: </span><span class="si">{}</span><span class="s1">, pval: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">_species_richness</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">_species_richness</span><span class="p">[</span><span class="s1">&#39;species_richness&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                                                  <span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">_species_richness</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">_species_richness</span><span class="p">[</span><span class="s1">&#39;species_richness&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
               <span class="n">transform</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;median_aos&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;shannon_diversity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_shannon_diversity</span><span class="p">,</span> <span class="n">fit_reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.95</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;PearsonR:: stat: </span><span class="si">{}</span><span class="s1">, pval: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">_shannon_diversity</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">_shannon_diversity</span><span class="p">[</span><span class="s1">&#39;shannon_diversity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                                                  <span class="nb">round</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">_shannon_diversity</span><span class="p">[</span><span class="s1">&#39;median_aos&#39;</span><span class="p">],</span> <span class="n">_shannon_diversity</span><span class="p">[</span><span class="s1">&#39;shannon_diversity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
               <span class="n">transform</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>


    <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">survey_levels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Scatter plots of biodiversity variables and median EVI2 amplitude figures&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1697717fc2e98bf07eff23aef419f039d3c575a523e723ae2d6ae73aea4e80f5.png" src="../_images/1697717fc2e98bf07eff23aef419f039d3c575a523e723ae2d6ae73aea4e80f5.png" />
</div>
</div>
<p>Results are split by survey levels, which call for volunteers to survey different sets of plants:</p>
<ul class="simple">
<li><p>“Wildflower Level: surveying at this level involves recording fewer
species. All the species you record are a subset of the species at
Indicator Level.</p></li>
<li><p>Indicator Level: as for the Wildflower Level but using all the species
chosen to indicate different aspects of their habitats. This level gives us
very robust data so where possible we would encourage you to aim to
participate at this level.</p></li>
<li><p>Inventory Level: carrying out the survey at Indicator Level but in
addition recording all other species of vascular plant present within
each plot.”</p></li>
</ul>
<p>From <a class="reference external" href="https://www.npms.org.uk/sites/default/files/PDF/NPMS%20Guidance%20Notes_WEB.pdf">https://www.npms.org.uk/sites/default/files/PDF/NPMS Guidance Notes_WEB.pdf</a>.</p>
</section>
<section id="discussion-and-conclusions">
<h2>Discussion and conclusions<a class="headerlink" href="#discussion-and-conclusions" title="Permalink to this heading">#</a></h2>
<p>This notebook aimed primarily to reproduce a methodology to assess biodiversity metrics based on remote sensing-derived agricultural productivity parameters. Whilst from a practical standpoint, the methodology was reproduced and adapted to NPMS data, the correlations reported by the authors of [1] were not observed here. That study suggested that agricultural intensity on spring cereal fields reduces vascular plant biodiversity on those fields, and that this can be proxied by remote sensing-derived parameters.</p>
<p>The lack of agreement shown here using NPMS data represents a similar conclusion to that of the last article, in which the large study area (chosen for practical reasons) likely introduced sufficient noise to show biodiversity and productivity measures to be uncorrelated. Here however, a much smaller study area is used on each NPMS location whilst retaining spring cereal cropping activity within those areas, by means of the larger pool of sampling locations in the NPMS dataset. Nonetheless, there remains a very weak correlation between NPMS data and Sentinel-2 parameters.</p>
<p>Considering the differences between the original and adapted methods remain (which are sufficient to invalidate the conclusion that [1] is simply not repeatable):</p>
<ul class="simple">
<li><p><strong>Study zone definition</strong>: the original study measured biodiversity metrics <em>inside</em> the spring cereal field, whereas NPMS surveys are carried out on field margins.</p></li>
<li><p><strong>Biodiversity data quality</strong>: the authors of [1] gather biodiversity in a structured and repeatable manner, whereas NPMS data is collected by many volunteers, introducing a degree of subjectivity and variability often associated with citizen science programs.</p></li>
<li><p><strong>Study region</strong>: the original study focused on agricultural land in a relatively small region of southern Sweden, compared to a much larger national scale NPMS study region.</p></li>
</ul>
<p>To further elaborate on the applicability of the method across different study regions, it is likely that vascular plant ecology remains similar within the part of southern Sweden surveyed in [1], whereas on the scale of England there are significant and systematic differences in land cover, climatic zones, and soils (etc.) that may influence plant diversity. A model which incorporates consideration of these factors could be of relevance here, potentially by stratifying sites according to a spatial distribution of relevant variables before examining correlation coefficients. Further work would be required to validate the premise of this suggestion.</p>
<p>On the definition of the study zone at each biodiversity sampling location, it should be said that NPMS linear plots are advised to extend one metre into the cropped field; however that is only the first metre of a 25m x 1m linear survey. Therefore the field margin accounts for the majority of the NPMS sampling area. Similarly, though there is a significant presence of spring cereal cropping in the 100m vicinity of the chosen NPMS locations, the margin may in fact belong to adjacent field and could possibly be separated by a border, ditch or hedge. This represents the most significant difference between the original and adapted methodologies.</p>
<p>That observation, together with the results of the last notebook on PoMS data, would suggest that the correlation observed between <strong>in-field</strong> biodiversity metrics and remote sensing parameters (on the same fields) does not extend to biodiversity metrics surveyed in the vicinity of the fields for which remote sensing parameters are calculated.</p>
<p>However, given the potential issues around data quality and study region definition, that conclusion should be validated by a systematic study on biodiversity in the vicinity of agricultural areas with varying levels of intensity, ideally incorporating cropping beyond just spring cereals.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Abdi AM, Carrié R, Sidemo-Holm W, Cai Z, Boke-Olén N, Smith HG, Eklundh L, Ekroos J, Biodiversity Decline With Increasing Crop Productivity in Agricultural Fields Revealed by Satellite Remote Sensing. Ecological Indicators. 2021; 130():108098. <a class="reference external" href="https://doi.org/10.1016/j.ecolind.2021.108098">https://doi.org/10.1016/j.ecolind.2021.108098</a>.</p></li>
<li><p>Pescott OL, Walker KJ, Pocock MJO, Jitlal M, Outhwaite CL, Cheffings CM, Harris F, Roy DB. Ecological Monitoring With Citizen Science: The Design and Implementation of Schemes for Recording Plants in Britain and Ireland. Biological Journal of the Linnean Society. 2015; 115(3): 505–521. <a class="reference external" href="https://doi.org/10.1111/bij.12581">https://doi.org/10.1111/bij.12581</a>.</p></li>
<li><p>National Plant Monitoring Scheme (2023). National Plant Monitoring Scheme survey data (2015-2022) NERC EDS Environmental Information Data Centre. <a class="reference external" href="https://doi.org/10.5285/f7ef2dc5-2bce-4436-8f65-90f7a99acff2">https://doi.org/10.5285/f7ef2dc5-2bce-4436-8f65-90f7a99acff2</a>.</p></li>
<li><p>UK Rural Payments Agency (RPA). Crop Map of England (CROME), 2018 - 2020. Licence: <a class="reference external" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/</a>.</p></li>
<li><p>Trotter L. PhenoloPy Tutorial. <a class="github reference external" href="https://github.com/lewistrotter/PhenoloPy/blob/main/Phenolopy.ipynb">lewistrotter/PhenoloPy</a>.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Measuring%20Biodiversity%20on%20Agricultural%20Land%20with%20Remote%20Sensing%20Data%20%28Part%20I%29.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Measuring Biodiversity on Agricultural Land with Remote Sensing Data (Part I)</p>
      </div>
    </a>
    <a class="right-next"
       href="Assessing%20Spatial%20Patterns%20of%20Agricultural%20Pesticide%20Use%20and%20Risks%20to%20Pollinator%20Populations.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Assessing Spatial Patterns of Agricultural Pesticide Use and Risks to Pollinator Populations</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-datapoint-used-for-demo-graphs-and-maps">Set datapoint used for demo graphs and maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data-uk-national-plant-monitoring-scheme">Biodiversity data: UK National Plant Monitoring Scheme</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agricultural-land-use-data-crome">Agricultural land use data: CROME</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-sentinel-2-imagery">Download Sentinel-2 imagery</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#productivity-and-phenology-parameters-calculations">Productivity and phenology parameters calculations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-for-one-location-and-date">Example for one location and date</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-analysis-for-s2-based-phenology-and-productivity-parameters">Time-series analysis for S2-based phenology and productivity parameters</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biodiversity-data-post-processing">Biodiversity data post-processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cover-calculations">Cover calculations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#abundance">Abundance</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#species-richness">Species richness</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shannon-diversity">Shannon diversity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-and-conclusions">Discussion and conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tom Whitehouse
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>